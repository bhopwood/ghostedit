/*! GhostEdit WYSIWYG editor Copyright (c) 2010-2013 Nico Burns

Description:       An open source JavaScript WYSIWYG editor focused on usability
Homepage:          http://ghosted.it
License:           LGPL
Author:            Nico Burns <nico@nicoburns.com>
Version:           1.0.0-pre
Release Date:      2013-03-05
Browser Support:   Internet Explorer 6+, Mozilla Firefox 3.6+, Google Chrome, Apple Safari (latest), Opera (latest)
*/window.lasso=function(){var e={saved:null,endpoint:null,startpoint:null,bookmark:null,textrange:!1,domrange:!1,isLassoObject:!0},t=window.lasso,n=window.console||{};return n.log=n.log||function(){},e.init=e.reset=e.create=function(){return document.createRange?(e.textrange=!1,e.saved=document.createRange()):document.selection&&(e.textrange=!0,e.saved=document.body.createTextRange()),e.bookmark=!1,e.domrange=!e.textrange,e},e.setToEmpty=function(){return e.domrange?e.saved=document.createRange():e.textrange&&(e.saved=document.body.createTextRange()),e},e.setFromNative=function(t){return e.saved=t,e},e.getNative=function(){return e.saved},e.setToSelection=function(){var t;return e.domrange?(t=window.getSelection(),t.rangeCount>0&&(e.saved=t.getRangeAt(0).cloneRange())):e.textrange&&(e.saved=document.selection.createRange()),e},e.select=function(){if(e.domrange){var t=window.getSelection();t.rangeCount>0&&t.removeAllRanges(),t.addRange(e.saved)}else e.textrange&&e.saved.select();return e},e.clearSelection=function(){if(e.domrange){var t=window.getSelection();t.rangeCount>0&&t.removeAllRanges()}else e.textrange&&document.selection.empty();return e},e.collapseToStart=function(){return e.saved.collapse(!0),e},e.collapseToEnd=function(){return e.saved.collapse(!1),e},e.setStartToRangeStart=function(t){return t&&t.saved&&(t=t.getNative()),e.domrange?e.saved.setStart(t.startContainer,t.startOffset):e.textrange&&e.saved.setEndPoint("StartToStart",t),e},e.setStartToRangeEnd=function(t){return t&&t.saved&&(t=t.getNative()),e.domrange?e.saved.setStart(t.endContainer,t.endOffset):e.textrange&&e.saved.setEndPoint("StartToEnd",t),e},e.setEndToRangeStart=function(t){return t&&t.saved&&(t=t.getNative()),e.domrange?e.saved.setStart(t.endContainer,t.endOffset):e.textrange&&e.saved.setEndPoint("EndToStart",t),e},e.setEndToRangeEnd=function(t){return t&&t.saved&&(t=t.getNative()),e.domrange?e.saved.setEnd(t.endContainer,t.endOffset):e.textrange&&e.saved.setEndPoint("EndToEnd",t),e},e.deleteContents=function(){return e.domrange?e.saved.deleteContents():e.textrange&&(e.saved.text=""),e},e.pasteText=function(t,n){if(n===void 0&&(n=!0),e.deleteContents(),e.domrange){var o=document.createTextNode(t);e.saved.insertNode(o),e.reset().selectNodeContents(o)}else e.textrange&&e.saved.pasteHTML(t);return n&&e.collapseToEnd(),e.select(),e},e.insertNode=function(t,n){var o;return n===void 0&&(n=!0),e.deleteContents(),e.domrange?(e.saved.insertNode(t),e.setToEmpty().selectNodeContents(t)):e.textrange&&(o=document.createNode("div"),o.appendChild(t),e.saved.pasteHTML(o.innerHTML)),n&&e.collapseToEnd(),e},e.getText=function(){return e.domrange?""+e.saved:e.textrange?e.saved.text:void 0},e.extractText=function(){var t=e.getText();return e.deleteContents(),t},e.getHTML=function(){var t,n;return e.domrange?(n=e.saved.cloneContents(),t=document.createElement("div"),t.appendChild(n),t.innerHTML):e.textrange?e.saved.htmlText:void 0},e.extractHTML=function(){var t=e.getHTML();return e.deleteContents(),t},e.actualSelectNode=function(t){return"string"==typeof t&&(t=document.getElementById(t)),e.domrange?e.saved.selectNode(t):e.textrange&&e.saved.moveToElementText(t),e},e.selectNode=function(t){return"string"==typeof t&&(t=document.getElementById(t)),e.domrange?e.saved.selectNodeContents(t):e.textrange&&e.saved.moveToElementText(t),e},e.selectNodeContents=function(n){"string"==typeof n&&(n=document.getElementById(n));var o,r;return e.domrange?e.saved.selectNodeContents(n):e.textrange&&(e.saved.moveToElementText(n),o=t().setCaretToStart(n).getNative(),r=t().setCaretToEnd(n).getNative(),e.saved.setEndPoint("StartToStart",o),e.saved.setEndPoint("EndToStart",r)),e},e.setCaretToStart=function(t){return"string"==typeof t&&(t=document.getElementById(t)),e.domrange?(e.saved.selectNodeContents(t),e.saved.collapse(!0)):e.textrange&&(e.saved.moveToElementText(t),e.saved.collapse(!0)),e},e.setCaretToBlockStart=function(t){return"string"==typeof t&&(t=document.getElementById(t)),e.domrange?(e.saved.selectNodeContents(t),e.saved.collapse(!0)):e.textrange&&(e.saved.moveToElementText(t),e.saved.collapse(!1),e.saved.move("character",-(t.innerText.length+1))),e},e.selectInlineStart=function(t){return"string"==typeof t&&(t=document.getElementById(t)),e.domrange?(e.saved.selectNodeContents(t),e.saved.collapse(!0).select()):e.textrange&&(t.innerHTML="a"+t.innerHTML,e.saved.moveToElementText(t),e.saved.collapse(!1),e.saved.move("character",-(t.innerText.length+1)),e.saved.moveEnd("character",1),e.saved.select(),e.saved.text=""),e},e.setCaretToEnd=function(t){return"string"==typeof t&&(t=document.getElementById(t)),e.domrange?(e.saved.selectNodeContents(t),e.saved.collapse(!1)):e.textrange&&(e.saved.moveToElementText(t),e.saved.collapse(!1)),e},e.isCollapsed=function(){return e.domrange?e.saved.collapsed:e.textrange?e.saved.isEqual(e.clone().collapseToStart().saved):void 0},e.compareEndPoints=function(t,n){var o;if(n&&n.saved&&(n=n.getNative()),e.domrange){o=window.Range;var r={StartToStart:o.START_TO_START,StartToEnd:o.END_TO_START,EndToStart:o.START_TO_END,EndToEnd:o.END_TO_END};return t=r[t],e.saved.compareBoundaryPoints(t,n)}return e.textrange?e.saved.compareEndPoints(t,n):void 0},e.isEqualTo=function(t){return t&&t.saved&&(t=t.getNative()),0!==e.compareEndPoints("StartToStart",t)?!1:0!==e.compareEndPoints("EndToEnd",t)?!1:!0},e.getStartNode=function(){if(e.domrange)return e.saved.startContainer;if(e.textrange){var t=e.saved.duplicate();return t.collapse(!0),t.parentElement()}},e.getEndNode=function(){if(e.domrange)return e.saved.endContainer;if(e.textrange){var t=e.saved.duplicate();return t.collapse(!1),t.parentElement()}},e.getParentNode=function(){return e.domrange?e.saved.commonAncestorContainer:e.textrange?e.saved.parentElement():void 0},e.getStartElement=function(){return e.util.getParentElement(e.getStartNode())},e.getEndElement=function(){return e.util.getParentElement(e.getEndNode())},e.getParentElement=function(){return e.domrange?e.util.getParentElement(e.saved.commonAncestorContainer):e.textrange?e.saved.parentElement():void 0},e.clone=function(){var n=t();return e.domrange?n.saved=e.saved.cloneRange():e.textrange&&(n.saved=e.saved.duplicate()),n.bookmark=e.cloneBookmark(),n},e.saveToDOM=function(t){var n,o,r,a,s;return t||(t="lasso"),e.removeDOMmarkers(t),s=e.isCollapsed(),n=e.clone().collapseToStart().getNative(),s||(o=e.clone().collapseToEnd().getNative()),e.domrange?(r=document.createElement("span"),r.innerHTML="&#x200b",r.id=t+"_range_start",n.insertNode(r),s||(a=document.createElement("span"),a.innerHTML="&#x200b",a.id=t+"_range_end",o.insertNode(a))):e.textrange&&(n.pasteHTML('<span id="'+t+'_range_start">&#x200b;</span>'),s||o.pasteHTML('<span id="'+t+'_range_end">&#x200b;</span>')),e=e.restoreFromDOM(t,!1)||e.reset()},e.restoreFromDOM=function(n,o){var r,a,s,i;return n&&""!==n&&n!==!0&&n!==!1||(n="lasso"),n===!0&&(o=!0),s=document.getElementById(n+"_range_start"),i=document.getElementById(n+"_range_end"),s?(r=t().actualSelectNode(s).collapseToEnd(),o!==!1&&s.parentNode.removeChild(s),i?(a=t().actualSelectNode(i).collapseToStart(),o!==!1&&i.parentNode.removeChild(i)):a=r,e=t().setStartToRangeStart(r).setEndToRangeEnd(a)):!1},e.isSavedRange=function(e){return e||(e="lasso"),document.getElementById(e+"_range_start")?!0:!1},e.removeDOMmarkers=function(e){var t,n;e||(e="lasso"),t=document.getElementById(e+"_range_start"),n=document.getElementById(e+"_range_end"),t&&t.parentNode.removeChild(t),n&&n.parentNode.removeChild(n)},e.bookmarkify=function(t){if(e.domrange){var n,o,r,a={};if(!t||!t.nodeType)return e;for(a.startoffset=e.saved.startOffset,a.endoffset=e.saved.endOffset,o=[],n=e.saved.startContainer;n!==t;)if(o.unshift(e.util.getNodeOffset(n)),n=n.parentNode,null===n)return e;for(r=[],n=e.saved.endContainer;n!==t;)if(r.unshift(e.util.getNodeOffset(n)),n=n.parentNode,null===n)return e;a.startnodeoffsets=o.join("-"),a.endnodeoffsets=r.join("-"),a.rootnode=t,e.bookmark=a}else e.textrange&&(e.bookmark=e.saved.getBookmark());return e},e.unbookmarkify=function(t){var n=e.bookmark;if(e.domrange){var o,r,a,s,i,d;if(!n.rootnode||!t)return e.setToEmpty();for(o=t,a=n.startnodeoffsets.split("-");a.length>0;){if(r=a.shift(),!o.childNodes||!o.childNodes[r])return e.setToEmpty();o=o.childNodes[r]}for(i=o,o=t,s=n.endnodeoffsets.split("-");s.length>0;){if(r=s.shift(),!o.childNodes||!o.childNodes[r])return e.setToEmpty();o=o.childNodes[r]}d=o,e.setToEmpty(),e.saved.setStart(i,n.startoffset),e.saved.setEnd(d,n.endoffset)}else e.textrange&&e.bookmark&&(e.reset().saved.moveToBookmark(n),e.bookmarkify());return e},e.clearBookmark=function(){return e.bookmark=!1,e},e.cloneBookmark=function(n){if(n||(n=e.bookmark),e.domrange)return n?{rootnode:n.rootnode,startnodeoffsets:n.startnodeoffsets,endnodeoffsets:n.endnodeoffsets,startoffset:n.startoffset,endoffset:n.endoffset}:!1;if(e.textrange){if(!n)return!1;var o=t().getNative();return o.moveToBookmark(n)?o.getBookmark():!1}},e.inspect=function(t){n.log({logid:t?t:"",startelement:e.getStartElement(),startnode:e.getStartNode(),endelement:e.getEndElement(),endnode:e.getEndNode(),text:e.getText(),html:e.getHTML(),parent:e.getParentNode()})},e.util={getParentElement:function(e){if(1!==e.nodeType)for(;1!==e.nodeType;)if(e=e.parentNode,null===e)return null;return e},getNodeOffset:function(e){if(e&&e.parentNode){for(var t=0;e.parentNode.childNodes[t]!==e;)t+=1;return t}}},e.init(),e},function(e){var t={version:"1.0pre",enabledplugins:[],ready:!1,active:!1,isEditing:!0,blockElemId:0,editorchrome:null,debug:!1};t.el={},t.api={},t.plugins={},e.ghostedit=t}(window),function(e){e.ghostedit.init=function(t,n){"string"==typeof t&&(t=document.getElementById(t));var o,r,a,s,i,d=e.ghostedit;if(d.options={},d.options=n||{},d.options.debug&&(d.debug=!0),d.browserEngine=d.util.detectEngines(),d.useMozBr=0!==d.browserEngine.gecko||0!==d.browserEngine.webkit||0!==d.browserEngine.opera,t.style.display="none",d.el.source=t,s=document.createElement("div"),s.id="ghostedit_uilayer",s.className="ghostedit_uilayer",s.innerHTML="<span style='position: absolute; display: none;left: 0; top: 0;line-height: 0'>ie bug fix</span>",t.parentNode.insertBefore(s,t),d.el.uilayer=s,d.history.init(),d.inout.init(),d.clipboard.init(),d.options.plugins=d.options.plugins||[],d.options.plugins.unshift("container","textblock"),d.options.plugins)for(o=0;d.options.plugins.length>o;o++)d.api.plugin.enable(d.options.plugins[o]);d.event.trigger("init"),a=d.inout.importHTML(t),t.parentNode.insertBefore(a,t),d.el.rootnode=a,r=a.getAttribute("data-ghostedit-handler"),d.plugins[r].focus(a);try{document.execCommand("styleWithCSS",!1,!1)}catch(l){}try{document.execCommand("enableObjectResizing",!1,!1)}catch(l){}d.selection.save(),d.history.reset(),d.history.saveUndoState(),i=document.getElementsByTagName("html")[0],d.util.addEvent(i,"dragenter",d.util.cancelEvent),d.util.addEvent(i,"dragleave",d.util.cancelEvent),d.util.addEvent(i,"dragover",d.util.cancelEvent),d.util.addEvent(i,"drop",d.util.cancelEvent),d.util.addEvent(a,"click",d.selection.save),d.util.addEvent(a,"mouseup",d.selection.save),d.util.addEvent(a,"keyup",d.selection.save),d.util.addEvent(a,"keydown",function(e){d.event.keydown(this,e)}),d.util.addEvent(a,"keypress",function(e){d.event.keypress(this,e)}),d.util.addEvent(a,"dragenter",d.util.cancelEvent),d.util.addEvent(a,"dragleave",d.util.cancelEvent),d.util.addEvent(a,"dragover",d.util.cancelEvent),d.util.addEvent(a,"drop",d.util.cancelEvent),a.focus(),d.plugins.container.focus(a),d.ready=!0,d.event.trigger("init:after")}}(window),function(e){var t={},n=e.ghostedit;t.register=function(e,t){return n.plugins[e]?!1:(n.plugins[e]=t,!0)},t.enable=function(e){if(!n.plugins[e])return!1;n.enabledplugins[e]&&t.disable(e);var o=n.plugins[e];"function"==typeof o.enable&&o.enable(),n.enabledplugins[e]=!0},t.disable=function(e){if(!n.enabledplugins[e]||!n.plugins[e])return!1;var t=n.plugins[e];"function"==typeof t.disable&&t.disable(),n.enabledplugins[e]=!1},e.ghostedit.api.plugin=t}(window),function(e,t){var n={};n.trim=function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")},n.preparefunction=function(e,t){var n=Array.prototype.slice.call(arguments,2);return function(){var o=n.concat(Array.prototype.slice.call(arguments));return e.apply(t?t:this,o)}},n.isFunction=function(e){return e?"function"!=typeof e?!1:!0:!1},n.cloneObject=function(e){var t,o,r,a;if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return t=new Date,t.setTime(e.getTime()),t;if(e instanceof Array){for(t=[],r=0,o=e.length;o>r;++r)t[r]=n.cloneObject(e[r]);return t}if(e instanceof Object){t={};for(a in e)e.hasOwnProperty(a)&&(t[a]=n.cloneObject(e[a]));return t}},n.addClass=function(e,t){e.className=n.trim(e.className)+" "+t},n.removeClass=function(e,t){var o=RegExp(t,"g");e.className=n.trim(e.className.replace(o,""))},n.cancelEvent=function(e){return e&&e.preventDefault?(e.stopPropagation(),e.preventDefault()):e&&(e.returnValue=!1),!1},n.cancelAllEvents=function(t){return t&&t.preventDefault?(t.stopPropagation(),t.preventDefault()):e.event&&(e.event.cancelBubble=!0),!1},n.preventDefault=function(e){return e&&e.preventDefault&&e.preventDefault(),!1},n.preventBubble=function(t){t&&t.stopPropagation&&t.stopPropagation(),e.event&&(e.event.cancelBubble=!0)},n.addEvent=function(e,n,o){e.addEventListener!==t?e.addEventListener(n,o,!1):e.attachEvent("on"+n,o)},n.removeEvent=function(e,n,o){e.removeEventListener!==t?e.removeEventListener(n,o,!1):e.detachEvent("on"+n,o)},n.ajax=function(n,o,r,a,s){var i,d,l;if(!n||!o)return!1;if(l=!1,!e.XMLHttpRequest||"file:"===e.location.protocol&&e.ActiveXObject)try{l=new e.ActiveXObject("Microsoft.XMLHTTP")}catch(c){try{l=new e.ActiveXObject("MSXML2.XMLHTTP")}catch(u){}}else l=new e.XMLHttpRequest;return l?(o=o.toUpperCase(),i=(new Date).getTime(),n=n.replace(/(\?)+$/,""),d=-1===n.indexOf("?")?"?":"&","GET"===o?l.open(o,n+d+i+"&"+r,!0):l.open(o,n+d+i,!0),l.onreadystatechange=function(){var e;return 4===l.readyState?200===l.status?(e="xml"===s?l.responseXML:l.responseText,null!==a&&a(!0,e),!0):(null!==a&&a(!1,e),!1):t},l.setRequestHeader("Content-type","application/x-www-form-urlencoded"),"POST"===o&&null!==r?l.send(r):l.send(),t):!1},n.detectEngines=function(){var t={ie:0,gecko:0,webkit:0,khtml:0,opera:0,ver:null},n=navigator.userAgent;return e.opera?(t.ver=e.opera.version(),t.opera=parseFloat(t.ver)):/AppleWebKit\/(\S+)/.test(n)?(t.ver=RegExp.$1,t.webkit=parseFloat(t.ver)):/KHTML\/(\S+)/.test(n)||/Konqueror\/([^;]+)/.test(n)?(t.ver=RegExp.$1,t.khtml=parseFloat(t.ver)):/rv:([^\)]+)\) Gecko\/\d{8}/.test(n)?(t.ver=RegExp.$1,t.gecko=parseFloat(t.ver)):/MSIE ([^;]+)/.test(n)&&(t.ver=RegExp.$1,t.ie=parseFloat(t.ver)),t},e.ghostedit.util=n}(window),function(e,t){var n={listeners:[],listenerid:0,eventtypes:[],cancelKeypress:!1},o=e.ghostedit;n.keydown=function(t,r){var a,s,i,d;switch(o.selection.save(!1),r=r&&r.istest||!e.event?r:e.event,a=null!==r.keyCode?r.keyCode:r.charCode,n.trigger("input:keydown",{event:r,keycode:a}),a){case 8:case 46:if(n.cancelKeypress=!1,o.selection.savedRange.isCollapsed()===!1)return o.history.saveUndoState(),o.selection.deleteContents(8===a?"collapsetostart":"collapsetoend"),o.history.saveUndoState(),n.cancelKeypress=!0,o.util.cancelEvent(r);break;case 83:if(r.ctrlKey)return o.api.save(),o.util.cancelEvent(r);break;case 66:if(r.ctrlKey)return o.plugins.textblock.format.bold(),o.util.cancelEvent(r);break;case 73:if(r.ctrlKey&&!r.shiftKey)return o.plugins.textblock.format.italic(),o.util.cancelEvent(r);break;case 85:if(r.ctrlKey)return o.plugins.textblock.format.underline(),o.util.cancelEvent(r);break;case 90:if(r.ctrlKey)return o.history.undo(),o.util.cancelEvent(r);break;case 89:if(r.ctrlKey)return o.history.redo(),o.util.cancelEvent(r)}for(s=o.selection.getContainingGhostBlock();;){if(i=s.getAttribute("data-ghostedit-handler"),o.plugins[i]&&o.plugins[i].event&&o.plugins[i].event.keydown&&(d=o.plugins[i].event.keydown(s,a,r),d===!0))break;if(s=o.dom.getParentGhostBlock(s),!s)break}return o.selection.save(),!0},n.keypress=function(r,a){var s,i,d,l,c,u;switch(o.selection.save(),c=o.el.rootnode.innerHTML.length,u=o.history.undoData[o.history.undoPoint]!==t?o.history.undoData[o.history.undoPoint].content.string.length:0,a=a&&a.istest||!e.event?a:e.event,s=null!==a.keyCode?a.keyCode:a.charCode,n.trigger("input:keydown",{event:a,keycode:s}),"none"===o.selection.saved.type||o.selection.savedRange.isCollapsed()||a.ctrlKey||o.selection.deleteContents("collapsetostart"),s){case 8:if(n.cancelKeypress===!0)return n.cancelKeypress=!1,o.util.cancelEvent(a);break;case 13:o.util.cancelEvent(a)}for(i=o.selection.getContainingGhostBlock();;){if(d=i.getAttribute("data-ghostedit-handler"),o.plugins[d]&&o.plugins[d].event&&o.plugins[d].event.keypress&&(l=o.plugins[d].event.keypress(i,s,a),l===!0))break;if(i=o.dom.getParentGhostBlock(i),!i)break}return o.selection.save(),!0},n.addListener=function(e,t,o){var r,a,s,i;if("function"!=typeof t)return!1;for(r=n.listeners,r[e]&&"object"==typeof r[e]&&r[e]instanceof Array||(r[e]=[]),a=n.eventtypes,s=!0,i=0;a.length>i;i++)if(a[i]===e){s=!1;break}return s&&a.push(e),n.listenerid++,r[e].push({id:n.listenerid,callback:t,revokekey:o}),n.listenerid},n.removeListener=function(e,t){var o,r=n.listeners,a=[];if(r[e]){for(o=0;r[e].length>o;o++)r[e].id!==t&&a.push(r[e][o]);r[e]=a}},n.removeAllListeners=function(e){var t,r,a,s,i,d=[];if(e)for(t=n.listeners,r=n.eventtypes,s=0;r.length>s;s++){for(a=r[s],i=0;t[a].length>i;i++)t[a][i].revokekey&&t[a][i].revokekey===e||d.push(t[a][i]);t[a]=o.util.cloneObject(d),d=[]}},n.trigger=function(r,a){var s,i=n.listeners;if(a===t&&(a={}),i[r]&&"object"==typeof i[r]&&i[r]instanceof Array)for(o.debug&&(e.console.log(r),e.console.log(a)),s=0;i[r].length>s;s++)i[r][s].callback.call(this,a)},n.sendBackwards=function(e,t,r){var a,s,i,d=!1;if(r||(r={}),!o.dom.isGhostBlock(t))return!1;for(a=t;;){if((d=o.dom.getPreviousSiblingGhostBlock(a))?i="ahead":(d=o.dom.getParentGhostBlock(a))&&(i="top"),s=n.send(e,d,i,r),!s)return!1;if(s.handled===!0)return!0;a=d}},n.sendForwards=function(e,t,r){var a,s,i,d=!1;if(r||(r={}),!o.dom.isGhostBlock(t))return!1;for(a=t;;){if((d=o.dom.getNextSiblingGhostBlock(a))?i="behind":(d=o.dom.getParentGhostBlock(a))&&(i="bottom"),s=n.send(e,d,i,r),!s)return!1;if(s.handled===!0)return!0;a=d}},n.send=function(e,t,n,r){var a,s;return t?(a=t.getAttribute("data-ghostedit-handler"),o.plugins[a]&&o.plugins[a].dom&&o.plugins[a].dom.deleteevent?(s=o.plugins[a].dom.deleteevent(t,n,r),{handled:s}):{handled:!1}):!1},e.ghostedit.event=n}(window),function(e,t){var n={};n.getNodeOffset=function(e){var t,n;if(e&&e.parentNode){for(t=0,n=e.parentNode.childNodes;n[t]!==e;)t+=1;return t}},n.extractContent=function(e){for(var t,n=document.createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n},n.cloneContent=function(e){var t,n,o=document.createDocumentFragment();for(n=0;e.childNodes.length>n;n++)t=e.childNodes[n],o.appendChild(t.cloneNode(!0));return o},n.parse=function(e,o){var r,a,s,i,d,l,c,u,g,f,p=!1;if(!e||!o||!e.nodeType)return!1;if(o.textnode=o.textnode||{},o.tags=o.tags||{},3===e.nodeType)return l=o.textnode.clean?e.nodeValue.replace(/[\n\r\t]/g,""):e.nodeValue,l.length>0?document.createTextNode(l):!1;if(1!==e.nodeType)return!1;if(c=e.tagName.toLowerCase(),u={contentsonly:!0},o.tags[c]&&(u=o.tags[c],"string"==typeof u.template&&(u=u.template),"string"==typeof u&&o.templates[u]&&(u=o.templates[u]),"string"==typeof u))return!1;if(p=u.contentsonly?document.createDocumentFragment():document.createElement(e.tagName.toLowerCase()),!u.ignorechildren)for(r=e.childNodes,s=0;r.length>s;s++)a=n.parse(r[s],o),a&&p.appendChild(a);if(u.contentsonly)return p.childNodes.length>0?p:!1;if(u.attributes)for(s=0;u.attributes.length>s&&(g=u.attributes[s],"string"==typeof g&&(g={name:g}),"string"==typeof g.name)&&(d=g.value||"class"===g.name?e.className:e.getAttribute(g.name),d!==t);s++){if(g.copy=!0,g.allowedvalues)for(g.copy=!1,i=0;g.allowedvalues.length>i;i++)if(g.allowedvalues[s]===d){g.copy=!0;break}g.copy&&("class"===g.name?p.className=d:p.setAttribute(g.name,d))}if(u.styles)for(s=0;u.styles.length>s&&(f=u.styles[s],"string"==typeof f&&(f={name:f}),"string"==typeof f.name)&&("float"===f.name&&(f.name=e.style.cssFloat?"cssFloat":"styleFloat"),d=f.value||e.style[f.name],d!==t);s++){if(f.copy=!0,f.allowedvalues)for(f.copy=!1,i=0;f.allowedvalues.length>i;i++)if(f.allowedvalues[i]===d){f.copy=!0;break}f.copy&&(p.style[f.name]=d)}return p},n.isGhostBlock=function(e){if(!e||!e.nodeType||1!==e.nodeType)return!1;var n=e.getAttribute("data-ghostedit-elemtype");return n!==t&&n!==!1&&null!==n?!0:!1},n.isChildGhostBlock=function(e,n){var o;if(!e||!n||!n.childNodes)return!1;if(1!==e.nodeType)return!1;if(e.getAttribute("data-ghostedit-elemtype")===t)return!1;if(e.getAttribute("data-ghostedit-elemtype")===!1)return!1;if(null===e.getAttribute("data-ghostedit-elemtype"))return!1;var r=n.childNodes;for(o=0;r.length>o;o+=1)if(e===r[o])return!0;return!1},n.isGhostToplevel=function(e){return e&&e.getAttribute("data-ghostedit-isrootnode")===!0?!0:!1},n.getParentGhostBlock=function(e){if(!e)return!1;do if(e=e.parentNode,null===e)return!1;while(!n.isGhostBlock(e));return e},n.getFirstChildGhostBlock=function(e){var t,o;if(!e||!e.childNodes)return!1;for(t=e.childNodes,o=0;t.length>o;o+=1)if(n.isGhostBlock(t[o]))return t[o];return!1},n.getLastChildGhostBlock=function(e){var t,o;if(!e||!e.childNodes)return!1;for(t=e.childNodes,o=t.length-1;o>=0;o-=1)if(n.isGhostBlock(t[o]))return t[o];return!1},n.getPreviousSiblingGhostBlock=function(e){var t,o,r;if(!e||!e.parentNode)return!1;t=e.parentNode,o=n.getNodeOffset(e)-1,r=t.childNodes;do{if(n.isGhostBlock(r[o])===!0)return r[o];o-=1}while(o>=0);return!1},n.getNextSiblingGhostBlock=function(e){var t,o,r;if(!e||!e.parentNode)return!1;t=e.parentNode,o=n.getNodeOffset(e)+1,r=t.childNodes;do{if(n.isGhostBlock(r[o])===!0)return r[o];o+=1}while(r.length>o);return!1},n.getParentElement=function(e){if(1!==e.nodeType)for(;1!==e.nodeType;)if(e=e.parentNode,null===e)return null;return e},n.isDescendant=function(e,t){for(var n=t.parentNode;null!==n;){if(n===e)return!0;n=n.parentNode}return!1},n.getFirstChildElement=function(e){var t,n;if(!e||!e.childNodes)return!1;for(t=e.childNodes,n=0;t.length>n;n+=1)if(1===t[n].nodeType)return t[n];return!1},n.getCertainParent=function(e,t){var n=[].slice.call(arguments);if(n.shift(),!e.apply(this,n))for(;!e.apply(this,n);)if(t=t.parentNode,n[0]=t,null===t)return!1;return t},e.ghostedit.dom=n}(window),function(e){var t={savedRange:null,nodepath:[],saved:{type:"none",data:null},archived:{type:"none",data:null}},n=e.ghostedit,o=e.lasso;t.save=function(e){var r;return e!==!1&&(e=!0),r=o().setToSelection(),t.isInEditdiv(r.getStartNode())?(t.saved.type="textblock",t.saved.data=r,t.savedRange=t.saved.data,n.event.trigger("selection:change"),t.updatePathInfo(),e&&n.event.trigger("ui:update"),!0):(t.saved.type="none",!1)},t.set=function(e,o,r){return r!==!1&&(r=!0),"string"==typeof e?(t.saved.type=e,t.saved.data=o,t.savedRange=t.saved.data,t.updatePathInfo(),n.event.trigger("selection:change"),r&&n.event.trigger("ui:update"),!0):undefined},t.restore=function(e,o,r){return e&&"string"==typeof e||(e=t.saved.type),o||(o=t.saved.data),"none"===e&&r&&(e=t.archived.type,o=t.archived.data),"none"===e?(t.clear(),!0):n.plugins[e]&&n.plugins[e].selection.restore?n.plugins[e].selection.restore(o)?!0:(t.clear(),!1):undefined},t.restoreValid=function(e,n){return t.restore(e,n,!0)},t.deleteContents=function(e){"collapsetostart"!==e&&"collapsetoend"!==e&&(e=!1);var r,a,s;for(s=t.getContainingGhostBlock();;){if(r=s.getAttribute("data-ghostedit-handler"),a=n.plugins[r].selection.deleteContents(s,e),a===!0)break;if(s=n.dom.getParentGhostBlock(s),!s)break}switch(e){case"collapsetostart":o().setToSelection().collapseToStart().select();break;case"collapsetoend":o().setToSelection().collapseToEnd().select()}t.save()},t.isSameAs=function(e){return e&&e.type?e.type!==t.saved.type?!1:"none"===e.type?!0:n.plugins[e.type]&&n.plugins[e.type].selection.compare?n.plugins[e.type].selection.compare(e.data,t.saved.data):!1:!1},t.clear=function(){o().clearSelection(),t.saved={type:"none",data:null}},t.isInEditdiv=function(e){if(1!==e.nodeType||"true"!==e.getAttribute("data-ghostedit-isrootnode"))for(;1!==e.nodeType||"true"!==e.getAttribute("data-ghostedit-isrootnode");){if(null===e)return!1;if(e=e.parentNode,null===e)return!1}return!0},t.updatePathInfo=function(e){if(e||(e=t.saved.data),e.nodeType||(e=e.getParentNode()),t.nodepath=[],1!==e.nodeType||"true"!==e.getAttribute("data-ghostedit-isrootnode"))for(;1!==e.nodeType||"true"!==e.getAttribute("data-ghostedit-isrootnode");){if(null===e)return null;if(1===e.nodeType&&t.nodepath.push(e),e=e.parentNode,null===e)return!1}e&&"true"===e.getAttribute("data-ghostedit-isrootnode")&&t.nodepath.push(e)},t.getContainingGhostBlock=function(){var e=t.saved.data;if(e.nodeType||(e=e.getParentNode()),!e)return!1;for(;!n.dom.isGhostBlock(e);)if(e=e.parentNode,null===e)return!1;return e},e.ghostedit.selection=t}(window),function(e){var t={},n=e.ghostedit;t.init=function(){t.reset(),n.event.addListener("selection:change",function(){n.history.selectionchanged=!0}),n.api.importHTML=function(e){return t.importHTML(e)},n.api.exportHTML=function(){return t.exportHTML()}},t.reset=function(){t.importhandlers=[]},t.importHTML=function(e){var t;return!e||1>e.childNodes.length?!1:(t=n.plugins.container.inout.importHTML(e),t.className="ghostedit_rootnode",t.setAttribute("data-ghostedit-isrootnode","true"),t.contentEditable="true",n.event.trigger("import:after",{rootnode:t}),t)},t.exportHTML=function(){var e,t=n.el.rootnode;return n.event.trigger("export:before"),t.contentEditable=!1,e=n.plugins.container.inout.exportHTML(t,!1),t.contentEditable=!0,n.event.trigger("export:after"),e},t.openPreview=function(){e.open(n.options.previewurl)},t.registerimporthandler=function(e){var n,o,r;if("function"!=typeof e)return!1;if(2>arguments.length)return!1;for(o=Array.prototype.slice.call(arguments),o.shift(),n=0;o.length>n;n++)r=o[n],t.importhandlers[r]=e},e.ghostedit.inout=t}(window),function(e,t){var n={},o=e.ghostedit;n.init=function(){n.reset(),o.event.addListener("selection:change",function(){n.selectionchanged=!0}),o.api.undo=function(){return n.undo()},o.api.redo=function(){return n.redo()}},n.reset=function(){n.undoData=[],n.undoPoint=0,n.selectionchanged=!0},n.saveUndoState=function(e){var t,r,a,s,i,d,l=o.el.rootnode;e!==!0&&(e=!1),o.event.trigger("history:save:before"),t=n.undoPoint,r=n.undoData,d=r[t],d||(e=!0),i={id:"",selection:{type:o.selection.saved.type,data:o.selection.saved.data},content:{string:l.innerHTML}},e||(a=d.content.string!==i.content.string?!0:!1,s=!o.selection.isSameAs(d.selection)),(e||s||a)&&(i.content.dom=o.dom.extractContent(l.cloneNode(!0)),e||a?(t>0&&n.undoData.splice(0,t),n.undoData.unshift(i),n.undoPoint=0):n.undoData[t]=i),o.event.trigger("history:save:after")},n.restoreUndoPoint=function(e){var r=n.undoData,a=r[e];return!a||1>a.content.string.length?!1:(o.event.trigger("history:restore:before"),o.el.rootnode.innerHTML="",o.el.rootnode.appendChild(o.dom.cloneContent(a.content.dom)),o.selection.restore(a.selection.type,a.selection.data),o.event.trigger("history:restore:after"),t)},n.undo=function(){var e=n.undoPoint,r=n.undoData,a=o.el.rootnode;r[e+1]===t||0>=r[e+1].content.string.length||(o.event.trigger("history:undo:before"),r[e].content.string!==a.innerHTML?(n.saveUndoState(),e=1):(0===e&&n.saveUndoState(),e=n.undoPoint,e+=1),n.restoreUndoPoint(e),n.undoPoint=e,n.undoData=r,o.event.trigger("history:undo:after"))},n.redo=function(){var e=n.undoPoint,r=n.undoData,a=o.el.rootnode;e>0&&r[e-1]!==t&&r[e-1].content.string.length>0&&(o.event.trigger("history:redo:before"),r[e].content.string!==a.innerHTML?n.saveUndoState(!0):(e-=1,n.restoreUndoPoint(e),n.undoPoint=e,n.undoData=r),o.event.trigger("history:redo:after"))},e.ghostedit.history=n}(window),function(e){var t,n,o={},r=e.lasso,a=e.ghostedit,s=e.console||{};s.log=s.log||function(){},o.init=function(){o.paste.init(),o.cut.init()},t={savedcontent:null,savedundodata:null,savedundopoint:null,beforerangedata:"",afterrangedata:"",waitlength:0,postpastetidylist:[]},t.init=function(){a.event.addListener("init:after",function(){a.util.addEvent(a.el.rootnode,"paste",function(e){t.handle(e)})},"clipboard")},t.handle=function(e){return a.history.saveUndoState(),t.savedundodata=a.history.undoData,t.savedundopoint=a.history.undoPoint,t.triedpasteimage=!1,e.clipboardData&&e.clipboardData.getData?(/image/.test(e.clipboardData.types)&&(t.triedpasteimage=!0),a.el.rootnode.innerHTML=/text\/html/.test(e.clipboardData.types)?e.clipboardData.getData("text/html"):/text\/plain/.test(e.clipboardData.types)||a.browserEngine.opera?e.clipboardData.getData("text/plain").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):"",t.waitfordata(),a.util.cancelEvent(e)):(a.el.rootnode.innerHTML="",t.waitfordata(),!0)},t.waitfordata=function(){var e=a.el.rootnode;e.childNodes&&e.childNodes.length>0?t.process():setTimeout(t.waitfordata,20)},t.process=function(){var e,n,o,r;if(e=document.createElement("div"),e=a.plugins.container.inout.importHTML(a.el.rootnode),s.log("processed content"),s.log(e.cloneNode(!0)),a.history.undoData=t.savedundodata,a.history.undoPoint=t.savedundopoint,a.history.restoreUndoPoint(a.history.undoPoint),a.selection.save(),a.selection.deleteContents(),a.selection.save(),o=a.dom.getFirstChildGhostBlock(e)){for(a.selection.saved.data.isCollapsed()?a.selection.saved.data.saveToDOM("ghostedit_paste_start"):(a.selection.saved.data.clone().collapseToStart().saveToDOM("ghostedit_paste_start"),a.selection.saved.data.clone().collapseToEnd().saveToDOM("ghostedit_paste_end")),n=function(){return a.selection.saved.data.getStartNode()},r={isfirst:!0,islast:a.dom.getLastChildGhostBlock(e)===o?!0:!1},n=t.callHandler(n,o,r),o=a.dom.getLastChildGhostBlock(e),o&&(n=function(){return a.selection.saved.data.getEndNode()},r={isfirst:!1,islast:!0},t.callHandler(n,o,r)),n=function(){return a.selection.saved.data.getParentNode()},r={isfirst:!1,islast:!1};o=a.dom.getFirstChildGhostBlock(e);)t.callHandler(n,o,r);a.selection.saved.data.restoreFromDOM("ghostedit_paste_start",!0).select(),a.selection.saved.data.isSavedRange("ghostedit_paste_end")&&a.selection.saved.data.restoreFromDOM("ghostedit_paste_end",!0).select(),a.selection.save(),a.history.undoData=t.savedundodata,a.history.undoPoint=t.savedundopoint,a.history.saveUndoState(),t.triedpasteimage&&a.event.trigger("ui:message",{message:"You cannot paste images into the editor, please use the add image button instead",time:2,color:"warn"}),a.event.trigger("clipboard:paste:after")}},t.callHandler=function(e,t,n){var o,i,d;for(a.selection.saved.data.restoreFromDOM("ghostedit_paste_start",!1),r().isSavedRange("ghostedit_paste_end")&&a.selection.saved.data.setEndToRangeEnd(r().restoreFromDOM("ghostedit_paste_end",!1)),o=e(),a.dom.isGhostBlock(o)||(o=a.dom.getParentGhostBlock(o));;){if(!o)break;if(i=o.getAttribute("data-ghostedit-handler"),!a.plugins[i]||!a.plugins[i].paste)break;if(s.log("Call handler: ("+(n.isfirst?"first":n.islast?"last":"normal")+")"+i),s.log(o.cloneNode(!0)),s.log(t.cloneNode(!0)),d=a.plugins[i].paste.handle(o,t,n),s.log("result: "+d),d){t.parentNode.removeChild(t);break}a.selection.saved.data.restoreFromDOM("ghostedit_paste_start",!1),r().isSavedRange("ghostedit_paste_end")&&a.selection.saved.data.setEndToRangeEnd(r().restoreFromDOM("ghostedit_paste_end",!1)),o=a.dom.getParentGhostBlock(o)}},n={savedcontent:null,savedundodata:null,savedundopoint:null},n.init=function(){a.event.addListener("init:after",function(){a.util.addEvent(a.el.rootnode,"cut",function(e){n.handle(e)})},"clipboard")},n.handle=function(){return a.history.saveUndoState(),n.savedundodata=a.history.undoData,n.savedundopoint=a.history.undoPoint,setTimeout(n.cleanup,20),!0},n.cleanup=function(){a.history.undoData=n.savedundodata,a.history.undoPoint=n.savedundopoint,a.history.restoreUndoPoint(a.history.undoPoint),a.selection.save(),a.selection.deleteContents(),a.selection.save(),a.history.saveUndoState()
},o.paste=t,o.cut=n,e.ghostedit.clipboard=o}(window),function(e,t){var n={},o=e.lasso,r=e.ghostedit,a=e.console||{};a.log=a.log||function(){},n.enable=function(){return n.format.init(),r.inout.registerimporthandler(n.inout.importHTML,"p","h1","h2","h3","h4","h5","h6"),r.inout.registerimporthandler(n.inout.importHTML,"#textnode","b","strong","i","em","u","strike","span"),r.event.addListener("history:save:after",function(){"textblock"===r.selection.saved.type&&r.selection.saved.data.bookmarkify(r.el.rootnode)}),r.event.addListener("history:save:after",function(){"textblock"===r.selection.saved.type&&(r.selection.saved.data=r.selection.saved.data.clone())}),r.api.insert=r.api.insert||{},r.api.insert.character=function(e){return n.insert.character(e)},r.api.insert.br=function(){return n.insert.br},!0},n.event={keydown:function(e,t,o){switch(t){case 8:return n.event.backspace(e,o);case 46:return n.event.deletekey(e,o)}},keypress:function(e,o,r){return 13===o?n.event.enterkey(e,r):t},backspace:function(e,t){if(n.selection.isAtStartOfTextBlock()!==!0)return!0;var o={merge:{contenttype:"inlinehtml",sourcecontent:e.innerHTML,callback:r.util.preparefunction(function(e){var t=e.parentNode,n=t.getAttribute("data-ghostedit-handler");r.plugins[n].dom.removechild(t,e)},!1,e)}};return r.event.sendBackwards("delete",e,o),r.event.cancelKeypress=!0,r.util.cancelEvent(t),!0},deletekey:function(e,t){return n.selection.isAtEndOfTextBlock()!==!0?!0:(r.event.sendForwards("delete",e),r.event.cancelKeypress=!0,r.util.cancelEvent(t),!0)},enterkey:function(e,t){return r.history.saveUndoState(),t.shiftKey?(n.insert.br(),n.mozBrs.tidy(e)):n.split(e),r.history.saveUndoState(),r.util.cancelEvent(t),!0}},n.dom={deleteevent:function(e,t,a){var s,i,d;switch(t){case"ahead":return r.history.saveUndoState(),n.isEmpty(e)?(s=r.dom.getParentGhostBlock(e),i=s.getAttribute("data-ghostedit-handler"),r.plugins[i].dom.removechild(s,e)):(e.innerHTML+="<span id='ghostedit_selection_marker'>&#x200b;</span>",a.merge&&a.merge.sourcecontent&&("inlinehtml"===a.merge.contenttype||"text"===a.merge.contenttype)&&(e.innerHTML+=a.merge.sourcecontent),n.mozBrs.tidy(e),a.merge.callback(),o().selectNode("ghostedit_selection_marker").select(),document.getElementById("ghostedit_selection_marker").parentNode.removeChild(document.getElementById("ghostedit_selection_marker")),r.selection.save()),r.history.saveUndoState(),!0;case"behind":return d=r.selection.getContainingGhostBlock(),a={merge:{contenttype:"inlinehtml",sourcecontent:e.innerHTML,callback:r.util.preparefunction(function(e){var t=e.parentNode,n=t.getAttribute("data-ghostedit-handler");r.plugins[n].dom.removechild(t,e)},!1,e)}},r.event.sendBackwards("delete",e,a),!0}}},n.selection={compare:function(e,t){return e&&e.isEqualTo?e.isEqualTo(t):!1},restore:function(e){return e&&e.unbookmarkify?(e.unbookmarkify(r.el.rootnode),e.select(),!0):!1},deleteContents:function(e){var t,n,a;return a=r.selection.savedRange.clone(),t=o().setCaretToStart(e),n=o().setCaretToEnd(e),-1===a.compareEndPoints("StartToStart",t)&&a.setStartToRangeStart(t),1===a.compareEndPoints("EndToEnd",n)&&a.setEndToRangeEnd(n),a.deleteContents(),!0},getTextBlockNode:function(e){if(1!==e.nodeType||"textblock"!==e.getAttribute("data-ghostedit-elemtype"))for(;1!==e.nodeType||"textblock"!==e.getAttribute("data-ghostedit-elemtype");)if(e=e.parentNode,null===e)return!1;return e},getStartTextBlockNode:function(){return n.selection.getTextBlockNode(r.selection.savedRange.getStartNode())},getEndTextBlockNode:function(){return n.selection.getTextBlockNode(r.selection.savedRange.getEndNode())},isAtStartOfTextBlock:function(e){var t,a,s,i,d,l,c,u,g,f=!1;if(g=!1,!e||!e.isLassoObject){if("textblock"!==r.selection.saved.type)return!1;e=r.selection.saved.data,g=!0}if(document.createRange){if(t=e,t.isCollapsed()&&0===t.getNative().startOffset&&(f=!0,u=r.selection.savedRange.getStartNode()),!u)return f;for(;1!==u.nodeType||"textblock"!==u.getAttribute("data-ghostedit-elemtype");){if(u!==u.parentNode.childNodes[0]){if(i=!1,3===u.parentNode.childNodes[0].nodeType&&0===u.parentNode.childNodes[0].length||1===u.parentNode.childNodes[0].nodeType&&"moz_dirty"===u.parentNode.childNodes[0].className)for(s=1;u.parentNode.childNodes.length>s;s+=1){if(d=u.parentNode.childNodes[0],u===u.parentNode.childNodes[s]){i=!0;break}if(!(3===d.nodeType&&0===d.length||1===d.nodeType&&"moz_dirty"===d.className))break}if(i!==!0){f=!1;break}}u=u.parentNode}}else document.selection&&(a=e.clone().bookmarkify(),l=n.selection.getStartTextBlockNode(),c=o().selectNodeContents(l),a.unbookmarkify(),c.getHTML()===c.setStartToRangeStart(a).getHTML()&&(f=!0),g&&(r.selection.savedRange=a.select()));return f},isAtEndOfTextBlock:function(){var e,t,a,s,i,d,l=!1;return r.selection.savedRange.isCollapsed()?(i=n.selection.getEndTextBlockNode(),document.createRange?(a=document.createElement("div"),a.appendChild(r.selection.savedRange.getNative().cloneContents()),t=r.selection.savedRange.getNative(),t.setEnd(i,i.childNodes.length),s=document.createElement("div"),a.appendChild(t.cloneContents()),n.mozBrs.clear(a),n.mozBrs.clear(s),a.innerHTML===s.innerHTML&&(l=!0)):document.selection&&(e=r.selection.savedRange.clone().bookmarkify(),i.innerHTML+='<span id="range_marker">&#x200b;</span>',d=o().selectNode("range_marker"),document.getElementById("range_marker").parentNode.removeChild(document.getElementById("range_marker")),e.unbookmarkify(),0===e.compareEndPoints("EndToEnd",d)&&(l=!0),r.selection.savedRange=e.select()),l):!1},extendtoword:function(e,t){var r,a;if(e=e.clone().getNative(),document.createRange){if(r=n.selection.findwordstart(e.startContainer,e.startOffset),a=n.selection.findwordend(e.endContainer,e.endOffset),t){if(e.startContainer===r.node&&e.startOffset===r.offset)return o().setFromNative(e);if(e.endContainer===a.node&&e.endOffset===a.offset)return o().setFromNative(e)}e.setStart(r.node,r.offset),e.setEnd(a.node,a.offset)}else e.expand("word")," "===e.htmlText.split().reverse()[0]&&e.moveEnd("character",-1);return o().setFromNative(e)},findwordstart:function(e,o){var a,s,i,d,l=/\s|[\!\?\.\,\:\;\"]/;if(!e||!e.nodeType)return!1;if(3===e.nodeType){if(a=e.nodeValue.substring(0,o),s=a.search(l),-1!==s){for(i=s+1;-1!==(s=a.substring(i).search(l));)i+=s+1;return{node:e,offset:i}}}else if(1===e.nodeType&&o>0)return n.selection.findwordstart(e.childNodes[o-1],e.childNodes[o-1].length);return n.isTextBlock(e)?{node:e,offset:o}:(d=e.previousSibling,d?3===d.nodeType?n.selection.findwordstart(d,d.nodeValue.length):1===d.nodeType?n.selection.findwordstart(d,d.childNodes.length):t:n.selection.findwordstart(e.parentNode,r.dom.getNodeOffset(e)))},findwordend:function(e,t){var o,a,s,i,d=/\s|[\!\?\.\,\:\;\"]/;if(!e||!e.nodeType)return!1;if(3===e.nodeType){if(o=e.nodeValue.substring(t),a=o.search(d),-1!==a)return s=t+a,{node:e,offset:s}}else if(1===e.nodeType&&e.childNodes.length>t)return n.selection.findwordend(e.childNodes[t],0);return n.isTextBlock(e)?{node:e,offset:t}:(i=e.nextSibling,i?n.selection.findwordend(i,0):n.selection.findwordend(e.parentNode,r.dom.getNodeOffset(e)+1))}},n.inout={handledtags:{h1:"block",h2:"block",h3:"block",h4:"block",h5:"block",h6:"block",p:"block",b:"child",i:"child",u:"child",strong:"child",em:"child",strike:"child",br:"child",a:"contents",span:"contents"},parserules:{textnode:{clean:!0},tags:{h1:"textblock",h2:"textblock",h3:"textblock",h4:"textblock",h5:"textblock",h6:"textblock",p:"textblock",b:{},i:{},u:{},strong:{},em:{},strike:{},br:{attributes:[{name:"class",allowedvalues:["moz_dirty"]}]}},templates:{textblock:{attributes:["class"],styles:[{name:"textAlign",allowedvalues:["left","right","center","justified"]},{name:"clear",allowedvalues:["left","right"]}]}}},importHTML:function(e){var t,o,a,s,i,d,l;switch(d=n.inout.isHandleableNode(e)){case"block":return o=e.tagName.toLowerCase(),t=r.dom.parse(e,n.inout.parserules),r.blockElemId+=1,t.id="ghostedit_textblock_"+r.blockElemId,t.setAttribute("data-ghostedit-iselem","true"),t.setAttribute("data-ghostedit-elemtype","textblock"),t.setAttribute("data-ghostedit-handler","textblock"),t.ondragenter=function(){return!1},t.ondragleave=function(){return!1},t.ondragover=function(){return!1},t.ondrop=function(e){var t,n;n=e.dataTransfer.getData("Text")||e.srcElement.id,t=document.getElementById(n),t.parentNode.insertBefore(t,this),r.image.focus(t)},t.onresizestart=function(e){return r.util.cancelEvent(e)},n.mozBrs.tidy(t),t;case"child":case"contents":case"text":t=n.create("p"),t.setAttribute("data-ghostedit-importinfo","wasinline"),s=0,a=e;do l=r.dom.parse(a,n.inout.parserules),l&&(s+=1,t.appendChild(l),i=a,a=a.nextSibling,s>1&&i.parentNode.removeChild(i));while(n.inout.isHandleableNode(a)&&"block"!==n.inout.isHandleableNode(a));return n.mozBrs.tidy(t),s>0?t:!1}return!1},exportHTML:function(e){if(!e||!r.dom.isGhostBlock(e)||"textblock"!==e.getAttribute("data-ghostedit-elemtype"))return!1;var t,o="",a="";return t=e,n.mozBrs.clear(t),o+="<"+t.tagName.toLowerCase(),""!==t.style.textAlign&&(a+="text-align:"+t.style.textAlign+";"),""!==t.style.clear&&(a+="clear:"+t.style.clear+";"),a.length>0&&(o+=" style='"+a+"'"),t.className.length>0&&!/ghostedit/.test(t.className)&&(o+=" class='"+t.className+"'"),o+=">",o+=t.innerHTML,o+="</"+t.tagName.toLowerCase()+">",n.mozBrs.tidy(t),{content:o}},isHandleableNode:function(e){var t;return e&&e.nodeType?3===e.nodeType?e.nodeValue.replace(/[\n\r\t]/g,"").length>0?"text":!1:1!==e.nodeType?!1:"textblock"===e.getAttribute("data-ghostedit-elemtype")?"block":r.dom.isGhostBlock(e)?!1:(t=e.tagName.toLowerCase(),n.inout.handledtags[t]?n.inout.handledtags[t]:!1):!1}},n.paste={handle:function(e,o,s){return r.dom.isGhostBlock(e)&&r.dom.isGhostBlock(o)?(a.log(s),s.isfirst?n.paste.handleFirst(e,o,s):s.islast?n.paste.handleLast(e,o,s):(n.paste.split(e),!1)):t},handleFirst:function(e,t){return"p"===t.tagName.toLowerCase()||t.tagName===e.tagName?(a.log("paste (first):"),n.mozBrs.clear(t),o().removeDOMmarkers("ghostedit_paste_start"),t.innerHTML+="<span id='ghostedit_paste_start_range_start' class='t1'>&#x200b;</span>",document.createRange?r.selection.saved.data.collapseToStart().getNative().insertNode(r.dom.extractContent(t)):r.selection.saved.data.collapseToStart().getNative().pasteHTML(t.innerHTML),!0):!1},handleLast:function(e,t){return"p"===t.tagName.toLowerCase()||t.tagName===e.tagName?(a.log("paste (last):"),r.selection.saved.data.isCollapsed()&&(n.paste.split(e),r.selection.saved.data.restoreFromDOM("ghostedit_paste_start",!1),o().isSavedRange("ghostedit_paste_end")&&r.selection.saved.data.setEndToRangeEnd(o().restoreFromDOM("ghostedit_paste_end",!1))),n.mozBrs.clear(t),o().removeDOMmarkers("ghostedit_paste_end"),t.innerHTML+="<span id='ghostedit_paste_end_range_start'>&#x200b;</span>",document.createRange?r.selection.saved.data.collapseToEnd().getNative().insertNode(r.dom.extractContent(t)):r.selection.saved.data.collapseToEnd().getNative().pasteHTML(t.innerHTML),!0):!1},split:function(e,t){var a,s=!1;return t=t||r.selection.saved.data,t=t.clone().collapseToStart(),r.dom.isDescendant(e,document.getElementById("ghostedit_paste_start_range_start"))&&(s=!0),s&&o().removeDOMmarkers("ghostedit_paste_start"),a=n.split(e,t),s&&(a.block1.innerHTML+="<span id='ghostedit_paste_start_range_start' class='t2'>&#x200b;</span>",n.mozBrs.tidy(a.block1)),o().removeDOMmarkers("ghostedit_paste_end"),a.block2.innerHTML="<span id='ghostedit_paste_end_range_start'>&#x200b;</span>"+a.block2.innerHTML,n.mozBrs.tidy(a.block2),a}},n.isTextBlock=function(e){return r.dom.isGhostBlock(e)?"textblock"!==e.getAttribute("data-ghostedit-elemtype")?!1:!0:!1},n.isEmpty=function(e){var n,o,r,a;if(n=e.innerText||e.textContent,n&&n.length>1)return!1;if(r=e.getElementsByTagName("br"),o=e.getElementsByTagName("img"),0===r.length&&0===o.length)return!0;for(a=0;r.length>a;a+=1)if(r[a].MozDirty===t&&!/moz_dirty/.test(r[a].className))return!1;return!0},n.isFirst=function(e){var t,n;for(t=r.el.rootnode,n=0;t.getElementsByTagName("*").length>n;n+=1)if("textblock"===t.getElementsByTagName("*")[n].getAttribute("data-ghostedit-elemtype"))return t.getElementsByTagName("*")[n]===e?!0:!1},n.isLast=function(e){var t,n;for(t=r.el.rootnode,n=t.getElementsByTagName("*").length-1;n>0;n-=1)if("textblock"===t.getElementsByTagName("*")[n].getAttribute("data-ghostedit-elemtype"))return t.getElementsByTagName("*")[n]===e?!0:!1},n.count=function(){var e,t,n;for(e=r.el.rootnode,t=0,n=0;e.getElementsByTagName("*").length>n;n+=1)"textblock"===e.getElementsByTagName("*")[n].getAttribute("data-ghostedit-elemtype")&&(t+=1);return t},n.create=function(e,t,o){var a;return o||(r.blockElemId+=1,o="ghostedit_textblock_"+r.blockElemId),t=t&&(t.length&&t.length>0||t.nodeType)?t:"",a=document.createElement(e),a.id=o,t.nodeType?(t=r.dom.parse(t,{textnode:{clean:!0},tags:{b:{},i:{},u:{},strong:{},em:{},strike:{},br:{}}}),t&&a.appendChild(t)):a.innerHTML=t,a.setAttribute("data-ghostedit-iselem","true"),a.setAttribute("data-ghostedit-elemtype","textblock"),a.setAttribute("data-ghostedit-handler","textblock"),a.ondragenter=function(){return!1},a.ondragleave=function(){return!1},a.ondragover=function(){return!1},a.ondrop=function(e){var t,n;n=e.dataTransfer.getData("Text")||e.srcElement.id,t=document.getElementById(n),t.parentNode.insertBefore(t,this),r.image.focus(t)},a.onresizestart=function(e){return r.util.cancelEvent(e)},n.mozBrs.tidy(a),a},n.remove=function(e){var a,s,i,d,l,c;for(r.selection.save(),r.history.saveUndoState(),a="",a=e.innerHTML,s=r.el.rootnode,c=s.getElementsByTagName("*"),l=!1,d=c.length-1;d>=0;d-=1){if(l===!0&&"textblock"===c[d].getAttribute("data-ghostedit-elemtype")){i=c[d];break}c[d]===e&&(l=!0)}return n.isEmpty(i)?(s.removeChild(i),o().setCaretToStart(e).select(),r.selection.save(),r.history.saveUndoState(),t):(s.removeChild(e),o().setCaretToEnd(i).select(),r.selection.save(),i.innerHTML+="<span id='ghostedit_marker'>&#x200b;</span>"+a,n.mozBrs.tidy(i),o().selectNode("ghostedit_marker").deleteContents().select(),document.getElementById("ghostedit_marker")&&document.getElementById("ghostedit_marker").parentNode.removeChild(document.getElementById("ghostedit_marker")),r.selection.save(),r.history.saveUndoState(),t)},n.focus=function(e){return e&&1===e.nodeType&&"textblock"===e.getAttribute("data-ghostedit-elemtype")?(o().setCaretToEnd(e).select(),r.selection.save(),!0):!1},n.merge=function(e,t,a){var s,i,d,l;return a===!1?e:e===t?e:(s=e.getAttribute("data-ghostedit-elemtype"),i=t.getAttribute("data-ghostedit-elemtype"),"textblock"!==s||"textblock"!==i?!1:(e.innerHTML+="<span id='ghostedit_marker'>&#x200b;</span>"+t.innerHTML,d=t.parentNode,l=d.getAttribute("data-ghostedit-handler"),r.plugins[l].dom.removechild(d,t),n.mozBrs.tidy(e),o().selectNode("ghostedit_marker").select(),document.getElementById("ghostedit_marker").parentNode.removeChild(document.getElementById("ghostedit_marker")),e))},n.split=function(e,t){var a,s,i,d,l,c,u,g,f,p,m;if(m=!1,!t||!t.isLassoObject){if(r.selection.save(),"textblock"!==r.selection.saved.type)return!1;t=r.selection.saved.data,m=!0}return t=t.clone().collapseToStart(),s=n.selection.isAtStartOfTextBlock()===!0?!0:!1,i=n.selection.isAtEndOfTextBlock()===!0?!0:!1,a=s&&!i?"before":"after",d="before"===a||i?"p":n.selection.getStartTextBlockNode().tagName,n.mozBrs.tidy(e),s||i?l="":document.createRange?(c=o().selectNodeContents(e).setStartToRangeStart(t),l=c.getHTML(),c.deleteContents()):document.selection&&(c=o().selectNode(e),c.setStartToRangeEnd(t),l=c.getHTML(),c.getNative().text=""),(g=n.create(d,l))?(f=r.dom.getParentGhostBlock(e),p=f.getAttribute("data-ghostedit-handler"),(u=r.plugins[p].dom.addchild(f,a,e,g,{contentlength:l.length}))?(g.innerHTML="dummy",o().selectNode(g).select(),g.innerHTML=l,n.mozBrs.tidy(g),c="before"===a?o().setCaretToBlockStart(e):o().setCaretToBlockStart(g),m&&(c.select(),r.selection.save()),{block1:"before"===a?g:e,block2:"before"===a?e:g,caretposition:c}):!1):!1},n.mozBrs={checkifcontains:function(e){var n,o;for(n=e.getElementsByTagName("br"),o=0;n.length>o;o+=1)if(n[o].MozDirty!==t)return!0;return!1},insert:function(e){var t;t=document.createElement("br"),t.setAttribute("_moz_dirty",""),t.className="moz_dirty",e.appendChild(t)},clear:function(e){var n,o;for(n=e.getElementsByTagName("br"),o=0;n.length>o;o+=1)(n[o].MozDirty!==t||/moz_dirty/.test(n[o].className))&&(n[o].parentNode.removeChild(n[o]),o--)},tidy:function(e){n.mozBrs.clear(e),r.useMozBr&&n.mozBrs.insert(e)}},n.insert={character:function(e){"textblock"===r.selection.saved.type&&(r.selection.restore(),r.selection.savedRange.pasteText(e))},br:function(){var t,n,o;e.getSelection?(t=e.getSelection(),t.getRangeAt(0).collapse(!1),n=document.createElement("br"),n.id="newBr",t.getRangeAt(0).insertNode(n),t.getRangeAt(0).selectNode(n.parentNode),o=document.createRange(),o.setStartAfter(n),o.setEndAfter(n),t.removeAllRanges(),t.addRange(o),document.getElementById("newBr").removeAttribute("id")):document.selection&&(o=document.selection.createRange(),o.collapse(!1),o.pasteHTML("<br id='newBr' />"),o.moveToElementText(document.getElementById("newBr")),o.collapse(!1),o.select(),document.getElementById("newBr").removeAttribute("id"))}},n.format={init:function(){r.api.format=r.api.format||{},r.api.format.setStyle=function(e,t){n.format.formatSelected(n.format.setTagType,{tagname:e,newclass:t})},r.api.format.alignText=function(e){return/left|right|center|justify/.test(e)?(n.format.formatSelected(n.format.alignText,{alignDirection:e}),t):!1},r.api.format.bold=function(){n.format.formatSelected(n.format.bold)},r.api.format.italic=function(){n.format.formatSelected(n.format.italic)},r.api.format.underline=function(){n.format.formatSelected(n.format.underline)},r.api.format.strikethrough=function(){n.format.formatSelected(n.format.strikethrough)},r.api.format.textColor=function(e){n.format.formatSelected(n.format.textColor,{color:e})}},useCommand:function(e,t){document.execCommand(e,!1,t)},getNextNode:function(e){if(e.firstChild)return e.firstChild;for(;e;){if(e.nextSibling)return e.nextSibling;e=e.parentNode}},getNodesInRange:function(e){var t,o=e.getStartNode(),r=e.getEndNode(),a=e.getParentNode(),s=[];for(t=o.parentNode;t&&(s.push(t),t!==a);t=t.parentNode);for(s.reverse(),t=o;t&&(s.push(t),t!==r);t=n.format.getNextNode(t));return s},useCommandOnWord:function(e){var t,a;r.selection.savedRange.isCollapsed()&&n.selection.getStartTextBlockNode()&&(t=r.selection.savedRange.clone(),document.createRange&&(a=document.createElement("span"),a.id="ghostedit_marker",t.getNative().insertNode(a)),!document.createRange&&document.selection&&t.getNative().pasteHTML("<span id='ghostedit_marker'>z</span>"),t.selectNode("ghostedit_marker"),t=n.selection.extendtoword(t,!0),t.select()),n.format.useCommand(e),document.getElementById("ghostedit_marker")&&(o().selectNode("ghostedit_marker").select(),document.getElementById("ghostedit_marker").parentNode.removeChild(document.getElementById("ghostedit_marker"))),r.selection.save()},bold:function(){n.format.useCommand("bold")},italic:function(){n.format.useCommand("italic")},underline:function(){n.format.useCommand("underline")},strikethrough:function(){n.format.useCommand("strikethrough")},textColor:function(e){n.format.useCommand("foreColor",e)},formatSelected:function(e,t){var o,a,s,i,d,l,c;if(r.selection.save(),r.history.saveUndoState(),a=n.selection.getStartTextBlockNode(),s=n.selection.getEndTextBlockNode(),a&&s){for(o=a,d=!1;;){if(o===r.el.rootnode||null===o)break;if(n.isTextBlock(o)){if(o===s&&(d=!0),o=n.format.formatTextBlock(o,r.selection.saved.data.clone(),e,t),d)break;o=o.nextSibling?o.nextSibling:o.parentNode}else if(r.dom.isDescendant(o,s))o=r.dom.getFirstChildElement(o);else for(i=o,o=o.nextSibling?o.nextSibling:o.parentNode,c=i.getElementsByTagName("*"),l=0;c.length>l;l+=1)n.isTextBlock(c[l])&&n.format.formatTextBlock(c[l],r.selection.saved.data.clone(),e,t)}r.selection.save(),r.history.saveUndoState()}r.history.saveUndoState()},formatTextBlock:function(e,n,a,s){var i,d,l;return s||(s={}),s.textblock=e,n=n.clone(),i=o().setCaretToStart(e),d=o().setCaretToEnd(e),-1===n.compareEndPoints("EndToStart",i)||1===n.compareEndPoints("StartToEnd",d)?!1:(-1===n.compareEndPoints("StartToStart",i)&&n.setStartToRangeStart(i),1===n.compareEndPoints("EndToEnd",d)&&n.setEndToRangeEnd(d),r.selection.saved.data.clone().saveToDOM("ghostedit_format"),n.select(),l=a(s),o().restoreFromDOM("ghostedit_format").select(),r.selection.save(),l&&l.nodeType!==t?l:e)},alignText:function(e){for(var a=o().setToSelection().getParentElement();!r.dom.isGhostBlock(a);)if(a=a.parentNode,null===a)return!1;return n.isTextBlock(a)?(a.style.textAlign=e.alignDirection,t):!1},setTagType:function(e){var o,a,s,i,d,l;return o=e.textblock,a=e.tagname,s=e.newclass,n.isTextBlock(o)?(d="ghostedit_textblock_"+o.id.replace("ghostedit_textblock_",""),l=n.create(a),l.appendChild(r.dom.extractContent(o)),n.mozBrs.tidy(l),l.setAttribute("style",o.getAttribute("style")),s!==t&&(l.className=s),i=o.parentNode,o.id="",i.insertBefore(l,o),i.removeChild(o),l.id=d,l):!1}},r.api.plugin.register("textblock",n)}(window),function(e,t){var n={},o=e.lasso,r=e.ghostedit;n.enable=function(){return!0},n.dom={addchild:function(e,t,n,o){return"before"===t?e.insertBefore(o,n):null!==n.nextSibling?e.insertBefore(o,n.nextSibling):e.appendChild(o),!0},removechild:function(e,t){return e&&t?(e.removeChild(t),!0):!1}},n.selection={deleteContents:function(e,t){var n,a,s,i,d,l,c,u,g,f,p,m,v,h,y=!1,b=!1;if("textblock"!==r.selection.saved.type)return!1;for(v=r.selection.saved.data,p=e.childNodes,a=r.dom.getFirstChildGhostBlock(e),s=r.dom.getLastChildGhostBlock(e),i=o().setCaretToStart(a),d=o().setCaretToEnd(s),1!==v.compareEndPoints("StartToStart",i)?(y=!0,l=a):(l=v.getStartNode(),r.dom.isGhostBlock(l)||(l=r.dom.getParentGhostBlock(l))),-1!==v.compareEndPoints("EndToEnd",d)?(b=!0,c=s):(c=v.getEndNode(),r.dom.isGhostBlock(c)||(c=r.dom.getParentGhostBlock(c))),g=l;!r.dom.isChildGhostBlock(g,e);)g=r.dom.getParentGhostBlock(g);for(f=c;!r.dom.isChildGhostBlock(f,e);)f=r.dom.getParentGhostBlock(f);for(m=!1,n=0;p.length>n;n+=1)if(u=p[n],r.dom.isGhostBlock(u))if(h=u.getAttribute("data-ghostedit-handler"),u.id!==g.id){if(u.id===f.id){r.plugins[h].selection.deleteContents(u),m=!1;break}m&&(e.removeChild(p[n]),n--)}else r.plugins[h].selection.deleteContents(u),m=!0;return g.getAttribute("data-ghostedit-elemtype")===f.getAttribute("data-ghostedit-elemtype")&&(o().setToSelection().saveToDOM("ghostedit_container_deleteselection"),r.plugins[g.getAttribute("data-ghostedit-elemtype")].merge(g,f,t),o().restoreFromDOM("ghostedit_container_deleteselection").select()),r.dom.getFirstChildGhostBlock(e)||e.appendChild(r.plugins.textblock.create("p")),!0}},n.inout={importHTML:function(e){var t,o,a,s,i,d;if(!e||1>e.childNodes.length)return!1;for(t=n.create(),a=0;e.childNodes.length>a;a+=1)i=e.childNodes[a],(1===i.nodeType||3===i.nodeType)&&(d=3===i.nodeType?"#textnode":i.tagName.toLowerCase(),r.inout.importhandlers[d]?(o=r.inout.importhandlers[d].call(this,i),o&&r.dom.isGhostBlock(o)&&t.appendChild(o)):i.childNodes.length>0&&(s=i.childNodes.length,i.parentNode.insertBefore(r.dom.extractContent(i),i),i.parentNode.removeChild(i),a-=1));return r.dom.getFirstChildGhostBlock(t)||t.appendChild(r.plugins.textblock.create("p")),t},exportHTML:function(e){if(!e||!r.dom.isGhostBlock(e)||"container"!==e.getAttribute("data-ghostedit-elemtype"))return!1;var t,n,o,a,s=0,i="",d=0;for(s=0;e.childNodes.length>s;s+=1)t=r.dom.isGhostBlock(e.childNodes[s])?e.childNodes[s]:!1,t&&(a=t.getAttribute("data-ghostedit-handler"),a&&r.plugins[a]&&(n=r.plugins[a].inout.exportHTML(t),n&&(i+=n.content,d++),3>=d&&(o=i)));return{content:i,snippet:o}}},n.paste={handle:function(e,t){var a,s,i,d;if(!r.dom.isGhostBlock(e)||!r.dom.isGhostBlock(t))return!1;for(a=r.selection.saved.data,s=a.clone().collapseToStart().getParentElement(),a.saveToDOM("ghostedit_paste_start"),s===e&&(d=document.getElementById("ghostedit_paste_start_range_start"),s=r.dom.getPreviousSiblingGhostBlock(d)||d);s.parentNode!==e;)if(s=s.parentNode,null===s||!s.parentNode)return!0;return i=t.cloneNode(!0),o().removeDOMmarkers("ghostedit_paste_start"),i.innerHTML+="<span id='ghostedit_paste_start_range_start' class='t3'>&#x200b;</span>",n.dom.addchild(e,"after",s,i),d&&d.parentNode&&d.parentNode.removeChild(d),!0}},n.isChildGhostBlock=function(e,n){var o;if(!e)return!1;if(1!==e.nodeType)return!1;if(e.getAttribute("data-ghostedit-elemtype")===t)return!1;if(e.getAttribute("data-ghostedit-elemtype")===!1)return!1;if(null===e.getAttribute("data-ghostedit-elemtype"))return!1;for(o=0;n.length>o;o+=1)if(e===n[o])return!0;return!1},n.create=function(){var e;return e=document.createElement("div"),r.blockElemId+=1,e.id="ghostedit_container_"+r.blockElemId,e.setAttribute("data-ghostedit-iselem","true"),e.setAttribute("data-ghostedit-elemtype","container"),e.setAttribute("data-ghostedit-handler","container"),e},n.focus=function(e){var t,n;return e&&1===e.nodeType&&"container"===e.getAttribute("data-ghostedit-elemtype")?(t=r.dom.getFirstChildGhostBlock(e))?(n=t.getAttribute("data-ghostedit-handler"),r.plugins[n].focus(t),!0):!1:!1},r.api.plugin.register("container",n)}(window);