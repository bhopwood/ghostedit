/*! GhostEdit WYSIWYG editor Copyright (c) 2010-2012 Nico Burns

Description:       An open source JavaScript WYSIWYG editor focused on usability
Homepage:          http://ghosted.it
License:           LGPL
Author:            Nico Burns <nico@nicoburns.com>
Version:           1.0rc1
Release Date:      2012-12-13
Browser Support:   Internet Explorer 6+, Mozilla Firefox 3.6+, Google Chrome, Apple Safari (latest), Opera (latest)
*/
(function(e,t){var n={focusedlink:!1,el:{}};n.enable=function(){ghostedit.event.addListener("preundo",function(){n.unfocus()}),ghostedit.event.addListener("preredo",function(){n.unfocus()}),ghostedit.event.addListener("import:after",function(){n.event.postimport()}),ghostedit.event.addListener("ui:update",function(){n.ui.update()}),ghostedit.inout.registerimporthandler(ghostedit.plugins.textblock.inout.importHTML,"a"),ghostedit.plugins.textblock.inout.parserules.tags.a={attributes:["href"]},ghostedit.api.link=ghostedit.api.link||{},ghostedit.api.link.create=function(){return n.create()}},n.ghostevent=function(e,t,n,r){return!1},n.event={urlBoxKeypress:function(t){t=e.event!=null?e.event:t;var r=t.keyCode!=null?t.keyCode:t.charCode;switch(r){case 13:return n.create(),ghostedit.ui.modal.hide(),!1}return!0},postimport:function(e){if(!e||!e.editdiv)return!1;var t=e.editdiv.getElementsByTagName("a");for(i=0;i<t.length;i+=1)t[i].setAttribute("data-ghostedit-elemtype","link"),t[i].setAttribute("data-ghostedit-handler","link");return!0},insertButtonClick:function(){ghostedit.selection.savedRange.isCollapsed()&&(range=ghostedit.selection.savedRange.clone(),range=ghostedit.textblock.selection.extendtoword(range,!0),range.select(),ghostedit.selection.save()),ghostedit.selection.savedRange.isCollapsed()?document.createRange||document.selection&&(ghostedit.selection.savedRange.getNative().pasteHTML("<a id='ghostedit_newlink' href='http://'>Link Text</a>"),lasso().selectNodeContents("ghostedit_newlink").select(),document.getElementById("ghostedit_newlink").id=""):(n.create("http://"),ghostedit.selection.save(),n.focusedlink.href="http://",ghostedit.ui.toolbar.enabletab("link"),ghostedit.ui.toolbar.showtab("link"),document.getElementById("ghostedit_toolbar_linkurl").focus(),ghostedit.selection.save())}},n.selection={deleteContents:function(){return!1}},n.ui={update:function(){var e,t,r=!1;for(t=0;t<ghostedit.selection.nodepath.length;t++)e=ghostedit.selection.nodepath[t],e.tagName.toLowerCase()==="a"&&(r=e);r?r!=n.focusedlink&&n.focus(r):n.focusedlink&&n.unfocus()},show:function(e){var t,r,i;n.ui.hide(),t=document.createElement("span"),t.className="ghostedit_focusedlinkbox",t.id="ghostedit_focusedlinkbox",t.style.top=e.offsetTop+e.offsetHeight-1+"px",i=e.getClientRects()[e.getClientRects().length-1].left,t.style.left=i-ghostedit.editdiv.getBoundingClientRect().left+"px",r=document.createElement("a"),r.style.cursor="pointer",r.style.color="#333",r.innerHTML="<b>&#215;</b>&nbsp;remove&nbsp;link</a>",t.appendChild(r),ghostedit.contextuallayer.appendChild(t),t.style.MozUserSelect="none",t.contentEditable=!1,t.unselectable="on",t.onmousedown=function(e){return ghostedit.util.cancelEvent(e)},t.ondragstart=function(e){return ghostedit.util.cancelEvent(e)},t.ondraggesture=function(e){return ghostedit.util.cancelEvent(e)},t.onclick=function(e){return ghostedit.util.cancelEvent(e)},t.ondblclick=function(e){return ghostedit.util.cancelEvent(e)},t.onresizestart=function(e){return ghostedit.util.cancelEvent(e)},t.oncontrolselect=function(e){return ghostedit.util.cancelAllEvents(e)},ghostedit.util.addEvent(r,"click",ghostedit.util.preparefunction(n.remove,null,e)),n.el.focusedbox=t,n.el.focusedboxa=r},hide:function(){if(!n.el.focusedbox)return;ghostedit.contextuallayer.removeChild(n.el.focusedbox),n.el.focusedbox=null,n.el.focusedboxa=null}},n.create=function(e){ghostedit.history.saveUndoState();var t,n,r,i;typeof e=="undefined"&&(e="http://"),document.execCommand("CreateLink",!1,e),r=ghostedit.editdiv.getElementsByTagName("a");for(i=0;i<r.length;i+=1)r[i].setAttribute("data-ghostedit-elemtype","link"),r[i].setAttribute("data-ghostedit-handler","link");ghostedit.selection.save(),ghostedit.history.saveUndoState()},n.focus=function(e){var t,r,i,s,o;n.focusedlink=e,n.ui.show(e),ghostedit.event.trigger("ui:newcontext",{context:"link"})},n.unfocus=function(){if(n.focusedlink===!1)return;n.ui.hide(),n.focusedlink=!1},n.remove=function(e){var t,r;e=e||n.focusedlink;if(!ghostedit.dom.isGhostBlock(e)||e.tagName.toLowerCase()!=="a")return!1;if(ghostedit.selection.saved.type!=="textblock")return!1;console.log("test"),ghostedit.selection.saved.data.saveToDOM(),r=ghostedit.dom.extractContent(e),e.parentNode.insertBefore(r,e),e.parentNode.removeChild(e),ghostedit.selection.saved.data.restoreFromDOM().select(),ghostedit.selection.save()},n.updateurl=function(e){n.focusedlink!=0&&n.focusedlink.href!=e&&(n.focusedlink.href=e,n.focusedlink.title=e,ghostedit.ui.message.show("URL updated to '"+e+"'",2,"success"))},n.open=function(){n.focusedlink!=0&&e.open(n.focusedlink.href)},ghostedit.api.plugin.register("link",n)})(window);