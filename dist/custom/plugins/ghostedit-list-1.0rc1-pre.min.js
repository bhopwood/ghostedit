/*! GhostEdit WYSIWYG editor Copyright (c) 2010-2012 Nico Burns

Description:       An open source JavaScript WYSIWYG editor focused on usability
Homepage:          http://ghosted.it
License:           LGPL
Author:            Nico Burns <nico@nicoburns.com>
Version:           1.0rc1-pre
Release Date:      2012-12-27
Browser Support:   Internet Explorer 6+, Mozilla Firefox 3.6+, Google Chrome, Apple Safari (latest), Opera (latest)
*/
(function(e,t){var n={elemid:0,itemelemid:0},r=e.lasso,i=e.ghostedit;n.enable=function(){i.event.addListener("postpaste",function(){var e,t,r,s,o;s=[],t=i.el.rootnode.getElementsByTagName("ul");for(e=0;e<t.length;e++)s.push(t[e]);r=i.el.rootnode.getElementsByTagName("ol");for(e=0;e<r.length;e++)s.push(r[e]);for(e=0;e<s.length;e++){o=s[e];if(!o.parentNode)continue;n.tidy(o)}}),i.inout.registerimporthandler(n.inout.importHTML,"ol","ul","li"),i.api.list=i.api.list||{},i.api.list.toggle=function(e){n.toggle(e)}},n.dom={addchild:function(e,t,r,s,o){var u,a,f=!1,l=!1,c,h;o&&o.contentlength!==!1&&(l=o.contentlength<1?!0:!1),e.getAttribute("data-ghostedit-elemtype")==="listitem"&&(e=i.dom.getParentGhostBlock(e));if(e.getAttribute("data-ghostedit-elemtype")!=="list")return!1;c=r;while(c.getAttribute("data-ghostedit-elemtype")!=="listitem"){c=i.dom.getParentGhostBlock(c);if(c===null)return!1}return l&&i.dom.getNextSiblingGhostBlock(c)===!1&&i.plugins.textblock.isEmpty(r)&&(u=i.dom.getParentGhostBlock(e),h=u.getAttribute("data-ghostedit-handler"),f=i.plugins[h].dom.addchild(u,"after",e,s)),f?(e.removeChild(c),f):(s.getAttribute("data-ghostedit-elemtype")==="textblock"?(a=document.createElement("li"),n.itemelemid+=1,a.id="ghostedit_listitem_"+n.itemelemid,a.setAttribute("data-ghostedit-elemtype","listitem"),a.setAttribute("data-ghostedit-handler","list"),a.appendChild(s)):a=s,t==="before"?e.insertBefore(a,c):c.nextSibling!==null?e.insertBefore(a,c.nextSibling):e.appendChild(a),!0)},removechild:function(e,t){e&&e.getAttribute("data-ghostedit-elemtype")==="listitem"&&(t=e,e=i.dom.getParentGhostBlock(e));if(!e||!t)return!1;if(e.getAttribute("data-ghostedit-elemtype")!=="list")return!1;while(t.getAttribute("data-ghostedit-elemtype")!=="listitem"){t=i.dom.getParentGhostBlock(t);if(t===null)return!1}return t.parentNode!==e?!1:(e.removeChild(t),!0)},deleteevent:function(e,t,r){var s,o,u;u=e.getAttribute("data-ghostedit-elemtype");if(u==="list")return t==="ahead"||t==="behind"?(s=t==="ahead"?i.dom.getLastChildGhostBlock(e):i.dom.getFirstChildGhostBlock(e),n.ghostevent("delete",s,t,r)):!1;if(u==="listitem")return t==="ahead"||t==="behind"?(s=i.dom.getFirstChildGhostBlock(e),o=i.plugins.textblock.dom.deleteevent(s,t,r)):t==="top"?o=i.event.sendBackwards("delete",e,r):t==="bottom"&&(o=i.event.sendForwards("delete",e,r)),o}},n.selection={deleteContents:function(e,t){var s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;m=!1,g=!1;if(!n.isList(e))return n.isListItem(e)?i.plugins.textblock.selection.deleteContents(i.dom.getFirstChildGhostBlock(e)):!1;if(i.selection.saved.type!=="textblock")return;v=i.selection.saved.data.clone(),c=e.childNodes,y=i.dom.getFirstChildGhostBlock(e),b=i.dom.getLastChildGhostBlock(e),p=r().setCaretToStart(y),d=r().setCaretToEnd(b),v.compareEndPoints("StartToStart",p)!==1?(m=!0,o=y):(o=v.getStartNode(),i.dom.isGhostBlock(o)||(o=i.dom.getParentGhostBlock(o))),v.compareEndPoints("EndToEnd",d)!==-1?(g=!0,u=b):(u=v.getEndNode(),i.dom.isGhostBlock(u)||(u=i.dom.getParentGhostBlock(u))),a=o;while(!i.dom.isChildGhostBlock(a,e))a=i.dom.getParentGhostBlock(a);l=u;while(!i.dom.isChildGhostBlock(l,e))l=i.dom.getParentGhostBlock(l);h=m;for(s=0;s<c.length;s+=1){f=c[s];if(!i.dom.isGhostBlock(f))continue;w=f.getAttribute("data-ghostedit-handler");if(!m&&f.id===a.id){i.plugins[w].selection.deleteContents(f),h=!0;if(f.id===l.id)break;continue}if(!g&&f.id===l.id){i.plugins[w].selection.deleteContents(f),h=!1;break}h&&(v.saveToDOM("seldelete-midlist"),e.removeChild(c[s]),v.restoreFromDOM("seldelete-midlist"),s--)}return!m&&!g&&a.getAttribute("data-ghostedit-elemtype")===l.getAttribute("data-ghostedit-elemtype")&&(i.plugins[a.getAttribute("data-ghostedit-handler")].merge(a,l,t),i.dom.getParentGhostBlock(l)||r().setToSelection().collapseToStart().select()),i.dom.getFirstChildGhostBlock(e)||e.appendChild(n.createItem("p")),!0}},n.inout={importHTML:function(e){var t,r,i,s,o;if(!e||!e.tagName)return!1;switch(e.tagName.toLowerCase()){case"ol":case"ul":return n.inout.importList(e);case"li":t=n.create("ul"),t.setAttribute("data-ghostedit-importinfo","wasinline"),r=0,i=e;do{o=n.inout.importListItem(i);if(!o)break;r+=1,t.appendChild(o),s=i,i=i.nextSibling,r>1&&s.parentNode.removeChild(s)}while(i&&i.nodeType===1&&i.tagName.toLowerCase()==="li");return r>0?t:!1}},exportHTML:function(e){if(!e||!i.dom.isGhostBlock(e))return!1;var t="",r,s,o,u;switch(e.getAttribute("data-ghostedit-elemtype")){case"list":r=i.dom.getFirstChildGhostBlock(e);if(!r)return!1;do o=n.inout.exportHTML(r),o&&(t+=o.content),r=i.dom.getNextSiblingGhostBlock(r);while(r);if(t.length<1)return!1;return s=e.tagName.toLowerCase()==="ol"?"ol":"ul",t="<"+s+">"+t+"</"+s+">",{content:t};case"listitem":u=i.dom.getFirstChildGhostBlock(e);if(!u)return!1;o=i.plugins.textblock.inout.exportHTML(u),o&&(t+=o.content);if(t.length<1)return!1;return t="<li>"+t+"</li>",{content:t}}},importList:function(e){var t,r,s,o,u;if(!e||!e.tagName)return!1;u=e.tagName.toLowerCase();if(u!=="ul"&&u!=="ol")return!1;r=n.create(u);if(e.childNodes&&e.childNodes.length)for(t=0;t<e.childNodes.length;t+=1){o=e.childNodes[t];if(o.nodeType!==1||o.tagName.toLowerCase()!=="li")continue;s=n.inout.importListItem(o),s&&i.dom.isGhostBlock(s)&&r.appendChild(s)}return i.dom.getFirstChildGhostBlock(r)||r.appendChild(n.createItem("p")),r},importListItem:function(e){var t,r,s=!1;return!e||!e.tagName||e.tagName.toLowerCase()!=="li"?!1:(t=n.createItem(),r=i.dom.getFirstChildElement(e),i.plugins.textblock.inout.isHandleableNode(r)==="block"?s=i.plugins.textblock.inout.importHTML(r):(s=document.createElement("p"),s.innerHTML=e.innerHTML,s=i.plugins.textblock.inout.importHTML(s)),s?t.appendChild(s):t.appendChild(i.plugins.textblock.create("p")),t)}},n.paste={handle:function(e,t,s){var o,u,a,f,l,c,h,p,d,v,m,g,y;if(!i.dom.isGhostBlock(e)||!i.dom.isGhostBlock(t))return;if(t.tagName.toLowerCase()!=="ol"&&t.tagName.toLowerCase()!=="ul")return!1;if(t.tagName!==e.tagName){o=i.selection.saved.data.clone().collapseToStart().getParentNode();while(!i.dom.isChildGhostBlock(o,e))o=i.dom.getParentGhostBlock(o);u=n.split(e,"after",o);switch(u){case!1:return!0;case"atverystart":p=i.dom.getPreviousSiblingGhostBlock(e),d=e;break;case"atveryend":p=e,d=i.dom.getNextSiblingGhostBlock(e);break;default:p=u.block1,d=u.block2}return r().removeDOMmarkers("ghostedit_paste_start"),r().removeDOMmarkers("ghostedit_paste_end"),p.innerHTML+="<span id='ghostedit_paste_start_range_start'>&#x200b;</span>",d.innerHTML="<span id='ghostedit_paste_end_range_start'>&#x200b;</span>"+d.innerHTML,!1}v=i.selection.saved.data.clone().collapseToStart().getParentNode();while(!i.dom.isGhostBlock(v))v=i.dom.getParentGhostBlock(v);m=i.selection.saved.data.clone().collapseToEnd().getParentNode();while(!i.dom.isGhostBlock(v))v=i.dom.getParentGhostBlock(v);if(s.isfirst){a=i.dom.getFirstChildGhostBlock(t),f=i.dom.getFirstChildGhostBlock(a),c=v,l=i.dom.getParentGhostBlock(c);if(f.tagName===c.tagName){c.innerHTML+=f.innerHTML,i.plugins.textblock.mozBrs.tidy(c),t.removeChild(a);if(!i.dom.getLastChildGhostBlock(t))return s.islast&&(h=i.dom.getNextSiblingGhostBlock(l),h&&(r().removeDOMmarkers("ghostedit_paste_start"),c.innerHTML=c.innerHTML+"<span id='ghostedit_paste_start_range_start'>&#x200b;</span>"+i.dom.getFirstChildGhostBlock(h).innerHTML,i.plugins.textblock.mozBrs.tidy(c),h.parentNode.removeChild(h))),!0;r().removeDOMmarkers("ghostedit_paste_start"),c.innerHTML+="<span id='ghostedit_paste_start_range_start'>&#x200b;</span>",i.plugins.textblock.mozBrs.tidy(c),v=l}}s.islast&&i.dom.getLastChildGhostBlock(t)&&(a=i.dom.getLastChildGhostBlock(t),f=i.dom.getFirstChildGhostBlock(a),c=m,f.tagName===c.tagName&&(r().removeDOMmarkers("ghostedit_paste_end"),c.innerHTML=f.innerHTML+"<span id='ghostedit_paste_end_range_start'>&#x200b;</span>"+c.innerHTML,t.removeChild(a),i.plugins.textblock.mozBrs.tidy(c))),o=v,g=y=i.dom.getFirstChildGhostBlock(t);while(y=i.dom.getFirstChildGhostBlock(t))n.dom.addchild(e,"after",o,y),o=y;return s.isfirst||(r().removeDOMmarkers("ghostedit_paste_start"),o.innerHTML+="<span id='ghostedit_paste_start_range_start'>&#x200b;</span>",i.plugins.textblock.mozBrs.tidy(o)),s.islast||(r().removeDOMmarkers("ghostedit_paste_end"),m.innerHTML=m.innerHTML+"<span id='ghostedit_paste_end_range_start'>&#x200b;</span>"),!0}},n.isList=function(e){var t;return i.dom.isGhostBlock(e)?(t=e.tagName.toLowerCase(),t!=="ul"&&t!=="ol"?!1:!0):!1},n.isListItem=function(e){var t;return i.dom.isGhostBlock(e)?(t=e.tagName.toLowerCase(),t!=="li"?!1:!0):!1},n.create=function(e){var t;return e.toLowerCase()!=="ol"&&(e="ul"),t=document.createElement(e),i.blockElemId+=1,t.id="ghostedit_list_"+i.blockElemId,t.setAttribute("data-ghostedit-iselem","true"),t.setAttribute("data-ghostedit-elemtype","list"),t.setAttribute("data-ghostedit-handler","list"),t},n.createItem=function(e){var t;return t=document.createElement("li"),i.blockElemId+=1,t.id="ghostedit_list_item_"+i.blockElemId,t.setAttribute("data-ghostedit-iselem","true"),t.setAttribute("data-ghostedit-elemtype","listitem"),t.setAttribute("data-ghostedit-handler","list"),e&&t.appendChild(i.plugins.textblock.create(e)),t},n.remove=function(e){var t,n;return t=i.dom.getParentGhostBlock(e),n=t.getAttribute("data-ghostedit-handler"),i.plugins[n].dom.removechild(t,e)},n.focus=function(e){var t,n;return!e||e.nodeType!==1||e.getAttribute("data-ghostedit-elemtype")!=="list"?!1:(t=i.dom.getFirstChildGhostBlock(e),t?(t=i.dom.getFirstChildGhostBlock(t),t?(n=t.getAttribute("data-ghostedit-handler"),i.plugins[n].focus(t),!0):!1):!1)},n.merge=function(e,t,r){var s;if(e===t)return e;if(!n.isList(e)||!n.isList(t))return n.isListItem(e)&&n.isListItem(t)?n.mergeItems(e,t,r):!1;if(e.tagName.toLowerCase()!==t.tagName.toLowerCase())return!1;while(s=i.dom.getFirstChildGhostBlock(t))e.appendChild(s);return n.remove(t),e},n.mergeItems=function(e,t,r){var s,o,u;return r===!1?e:e===t?e:!n.isListItem(e)||!n.isListItem(t)?!1:(s=i.dom.getFirstChildGhostBlock(e),o=i.dom.getFirstChildGhostBlock(t),!s||!o?!1:(u=i.plugins.textblock.merge(s,o),u))},n.split=function(e,t,r){var s,o,u,a,f,l;if(!i.dom.isGhostBlock(e)||!i.dom.isChildGhostBlock(r,e))return!1;t!=="before"&&(t="after"),s=i.dom.getFirstChildGhostBlock(e),o=i.dom.getLastChildGhostBlock(e);if(t==="before"&&s===r)return"atverystart";if(t==="after"&&o===r)return"atveryend";a=r,u=n.create(e.tagName.toLowerCase()),f=i.dom.getParentGhostBlock(e),l=f.getAttribute("data-ghostedit-handler");if(t==="before"){a=s;while(a){if(a===r)break;u.appendChild(a),a=i.dom.getFirstChildGhostBlock(e)}}else{a=i.dom.getNextSiblingGhostBlock(r);while(a)u.appendChild(a),a=i.dom.getNextSiblingGhostBlock(r)}return i.plugins[l].dom.addchild(f,t,e,u),t==="before"?{block1:u,block2:e}:{block1:e,block2:u}},n.toggle=function(e){var t,s,o,u,a,f,l,c,h;e=e==="ordered"?"ol":"ul",s=!1,h=!1,a=!1;for(t=0;t<i.selection.nodepath.length;t++){l=i.selection.nodepath[t];switch(l.getAttribute("data-ghostedit-elemtype")){case"list":s=!0,o=l;break;case"textblock":h=!0,u=l;break;case"container":a=!0,f=l}}return i.selection.savedRange.saveToDOM().select(),h&&!s?(n.convertTextblock(u,e),c=r().restoreFromDOM(),c&&c.select(),i.selection.save(),!0):s?(n.convertList(o,e),c=r().restoreFromDOM(),c&&c.select(),i.selection.save(),!0):a?(n.convertContainerContents(f,e),c=r().restoreFromDOM(),c&&c.select(),i.selection.save(),!0):!1},n.convertTextblock=function(e,t){var s,o,u,a,f;return s=n.create(t),u=e.tagName.toLowerCase(),o=n.createItem(),s.appendChild(o),a=i.dom.getParentGhostBlock(e),f=a.getAttribute("data-ghostedit-handler"),i.plugins[f].dom.addchild(a,"before",e,s),o.appendChild(e),n.tidy(s),r().setCaretToEnd(e).select(),i.selection.save(),e},n.convertList=function(e,t){var s,o=[],u,a=!1,f=!1,l,c,h=[],p=[],d=[],v,m,g;u=i.dom.getFirstChildGhostBlock(e);if(!u)return n.remove(e),!0;i.selection.savedRange.restoreFromDOM("",!1);do v=r().setCaretToEnd(u).compareEndPoints("StartToStart",i.selection.savedRange),v=v>=0?!0:!1,m=r().setCaretToStart(u).compareEndPoints("EndToEnd",i.selection.savedRange),m=m<=0?!0:!1,v?v&&m?p.push(u):d.push(u):h.push(u);while(u=i.dom.getNextSiblingGhostBlock(u));l=i.dom.getParentGhostBlock(e),c=l.getAttribute("data-ghostedit-handler");if(d.length>0){f=n.create(e.tagName);for(s=0;s<d.length;s++)f.appendChild(d[s]);i.plugins[c].dom.addchild(l,"after",e,f)}g=e;if(e.tagName.toLowerCase()===t)for(s=0;s<p.length;s++)u=i.dom.getFirstChildGhostBlock(p[s]),u&&(i.plugins[c].dom.addchild(l,"after",g,u),g=u),e.removeChild(p[s]);else{a=n.create(t);for(s=0;s<p.length;s++)a.appendChild(p[s]);i.plugins[c].dom.addchild(l,"after",e,a)}return h.length===0&&(n.remove(e),e=!1),e&&(n.tidy(e),o.push(e)),a&&(n.tidy(a),o.push(a)),f&&(n.tidy(f),o.push(f)),o},n.convertContainerContents=function(e,t){var s,o,u=[],a,f;o=i.dom.getFirstChildGhostBlock(e);do{a=r().setCaretToEnd(o).compareEndPoints("StartToStart",i.selection.savedRange),a=a>=0?!0:!1,f=r().setCaretToStart(o).compareEndPoints("EndToEnd",i.selection.savedRange),f=f<=0?!0:!1;if(a&&f)u.push(o);else if(!f)break}while(o=i.dom.getNextSiblingGhostBlock(o));for(s=0;s<u.length;s++){o=u[s];switch(o.getAttribute("data-ghostedit-elemtype")){case"list":o.tagName.toLowerCase()!==t&&n.convertList(o,t);break;case"textblock":n.convertTextblock(o,t)}}return!0},n.tidy=function(e){var t,r,s,o;return s=i.dom.getFirstChildGhostBlock(e),s?(t=i.dom.getPreviousSiblingGhostBlock(e),o=n.merge(t,e),o?(n.focus(o),i.selection.save(),n.tidy(o),!0):(r=i.dom.getNextSiblingGhostBlock(e),o=n.merge(e,r),o?(n.focus(o),i.selection.save(),n.tidy(o),!0):!0)):(n.remove(e),!0)},n.applydropevents=function(e){e.ondragenter=function(){return!1},e.ondragleave=function(){return!1},e.ondragover=function(){return!1},e.ondrop=function(e){var t,n;n=e.dataTransfer.getData("text/plain")||e.srcElement.id,t=document.getElementById(n),t.parentNode.insertBefore(t,this),i.image.focus(t),i.util.cancelEvent(e)},e.onresizestart=function(e){return i.util.cancelEvent(e)}},i.api.plugin.register("list",n)})(window);