/*! GhostEdit WYSIWYG editor Copyright (c) 2010-2012 Nico Burns

Description:       An open source JavaScript WYSIWYG editor focused on usability
Homepage:          http://ghosted.it
License:           LGPL
Author:            Nico Burns <nico@nicoburns.com>
Version:           1.0rc1-pre
Release Date:      2012-12-16
Browser Support:   Internet Explorer 6+, Mozilla Firefox 3.6+, Google Chrome, Apple Safari (latest), Opera (latest)
*/
(function(e,t){var n={elemid:0,focusedimage:null,justResized:!1,originalMouseX:null,originalMouseY:null,buttons:[],el:{}},r=e.ghostedit;n.enable=function(){r.event.addListener("history:undo:before",function(){n.unfocus()}),r.event.addListener("history:redo:before",function(){n.unfocus()}),r.event.addListener("history:undo:after",function(){n.applyeventlisteners()}),r.event.addListener("history:redo:after",function(){n.applyeventlisteners()}),r.event.addListener("clipboard:paste:after",function(){n.applyeventlisteners()}),r.event.addListener("selection:change",function(){r.selection.saved.type!=="image"&&n.ui.hide()}),r.event.addListener("ui:newcontext",function(e){var t=e.context;switch(t){case"image":case"help":case"save":return}n.unfocus()}),r.inout.registerimporthandler(n.inout.importHTML,"img"),r.options.image||(r.options.image={}),r.options.image.disableresize||(r.options.image.disableresize=!1),r.options.image.flexibleimages||(r.options.image.flexibleimages=!1);var e=document.createElement("form");e.id="ghostedit_image_focusform",e.style.cssText="margin:0px;padding:0px;height:0px;width:0px;overflow:hidden;line-height: 0px";var t=document.createElement("textarea");t.id="ghostedit_image_keycapturearea",t.onkeypress=r.util.cancelEvent,t.onkeydown=n.event.keydown,n.el.keycapture=t,e.appendChild(t),r.wrapdiv.appendChild(e),r.api.image=r.api.image||{},r.api.image.updatealttext=function(e){return n.updatealttext(e)}},n.event={keydown:function(t){t=e.event!==null?e.event:t;var i=t.keyCode!==null?t.keyCode:t.charCode;switch(i){case 8:case 46:n.remove(t);break;case 90:t.ctrlKey&&r.history.undo();break;case 89:t.ctrlKey&&r.history.redo();break;case 37:n.move.align("left",t);break;case 38:n.move.up(t);break;case 39:n.move.align("right",t);break;case 40:n.move.down(t)}return r.util.cancelEvent(t)}},n.selection={compare:function(e,t){return!e||!t?!1:e===t?!0:!1},restore:function(e){return!e||!e.tagName||e.tagName.toLowerCase()!=="img"?!1:(n.focus(e),!0)},deleteContents:function(){return!0}},n.inout={importHTML:function(e){var t,i,s,o;return t=n.create(e.src),t?(e.className.length>0&&!/ghostedit/.test(e.className)&&(t.className=e.className),t.alt=e.alt,t.title=e.title,i=t.width,s=t.height,t.naturalWidth=t.naturalWidth||i,t.naturalHeight=t.naturalHeight||s,t.setAttribute("data-ghostedit-nativewidth",i),t.setAttribute("data-ghostedit-nativeheight",s),o=r.wrapdiv.offsetWidth,r.options.image.flexibleimages||(e.style.width.replace("px","")>0&&e.style.width.replace("px","")<o?t.style.width=e.style.width:t.style.width="200px",t.style.height=t.style.width.replace("px","")/i*s),t.style.cssFloat=e.style.cssFloat,t.style.styleFloat=e.style.styleFloat,t.style.clear=e.style.clear,e.style.cssFloat==="right"||e.style.styleFloat==="right"?(t.style.marginLeft="20px",t.style.marginRight="0px"):(t.style.marginLeft="0px",t.style.marginRight="20px"),t):!1},exportHTML:function(e){if(!e||!r.dom.isGhostBlock(e)||e.getAttribute("data-ghostedit-elemtype")!=="image")return!1;var t="",n;return n=e,t+="<img src='"+n.src.toString()+"' alt='"+n.alt.toString()+"' title='"+n.title.toString()+"' ",t+="style='",r.options.image.flexibleimages||(t+="width:"+n.offsetWidth.toString()+"px;height; "+n.offsetHeight+"px;"),n.style.styleFloat==="left"||n.style.cssFloat==="left"?t+="float:left;clear:left;margin-right: 20px;":t+="float:right;clear:right;margin-left: 20px;",n.style.clear!==""&&(t+="clear:"+n.style.clear),t+="'",n.className.length>0&&!/ghostedit/.test(n.className)&&(t+=" class='"+n.className+"'"),t+=" />",{content:t}}},n.ghostevent=function(e){if(e==="delete")return!1},n.move={align:function(e,t){var i;return e!=="left"&&e!=="right"?r.util.cancelAllEvents(t):r.selection.saved.type!=="image"?r.util.cancelAllEvents(t):(r.history.saveUndoState(),i=r.selection.saved.data,i.style.styleFloat=e,i.style.cssFloat=e,i.style.marginRight=e==="left"?"20px":"0px",i.style.marginLeft=e==="left"?"0px":"20px",n.focus(i),r.history.saveUndoState(),r.util.cancelAllEvents(t))},up:function(e){var t,i,s,o,u,a;return r.history.saveUndoState(),n.focusedimage!==null&&(t=n.focusedimage,s=t.offsetLeft,i=t.offetTop,a=r.dom.getPreviousSiblingGhostBlock(t),a&&(o=r.dom.getParentGhostBlock(a),u=o.getAttribute("data-ghostedit-handler"),r.plugins[u].dom.addchild(o,"before",a,t)),s===t.offsetLeft&&t.offsetTopBefore===t.offsetTop?t.style.clear="":t.style.clear="",n.focus(n.focusedimage)),r.history.saveUndoState(),r.util.cancelAllEvents(e)},down:function(e){var t,i,s,o,u,a;return r.history.saveUndoState(),n.focusedimage!==null&&(t=n.focusedimage,o=t.offsetLeft,u=t.offetTop,a=r.dom.getNextSiblingGhostBlock(t),a&&(i=r.dom.getParentGhostBlock(a),s=i.getAttribute("data-ghostedit-handler"),r.plugins[s].dom.addchild(i,"after",a,t)),o===t.offsetLeft&&t.offsetTopBefore===t.offsetTop?t.style.clear="":t.style.clear="",n.focus(n.focusedimage)),r.history.saveUndoState(),r.util.cancelAllEvents(e)}},n.setClear=function(e){r.selection.save(),r.history.saveUndoState();var t,n,i;n=r.textblock.selection.getStartTextBlockNode(),i=r.textblock.selection.getEndTextBlockNode();if(n&&i){t=n;do{t.getAttribute("data-ghostedit-elemtype").toLowerCase()==="textblock"&&(n.style.clear=e);if(!t.nextSibling||t.id===i.id)break;t=t.nextSibling}while(!0)}t=n;while(t.previousSibling&&t.previousSibling.getAttribute("data-ghostedit-elemtype")==="image")t=t.previousSibling,t.style.clear=e;document.getElementById("ghostedit_toolbar_clearselect").value=e,r.selection.save(),r.history.saveUndoState()},n.remove=function(t){r.history.saveUndoState();if(n.focusedimage!==null){var i=n.focusedimage;n.unfocus(),i.parentNode&&i.parentNode.removeChild(i)}return t&&t.preventDefault?t.stopPropagation():e.event.cancelBubble!==null&&(e.event.cancelBubble=!0),r.history.saveUndoState(),!1},n.refocus=function(){var e=n.focusedimage;n.unfocus(),n.focus(e)},n.unfocus=function(){n.resize.end(),n.focusedimage=null;if(r.selection.saved.type!=="image")return!1;var e=r.selection.saved.data;n.ui.hide(e),r.selection.clear(),r.selection.save()},n.updatealttext=function(e){n.focusedimage!==!1&&n.focusedimage.alt!==e&&(n.focusedimage.alt=e,n.focusedimage.title=e,r.event.trigger("ui:message",{message:"Image description updated to '"+e+"'",time:2,color:"success"}))},n.focus=function(e,t){var i,s,o,u,a,f,l;n.unfocus();if(r.isEditing===!0&&n.focusedimage===null){l=e.id.replace("ghostedit_image_",""),u=document.createElement("div"),u.className="ghostedit_image_border",u.id="ghostedit_image_border_"+l,u.style.top=e.offsetTop+"px",u.style.left=e.offsetLeft+"px",u.style.width=e.offsetWidth-6+"px",u.style.height=e.offsetHeight-6+"px",r.contextuallayer.appendChild(u),s=document.getElementById("ghostedit_image_resizehandle_"+l),s&&r.contextuallayer.removeChild(s),r.options.image.disableresize||(o=document.createElement("span"),o.className="ghostedit_image_resizehandle",o.id="ghostedit_image_resizehandle_"+l,o.style.top=e.offsetTop+e.offsetHeight-13+"px",e.style.cssFloat==="left"||e.style.styleFloat==="left"?(o.style.left=e.offsetLeft+e.offsetWidth-13+"px",o.style.cursor="se-resize",o.style.background="URL("+r.options.imageurl+"/image/resize-se.png)"):(o.style.left=e.offsetLeft+"px",o.style.cursor="sw-resize",o.style.background="URL("+r.options.imageurl+"/image/resize-sw.png)"),r.contextuallayer.appendChild(o),o.style.MozUserSelect="none",o.contentEditable=!1,o.unselectable="on",o.onmousedown=function(e){return n.resize.start(this,e)},o.ondragstart=function(e){return r.util.cancelEvent(e)},o.ondraggesture=function(e){return r.util.cancelEvent(e)},o.onclick=function(e){return r.util.cancelEvent(e)},o.ondblclick=function(e){return r.util.cancelEvent(e)},o.onresizestart=function(e){return r.util.cancelEvent(e)}),a=n.ui.createbutton(l,"align",">",function(e,t){t.elem.style.top=e.offsetTop+e.offsetHeight/2-15+"px",e.style.cssFloat==="left"||e.style.styleFloat==="left"?(t.elem.style.left=e.offsetLeft+e.offsetWidth-15+"px",t.elem.innerHTML="&gt;"):(t.elem.style.left=e.offsetLeft-15+"px",t.elem.innerHTML="&lt;")}),e.style.cssFloat==="left"||e.style.styleFloat==="left"?a.event.click=function(e){return n.move.align("right",e)}:a.event.click=function(e){return n.move.align("left",e)},a.register(),a=n.ui.createbutton(l,"delete","&#215;",function(e,t){t.elem.style.top=e.offsetTop+"px",t.elem.style.left=e.offsetLeft+"px"}),a.event.click=function(e){return n.remove(e)},a.register(),a=n.ui.createbutton(l,"up","^",function(e,t){t.elem.style.top=e.offsetTop+e.offsetHeight/2-15-40+"px",t.elem.style.left=(e.style.cssFloat==="left"||e.style.styleFloat==="left"?e.offsetLeft+e.offsetWidth-15:e.offsetLeft-15)+"px"}),a.event.click=function(e){return n.move.up(e)},a=n.ui.createbutton(l,"down","&caron;",function(e,t){t.elem.style.top=e.offsetTop+e.offsetHeight/2-15+40+"px",t.elem.style.left=(e.style.cssFloat==="left"||e.style.styleFloat==="left"?e.offsetLeft+e.offsetWidth-15:e.offsetLeft-15)+"px"}),a.event.click=function(e){return n.move.down(e)},a=n.ui.createbutton(l,"small","Small",function(e,t){t.elem.style.top=e.offsetTop+40+"px",t.elem.style.left=(e.style.cssFloat==="left"||e.style.styleFloat==="left"?e.offsetLeft:e.offsetLeft+e.offsetWidth-60)+"px",t.elem.style.width="60px"}),a.event.click=function(e){var t=n.focusedimage;return t.className="small",t.style.height="",t.style.width="",t.style.height=t.offsetHeight-12+"px",t.style.width=t.offsetWidth-12+"px",n.ui.setbuttonpositions(),r.util.cancelEvent(e)},a=n.ui.createbutton(l,"golden","Golden",function(e,t){t.elem.style.top=e.offsetTop+80+"px",t.elem.style.left=(e.style.cssFloat==="left"||e.style.styleFloat==="left"?e.offsetLeft:e.offsetLeft+e.offsetWidth-80)+"px",t.elem.style.width="80px"}),a.event.click=function(e){var t=n.focusedimage;return t.className="golden",t.style.height="",t.style.width="",t.style.height=t.offsetHeight-12+"px",t.style.width=t.offsetWidth-12+"px",n.ui.setbuttonpositions(),r.util.cancelEvent(e)},a=n.ui.createbutton(l,"medium","Medium",function(e,t){t.elem.style.top=e.offsetTop+120+"px",t.elem.style.left=(e.style.cssFloat==="left"||e.style.styleFloat==="left"?e.offsetLeft:e.offsetLeft+e.offsetWidth-80)+"px",t.elem.style.width="80px"}),a.event.click=function(e){var t=n.focusedimage;return t.className="medium",t.style.height="",t.style.width="",t.style.height=t.offsetHeight-12+"px",t.style.width=t.offsetWidth-12+"px",n.ui.setbuttonpositions(),r.util.cancelEvent(e)},a=n.ui.createbutton(l,"fullwidth","Full Width",function(e,t){t.elem.style.top=e.offsetTop+160+"px",t.elem.style.left=(e.style.cssFloat==="left"||e.style.styleFloat==="left"?e.offsetLeft:e.offsetLeft+e.offsetWidth-100)+"px",t.elem.style.width="100px"}),a.event.click=function(e){var t=n.focusedimage;return t.className="fullwidth",t.style.height="",t.style.width="",t.style.height=t.offsetHeight-12+"px",t.style.width=t.offsetWidth-12+"px",n.ui.setbuttonpositions(),r.util.cancelEvent(e)},f="<select onclick='ghostedit.util.preventBubble()' onchange='_image.focusedimage.style.clear = this.value;_image.refocus();'>",f+="<option value='' "+(e.style.clear===""?"selected='selected' ":"")+">Clear: none</option>",f+="<option value='left' "+(e.style.clear==="left"?"selected='selected' ":"")+">Clear: left</option>",f+="<option value='right' "+(e.style.clear==="right"?"selected='selected' ":"")+">Clear: right</option>",f+="<option value='both' "+(e.style.clear==="both"?"selected='selected' ":"")+">Clear: both</option>",f+=" </select>",a=n.ui.createbutton(l,"clear",f,function(e,t){t.elem.style.top=e.offsetTop+"px",t.elem.style.left=e.offsetLeft+e.offsetWidth-100+"px",t.elem.style.width="100px",t.elem.style.cursor="default"}),a.event.click=null,a.event.mousedown=null;for(i=0;i<n.buttons.length;i+=1)n.buttons[i].show(e),n.buttons[i].reposition(e,n.buttons[i]);r.selection.set("image",e),n.focusedimage=e,r.event.trigger("ui:newcontext",{context:"image"});if(t)return r.util.cancelEvent(t)}},n.resize={start:function(t,i){r.history.saveUndoState(),i===null&&(i=e.event);var s=document.getElementById("ghostedit_image_"+t.id.replace("ghostedit_image_resizehandle_",""));return n.originalMouseX=i.pageX||i.clientX+document.body.scrollLeft,n.originalMouseY=i.pageY||i.clientY+document.body.scrollTop,n.originalImageWidth=s.offsetWidth,n.originalImageHeight=s.offsetHeight,s.getAttribute("data-ghostedit-nativewidth")||s.setAttribute("data-ghostedit-nativewidth",s.offsetWidth),s.getAttribute("data-ghostedit-nativeheight")||s.setAttribute("data-ghostedit-nativeheight",s.offsetHeight),r.util.addEvent(document.body,"mousemove",n.resize.handle),r.util.addEvent(document.body,"mouseup",n.resize.end),r.util.addEvent(e,"blur",n.resize.end),!1},handle:function(t){var r,i,s,o,u,a,f,l,c,h,p,d,v;t=e.event!==null?e.event:t,n.focusedimage===null?n.unfocus():(r=n.focusedimage,i=document.getElementById("ghostedit_image_resizehandle_"+r.id.replace("ghostedit_image_","")),s=document.getElementById("ghostedit_imagebutton_align"+r.id.replace("ghostedit_image_","")),o=t.pageX||t.clientX+document.body.scrollLeft,u=t.pageY||t.clientY+document.body.scrollTop,h=n.originalMouseX,p=n.originalMouseY,c=n.originalImageHeight,l=n.originalImageWidth,v=r.getAttribute("data-ghostedit-nativeheight"),d=r.getAttribute("data-ghostedit-nativewidth"),r.style.cssFloat==="left"||r.style.styleFloat==="left"?(a=l+(o-h),f=c+(u-p)):(a=l-(o-h),f=c+(u-p)),f/v*d>a?a=f/v*d:f=a/d*v,a>=r.parentNode.width&&(a=r.parentNode.width,f=a/d*v),r.style.width=a+"px",r.style.height=f+"px",n.ui.setbuttonpositions())},end:function(){n.justResized=!0,r.util.removeEvent(document.body,"mousemove",n.resize.handle),r.util.removeEvent(document.body,"mouseup",n.resize.end),r.util.removeEvent(e,"blur",n.resize.end),r.history.saveUndoState()}},n.ui={show:function(e){var t,n=e;n=t},hide:function(e){var t;e=e||n.focusedimage;if(!e)return!1;document.getElementById("ghostedit_image_border_"+e.id.replace("ghostedit_image_",""))&&r.contextuallayer.removeChild(document.getElementById("ghostedit_image_border_"+e.id.replace("ghostedit_image_",""))),!r.options.image.disableresize&&document.getElementById("ghostedit_image_resizehandle_"+e.id.replace("ghostedit_image_",""))&&r.contextuallayer.removeChild(document.getElementById("ghostedit_image_resizehandle_"+e.id.replace("ghostedit_image_","")));for(t=0;t<n.buttons.length;t+=1)n.buttons[t].hide();n.buttons=[]},createbutton:function(e,t,i,s){var o,u;return u=document.createElement("span"),u.id="ghostedit_imagebutton_"+t+"_"+e,u.setAttribute("data-ghostedit-elemtype","ghostedit_imagebutton"),u.setAttribute("data-ghostedit-handler","image"),u.className="ghostedit_imagebutton",u.innerHTML=i,o={elem:u},o.reposition=s,o.event={mousedown:function(e){return r.util.cancelEvent(e)},dragstart:function(e){return r.util.cancelEvent(e)},draggesture:function(e){return r.util.cancelEvent(e)},click:function(e){return r.util.cancelEvent(e)},dblclick:function(e){return r.util.cancelEvent(e)},resizestart:function(e){return r.util.cancelEvent(e)}},o.show=function(){r.contextuallayer.appendChild(o.elem),o.elem.style.MozUserSelect="none",o.elem.contentEditable=!1,o.elem.unselectable="on",o.elem.onmousedown=o.event.mousedown,o.elem.ondragstart=o.event.dragstart,o.elem.ondraggesture=o.event.draggesture,o.elem.onclick=o.event.click,o.elem.ondblclick=o.event.dblclick,o.elem.onresizestart=o.event.resizestart},o.hide=function(){o.elem.parentNode.removeChild(o.elem)},o.register=function(){n.buttons.push(o)},o},setbuttonpositions:function(){var e,t,i,s;t=n.focusedimage;if(t){i=document.getElementById("ghostedit_image_border_"+t.id.replace("ghostedit_image_","")),i.style.top=t.offsetTop+"px",i.style.left=t.offsetLeft+"px",i.style.width=t.offsetWidth-6+"px",i.style.height=t.offsetHeight-6+"px",r.options.image.disableresize||(s=document.getElementById("ghostedit_image_resizehandle_"+t.id.replace("ghostedit_image_","")),s.style.top=t.offsetTop+t.offsetHeight-13+"px",t.style.cssFloat==="left"||t.style.styleFloat==="left"?s.style.left=t.offsetLeft+t.offsetWidth-13+"px":s.style.left=t.offsetLeft+"px");for(e=0;e<n.buttons.length;e+=1)n.buttons[e].reposition(t,n.buttons[e])}}},n.insert=function(){var e;e=document.getElementById("ghostedit_imageurlinput"),e.blur(),n.newImageBefore(null,null,!1)},n.create=function(t){var i;return i=document.createElement("img"),n.elemid+=1,i.id="ghostedit_image_"+n.elemid,i.src=t,r.options.defaultimageclass&&(i.className=r.options.defaultimageclass),i.setAttribute("data-ghostedit-elemtype","image"),i.setAttribute("data-ghostedit-handler","image"),i.contentEditable="false",i.unselectable="on",i.galleryimg="no",i.onclick=function(e){n.focus(this,e),r.util.cancelAllEvents(e)},i.ondragstart=function(t){return t=e.event?e.event:t,t.dataTransfer&&(t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("Text",i.id)),!0},i.ondraggesture=function(e){return r.util.cancelEvent(e)},i.onresizestart=function(e){return r.util.cancelAllEvents(e)},i.oncontrolselect=function(e){return n.focus(this,e),r.util.cancelAllEvents(e)},i},n.newImageBefore=function(e,t,i,s){var o,u,a,f,l,c,h;r.history.saveUndoState(),e===null&&(e=r.selection.savedRange.getStartNode()),e=r.plugins.textblock.selection.getTextBlockNode(e),s!=="after"&&(s="before"),t===null&&(t=document.getElementById("ghostedit_imageurlinput").value);if(!document.getElementById("ghostedit_image_"+e.id.replace("ghostedit_textblock_","")))return a=document.createElement("img"),n.elemid+=1,a.id="ghostedit_image_"+n.elemid,r.options.defaultimageclass&&(a.className=r.options.defaultimageclass),f=r.dom.getParentGhostBlock(e),l=f.getAttribute("data-ghostedit-handler"),c=r.plugins[l].dom.addchild(f,s,e,a),c?(u=document.getElementById("ghostedit_image_"+n.elemid),u.setAttribute("data-ghostedit-elemtype","image"),u.setAttribute("data-ghostedit-handler","image"),u.contentEditable="false",u.unselectable="on",u.galleryimg="no",h=e.style.clear==="left"?"right":"left",u.style.cssFloat=h,u.style.styleFloat=h,u.style.clear=e.style.clear,u.style.marginRight="20px",o={i:u,s:i},o.callself=function(){n.onload(o.i,o.s,!0)},u.onload=o.callself,u.src=t,n.applyeventlisteners(u),r.util.addClass(u,"leftimage"),u):!1},n.onload=function(e,t,i){if(i===!0){e.setAttribute("data-ghostedit-nativewidth",0),e.setAttribute("data-ghostedit-nativeheight",0);if(!r.options.image.disableresize&&!t&&e.offsetWidth>200){var s=200,o=s/e.offsetWidth*e.offsetHeight;e.style.width=s+"px",e.style.height=o+"px"}e.contentEditable=!1,r.history.saveUndoState()}else{var u={i:e,s:t};u.callself=function(){n.onload(u.i,u.s,!0)},setTimeout(u.callself,20)}},n.applyeventlisteners=function(){var t,i,s,o,u;t=r.editdiv.getElementsByTagName("img"),console.log("applyimageevent"),o=function(e){return n.focus(this,e),r.util.cancelAllEvents(e)},u=function(t){return t=e.event?e.event:t,t.dataTransfer&&(t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("Text",s.id)),!0};for(i=0;i<t.length;i++){s=t[i],console.log(s);if(s.getAttribute("data-ghostedit-elemtype")!=="image")continue;console.log(s),s.onclick=o,s.ondragstart=u,s.ondraggesture=r.util.cancelEvent,s.onresizestart=r.util.cancelAllEvents,s.oncontrolselect=o}},r.api.plugin.register("image",n)})(window);