/*! GhostEdit WYSIWYG editor Copyright (c) 2010-2012 Nico Burns

Description:       An open source JavaScript WYSIWYG editor focused on usability
Homepage:          http://ghosted.it
License:           LGPL
Author:            Nico Burns <nico@nicoburns.com>
Version:           1.0rc1
Release Date:      2012-12-13
Browser Support:   Internet Explorer 6+, Mozilla Firefox 3.6+, Google Chrome, Apple Safari (latest), Opera (latest)
*/
(function(t,n){var r={elemid:0,focusedimage:null,justResized:!1,originalMouseX:null,originalMouseY:null,buttons:[],el:{}};r.enable=function(){ghostedit.event.addListener("preundo",function(){r.unfocus()}),ghostedit.event.addListener("preredo",function(){r.unfocus()}),ghostedit.event.addListener("postundo",function(){r.applyeventlisteners()}),ghostedit.event.addListener("postredo",function(){r.applyeventlisteners()}),ghostedit.event.addListener("selection:change",function(){ghostedit.selection.saved.type!=="image"&&r.ui.hide()}),ghostedit.event.addListener("ui:newcontext",function(e){var t=e.context;switch(t){case"image":case"help":case"save":return}r.unfocus()}),ghostedit.inout.registerimporthandler(r.inout.importHTML,"img"),ghostedit.options.image||(ghostedit.options.image={}),ghostedit.options.image.disableresize||(ghostedit.options.image.disableresize=!1),ghostedit.options.image.flexibleimages||(ghostedit.options.image.flexibleimages=!1);var e=document.createElement("form");e.id="ghostedit_image_focusform",e.style.cssText="margin:0px;padding:0px;height:0px;width:0px;overflow:hidden;line-height: 0px";var t=document.createElement("textarea");t.id="ghostedit_image_keycapturearea",t.onkeypress=ghostedit.util.cancelEvent,t.onkeydown=r.event.keydown,r.el.keycapture=t,e.appendChild(t),ghostedit.wrapdiv.appendChild(e),ghostedit.api.image=ghostedit.api.image||{},ghostedit.api.image.updatealttext=function(e){return r.updatealttext(e)}},r.event={keydown:function(e){e=t.event!=null?t.event:e;var n=e.keyCode!=null?e.keyCode:e.charCode;switch(n){case 8:case 46:r.remove(e);break;case 90:e.ctrlKey&&ghostedit.history.undo();break;case 89:e.ctrlKey&&ghostedit.history.redo();break;case 37:r.move.align("left",e);break;case 38:r.move.up(e);break;case 39:r.move.align("right",e);break;case 40:r.move.down(e)}return ghostedit.util.cancelEvent(e)},insertButtonClick:function(){ghostedit.selection.save();var e,t=[],n,i,s;s="<h2>Insert image</h2><form><p>This dialog allows you to choose an image to insert into the document. Either select one from the list of uploaded images, or enter a custom url in the box below.</p><hr /><h3 style='clear: both;'>Select uploaded image</h3><div id='ghostedit_listbox' style='height: 200px;overflow-x: hidden;overflow-y: scroll;background: white; border: 1px solid #ccc'></div><hr /><h3>Or enter URL</h3><input type='text' value='' id='ghostedit_imageurlinput' style='width: 99%' /><br /><input type='button' value='Insert' style='float: right;margin-top: 10px;' onclick='_image.newImageBefore(null, null);ghostedit.ui.modal.hide();' /></form>",i=[],ghostedit.options.uploadedimages&&(i=ghostedit.options.uploadedimages),ghostedit.ui.modal.show(s);for(e=0;e<i.length;e+=1)n=document.createElement("div"),n.className="ghostedit-listbox-item",n.setAttribute("ghostedit-listitem-value",i[e].url),n.innerHTML="<img src='"+i[e].thumburl+"' style='height: 60px; float: left' /><p style='margin-left: 100px;font-size: 21px'>"+i[e].name+"</p>",n.onclick=function(){r.newImageBefore(null,this.getAttribute("ghostedit-listitem-value"),!1),ghostedit.ui.modal.hide()},document.getElementById("ghostedit_listbox").appendChild(n);document.getElementById("ghostedit_imageurlinput").focus()}},r.selection={compare:function(e,t){return!e||!t?!1:e===t},restore:function(e){return!e||!e.tagName||e.tagName.toLowerCase()!=="img"?!1:(r.focus(e),!0)},deleteContents:function(e){return!0}},r.inout={importHTML:function(e){var t,n,i,s;return t=r.create(e.src),t?(e.className.length>0&&!/ghostedit/.test(e.className)&&(t.className=e.className),t.alt=e.alt,t.title=e.title,n=t.width,i=t.height,t.naturalWidth=t.naturalWidth||n,t.naturalHeight=t.naturalHeight||i,t.setAttribute("data-ghostedit-nativewidth",n),t.setAttribute("data-ghostedit-nativeheight",i),s=ghostedit.wrapdiv.offsetWidth,ghostedit.options.image.flexibleimages||(e.style.width.replace("px","")>0&&e.style.width.replace("px","")<s?t.style.width=e.style.width:t.style.width="200px",t.style.height=t.style.width.replace("px","")/n*i),t.style.cssFloat=e.style.cssFloat,t.style.styleFloat=e.style.styleFloat,t.style.clear=e.style.clear,e.style.cssFloat=="right"||e.style.styleFloat=="right"?(t.style.marginLeft="20px",t.style.marginRight="0px"):(t.style.marginLeft="0px",t.style.marginRight="20px"),t):!1},exportHTML:function(e){if(!e||!ghostedit.dom.isGhostBlock(e)||e.getAttribute("data-ghostedit-elemtype")!=="image")return!1;var t="",n;return n=e,t+="<img src='"+n.src.toString()+"' alt='"+n.alt.toString()+"' title='"+n.title.toString()+"' ",t+="style='",ghostedit.options.image.flexibleimages||(t+="width:"+n.offsetWidth.toString()+"px;height; "+n.offsetHeight+"px;"),n.style.styleFloat=="left"||n.style.cssFloat=="left"?t+="float:left;clear:left;margin-right: 20px;":t+="float:right;clear:right;margin-left: 20px;",n.style.clear!=""&&(t+="clear:"+n.style.clear),t+="'",n.className.length>0&&!/ghostedit/.test(n.className)&&(t+=" class='"+n.className+"'"),t+=" />",{content:t}}},r.ghostevent=function(e,t,n,r){switch(e){case"delete":return!1}},r.move={align:function(e,t){var n;return e!=="left"&&e!=="right"?ghostedit.util.cancelAllEvents(t):ghostedit.selection.saved.type!=="image"?ghostedit.util.cancelAllEvents(t):(ghostedit.history.saveUndoState(),n=ghostedit.selection.saved.data,n.style.styleFloat=e,n.style.cssFloat=e,n.style.marginRight=e==="left"?"20px":"0px",n.style.marginLeft=e==="left"?"0px":"20px",r.focus(n),ghostedit.history.saveUndoState(),ghostedit.util.cancelAllEvents(t))},up:function(e){var t,n,i,s,o,u,a,f,l,c;ghostedit.history.saveUndoState();if(r.focusedimage!=null){n=r.focusedimage,f=n.offsetLeft,a=n.offetTop;if(anchor=ghostedit.dom.getPreviousSiblingGhostBlock(n))l=ghostedit.dom.getParentGhostBlock(anchor),c=l.getAttribute("data-ghostedit-handler"),ghostedit.plugins[c].dom.addchild(l,"before",anchor,n);f==n.offsetLeft&&n.offsetTopBefore==n.offsetTop?n.style.clear="":n.style.clear="",r.focus(r.focusedimage)}return ghostedit.history.saveUndoState(),ghostedit.util.cancelAllEvents(e)},down:function(e){var t,n,i,s,o,u,a=!1,f,l,c;ghostedit.history.saveUndoState();if(r.focusedimage!=null){n=r.focusedimage,offsetLeftBefore=n.offsetLeft,offsetTopBefore=n.offetTop;if(anchor=ghostedit.dom.getNextSiblingGhostBlock(n))l=ghostedit.dom.getParentGhostBlock(anchor),c=l.getAttribute("data-ghostedit-handler"),ghostedit.plugins[c].dom.addchild(l,"after",anchor,n);offsetLeftBefore==n.offsetLeft&&n.offsetTopBefore==n.offsetTop?n.style.clear="":n.style.clear="",r.focus(r.focusedimage)}return ghostedit.history.saveUndoState(),ghostedit.util.cancelAllEvents(e)}},r.setClear=function(e){ghostedit.selection.save(),ghostedit.history.saveUndoState();var t,n,r;n=ghostedit.textblock.selection.getStartTextBlockNode(),r=ghostedit.textblock.selection.getEndTextBlockNode();if(n&&r){t=n;do{t.getAttribute("data-ghostedit-elemtype").toLowerCase()=="textblock"&&(n.style.clear=e);if(!t.nextSibling||t.id==r.id)break;t=t.nextSibling}while(!0)}t=n;while(t.previousSibling&&t.previousSibling.getAttribute("data-ghostedit-elemtype")=="image")t=t.previousSibling,t.style.clear=e;document.getElementById("ghostedit_toolbar_clearselect").value=e,ghostedit.selection.save(),ghostedit.history.saveUndoState()},r.remove=function(e){ghostedit.history.saveUndoState();if(r.focusedimage!=null){var n=r.focusedimage;r.unfocus(),n.parentNode&&n.parentNode.removeChild(n)}return e&&e.preventDefault?e.stopPropagation():t.event.cancelBubble!=null&&(t.event.cancelBubble=!0),ghostedit.history.saveUndoState(),!1},r.refocus=function(){var e=r.focusedimage;r.unfocus(),r.focus(e)},r.unfocus=function(){r.resize.end(),r.focusedimage=null;if(ghostedit.selection.saved.type!=="image")return!1;var e=ghostedit.selection.saved.data;r.ui.hide(e),ghostedit.selection.clear(),ghostedit.selection.save()},r.updatealttext=function(e){r.focusedimage!=0&&r.focusedimage.alt!=e&&(r.focusedimage.alt=e,r.focusedimage.title=e,ghostedit.event.trigger("ui:message",{message:"Image description updated to '"+e+"'",time:2,color:"success"}))},r.focus=function(e,t){var n,s,o,u,a,f,l;r.unfocus();if(ghostedit.isEditing===!0&&r.focusedimage===null){f=e.id.replace("ghostedit_image_",""),o=document.createElement("div"),o.className="ghostedit_image_border",o.id="ghostedit_image_border_"+f,o.style.top=e.offsetTop+"px",o.style.left=e.offsetLeft+"px",o.style.width=e.offsetWidth-6+"px",o.style.height=e.offsetHeight-6+"px",ghostedit.contextuallayer.appendChild(o),(n=document.getElementById("ghostedit_image_resizehandle_"+f))&&ghostedit.contextuallayer.removeChild(n),ghostedit.options.image.disableresize||(s=document.createElement("span"),s.className="ghostedit_image_resizehandle",s.id="ghostedit_image_resizehandle_"+f,s.style.top=e.offsetTop+e.offsetHeight-13+"px",e.style.cssFloat=="left"||e.style.styleFloat=="left"?(s.style.left=e.offsetLeft+e.offsetWidth-13+"px",s.style.cursor="se-resize",s.style.background="URL("+ghostedit.options.imageurl+"/image/resize-se.png)"):(s.style.left=e.offsetLeft+"px",s.style.cursor="sw-resize",s.style.background="URL("+ghostedit.options.imageurl+"/image/resize-sw.png)"),ghostedit.contextuallayer.appendChild(s),s.style.MozUserSelect="none",s.contentEditable=!1,s.unselectable="on",s.onmousedown=function(e){return r.resize.start(this,e)},s.ondragstart=function(e){return ghostedit.util.cancelEvent(e)},s.ondraggesture=function(e){return ghostedit.util.cancelEvent(e)},s.onclick=function(e){return ghostedit.util.cancelEvent(e)},s.ondblclick=function(e){return ghostedit.util.cancelEvent(e)},s.onresizestart=function(e){return ghostedit.util.cancelEvent(e)}),u=r.ui.createbutton(f,"align",">",function(e,t){t.elem.style.top=e.offsetTop+e.offsetHeight/2-15+"px",e.style.cssFloat=="left"||e.style.styleFloat=="left"?(t.elem.style.left=e.offsetLeft+e.offsetWidth-15+"px",t.elem.innerHTML="&gt;"):(t.elem.style.left=e.offsetLeft-15+"px",t.elem.innerHTML="&lt;")}),e.style.cssFloat=="left"||e.style.styleFloat=="left"?u.event.click=function(e){return r.move.align("right",e)}:u.event.click=function(e){return r.move.align("left",e)},u.register(),u=r.ui.createbutton(f,"delete","&#215;",function(e,t){t.elem.style.top=e.offsetTop+"px",t.elem.style.left=e.offsetLeft+"px"}),u.event.click=function(e){return r.remove(e)},u.register(),u=r.ui.createbutton(f,"up","^",function(e,t){t.elem.style.top=e.offsetTop+e.offsetHeight/2-15-40+"px",t.elem.style.left=(e.style.cssFloat=="left"||e.style.styleFloat=="left"?e.offsetLeft+e.offsetWidth-15:e.offsetLeft-15)+"px"}),u.event.click=function(e){return r.move.up(e)},u=r.ui.createbutton(f,"down","&caron;",function(e,t){t.elem.style.top=e.offsetTop+e.offsetHeight/2-15+40+"px",t.elem.style.left=(e.style.cssFloat=="left"||e.style.styleFloat=="left"?e.offsetLeft+e.offsetWidth-15:e.offsetLeft-15)+"px"}),u.event.click=function(e){return r.move.down(e)},u=r.ui.createbutton(f,"small","Small",function(e,t){t.elem.style.top=e.offsetTop+40+"px",t.elem.style.left=(e.style.cssFloat=="left"||e.style.styleFloat=="left"?e.offsetLeft:e.offsetLeft+e.offsetWidth-60)+"px",t.elem.style.width="60px"}),u.event.click=function(e){var t=r.focusedimage;return t.className="small",t.style.height="",t.style.width="",t.style.height=t.offsetHeight-12+"px",t.style.width=t.offsetWidth-12+"px",r.ui.setbuttonpositions(),ghostedit.util.cancelEvent(e)},u=r.ui.createbutton(f,"golden","Golden",function(e,t){t.elem.style.top=e.offsetTop+80+"px",t.elem.style.left=(e.style.cssFloat=="left"||e.style.styleFloat=="left"?e.offsetLeft:e.offsetLeft+e.offsetWidth-80)+"px",t.elem.style.width="80px"}),u.event.click=function(e){var t=r.focusedimage;return t.className="golden",t.style.height="",t.style.width="",t.style.height=t.offsetHeight-12+"px",t.style.width=t.offsetWidth-12+"px",r.ui.setbuttonpositions(),ghostedit.util.cancelEvent(e)},u=r.ui.createbutton(f,"medium","Medium",function(e,t){t.elem.style.top=e.offsetTop+120+"px",t.elem.style.left=(e.style.cssFloat=="left"||e.style.styleFloat=="left"?e.offsetLeft:e.offsetLeft+e.offsetWidth-80)+"px",t.elem.style.width="80px"}),u.event.click=function(e){var t=r.focusedimage;return t.className="medium",t.style.height="",t.style.width="",t.style.height=t.offsetHeight-12+"px",t.style.width=t.offsetWidth-12+"px",r.ui.setbuttonpositions(),ghostedit.util.cancelEvent(e)},u=r.ui.createbutton(f,"fullwidth","Full Width",function(e,t){t.elem.style.top=e.offsetTop+160+"px",t.elem.style.left=(e.style.cssFloat=="left"||e.style.styleFloat=="left"?e.offsetLeft:e.offsetLeft+e.offsetWidth-100)+"px",t.elem.style.width="100px"}),u.event.click=function(e){var t=r.focusedimage;return t.className="fullwidth",t.style.height="",t.style.width="",t.style.height=t.offsetHeight-12+"px",t.style.width=t.offsetWidth-12+"px",r.ui.setbuttonpositions(),ghostedit.util.cancelEvent(e)},a="<select onclick='ghostedit.util.preventBubble()' onchange='_image.focusedimage.style.clear = this.value;_image.refocus();'>",a+="<option value='' "+(e.style.clear==""?"selected='selected' ":"")+">Clear: none</option>",a+="<option value='left' "+(e.style.clear=="left"?"selected='selected' ":"")+">Clear: left</option>",a+="<option value='right' "+(e.style.clear=="right"?"selected='selected' ":"")+">Clear: right</option>",a+="<option value='both' "+(e.style.clear=="both"?"selected='selected' ":"")+">Clear: both</option>",a+=" </select>",u=r.ui.createbutton(f,"clear",a,function(e,t){t.elem.style.top=e.offsetTop+"px",t.elem.style.left=e.offsetLeft+e.offsetWidth-100+"px",t.elem.style.width="100px",t.elem.style.cursor="default"}),u.event.click=null,u.event.mousedown=null;for(i=0;i<r.buttons.length;i+=1)r.buttons[i].show(e),r.buttons[i].reposition(e,r.buttons[i]);ghostedit.selection.saved.type="image",ghostedit.selection.saved.data=e,ghostedit.selection.updatePathInfo(e),ghostedit.event.trigger("ui:update"),r.focusedimage=e,ghostedit.event.trigger("ui:newcontext",{context:"image"});if(t)return ghostedit.util.cancelEvent(t)}},r.resize={start:function(e,n){ghostedit.history.saveUndoState(),n==null&&(n=t.event);var i=document.getElementById("ghostedit_image_"+e.id.replace("ghostedit_image_resizehandle_",""));return r.originalMouseX=n.pageX||n.clientX+document.body.scrollLeft,r.originalMouseY=n.pageY||n.clientY+document.body.scrollTop,r.originalImageWidth=i.offsetWidth,r.originalImageHeight=i.offsetHeight,i.getAttribute("data-ghostedit-nativewidth")||i.setAttribute("data-ghostedit-nativewidth",i.offsetWidth),i.getAttribute("data-ghostedit-nativeheight")||i.setAttribute("data-ghostedit-nativeheight",i.offsetHeight),ghostedit.util.addEvent(document.body,"mousemove",r.resize.handle),ghostedit.util.addEvent(document.body,"mouseup",r.resize.end),ghostedit.util.addEvent(t,"blur",r.resize.end),!1},handle:function(e){var n,i,s,o,u,a,f,l,c,h,p,d,v;e=t.event!=null?t.event:e,r.focusedimage==null?r.unfocus():(n=r.focusedimage,i=document.getElementById("ghostedit_image_resizehandle_"+n.id.replace("ghostedit_image_","")),s=document.getElementById("ghostedit_imagebutton_align"+n.id.replace("ghostedit_image_","")),o=e.pageX||e.clientX+document.body.scrollLeft,u=e.pageY||e.clientY+document.body.scrollTop,h=r.originalMouseX,p=r.originalMouseY,c=r.originalImageHeight,l=r.originalImageWidth,v=n.getAttribute("data-ghostedit-nativeheight"),d=n.getAttribute("data-ghostedit-nativewidth"),n.style.cssFloat=="left"||n.style.styleFloat=="left"?(a=l+(o-h),f=c+(u-p)):(a=l-(o-h),f=c+(u-p)),f/v*d>a?a=f/v*d:f=a/d*v,a>=n.parentNode.width&&(a=n.parentNode.width,f=a/d*v),n.style.width=a+"px",n.style.height=f+"px",r.ui.setbuttonpositions())},end:function(e){r.justResized=!0,ghostedit.util.removeEvent(document.body,"mousemove",r.resize.handle),ghostedit.util.removeEvent(document.body,"mouseup",r.resize.end),ghostedit.util.removeEvent(t,"blur",r.resize.end),ghostedit.history.saveUndoState()}},r.ui={show:function(e){},hide:function(e){e=e||r.focusedimage;if(!e)return!1;document.getElementById("ghostedit_image_border_"+e.id.replace("ghostedit_image_",""))&&ghostedit.contextuallayer.removeChild(document.getElementById("ghostedit_image_border_"+e.id.replace("ghostedit_image_",""))),!ghostedit.options.image.disableresize&&document.getElementById("ghostedit_image_resizehandle_"+e.id.replace("ghostedit_image_",""))&&ghostedit.contextuallayer.removeChild(document.getElementById("ghostedit_image_resizehandle_"+e.id.replace("ghostedit_image_","")));for(i=0;i<r.buttons.length;i+=1)r.buttons[i].hide();r.buttons=[]},srcdialog:function(){r.focusedimage!=0&&ghostedit.ui.modal.show("<h3>Change Image Source</h3>yada yada")},createbutton:function(e,t,n,i){var s,o;return o=document.createElement("span"),o.id="ghostedit_imagebutton_"+t+"_"+e,o.setAttribute("data-ghostedit-elemtype","ghostedit_imagebutton"),o.setAttribute("data-ghostedit-handler","image"),o.className="ghostedit_imagebutton",o.innerHTML=n,"&#215;",s={elem:o},s.reposition=i,s.event={mousedown:function(e){return ghostedit.util.cancelEvent(e)},dragstart:function(e){return ghostedit.util.cancelEvent(e)},draggesture:function(e){return ghostedit.util.cancelEvent(e)},click:function(e){return ghostedit.util.cancelEvent(e)},dblclick:function(e){return ghostedit.util.cancelEvent(e)},resizestart:function(e){return ghostedit.util.cancelEvent(e)}},s.show=function(e){ghostedit.contextuallayer.appendChild(s.elem),s.elem.style.MozUserSelect="none",s.elem.contentEditable=!1,s.elem.unselectable="on",s.elem.onmousedown=s.event.mousedown,s.elem.ondragstart=s.event.dragstart,s.elem.ondraggesture=s.event.draggesture,s.elem.onclick=s.event.click,s.elem.ondblclick=s.event.dblclick,s.elem.onresizestart=s.event.resizestart},s.hide=function(){s.elem.parentNode.removeChild(s.elem)},s.register=function(){r.buttons.push(s)},s},setbuttonpositions:function(){var e,t,n,s,o,u,a;if(e=r.focusedimage){t=document.getElementById("ghostedit_image_border_"+e.id.replace("ghostedit_image_","")),t.style.top=e.offsetTop+"px",t.style.left=e.offsetLeft+"px",t.style.width=e.offsetWidth-6+"px",t.style.height=e.offsetHeight-6+"px",ghostedit.options.image.disableresize||(n=document.getElementById("ghostedit_image_resizehandle_"+e.id.replace("ghostedit_image_","")),n.style.top=e.offsetTop+e.offsetHeight-13+"px",e.style.cssFloat=="left"||e.style.styleFloat=="left"?n.style.left=e.offsetLeft+e.offsetWidth-13+"px":n.style.left=e.offsetLeft+"px");for(i=0;i<r.buttons.length;i+=1)r.buttons[i].reposition(e,r.buttons[i])}}},r.insert=function(){var e;e=document.getElementById("ghostedit_imageurlinput"),e.blur(),r.newImageBefore(null,null,!1),ghostedit.ui.modal.hide()},r.insertInline=function(n,i,s){ghostedit.history.saveUndoState(),ghostedit.selection.restore(),n==null&&(n=ghostedit.selection.savedRange.getStartNode()),n=ghostedit.textblock.selection.getTextBlockNode(n),i==null&&(i=document.getElementById("ghostedit_imageurlinput").value),document.createRange?(newImg=document.createElement("img"),ghostedit.imgElemId+=1,newImg.id="ghostedit_image_"+(1e3+ghostedit.imgElemId),ghostedit.selection.savedRange.getNative().insertNode(newImg)):document.selection&&ghostedit.selection.savedRange.getNative().pasteHTML("<img id='ghostedit_image_"+(1e3+ghostedit.imgElemId)+"' />");var o=document.getElementById("ghostedit_image_"+(1e3+ghostedit.imgElemId));o.setAttribute("data-ghostedit-elemtype","image"),o.setAttribute("data-ghostedit-handler","image"),o.contentEditable="false",o.unselectable="on";var u={i:o,s:s};u.callself=function(){r.onload(u.i,u.s,!0)},o.onload=u.callself,o.src=i,o.onclick=function(e){r.focus(this,e),ghostedit.util.cancelAllEvents(e)},o.ondragstart=function(e){return e=t.event?t.event:e,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("Text",o.id)),!0},o.ondraggesture=function(){return ghostedit.util.cancelEvent(e)},o.onresizestart=function(){return ghostedit.util.cancelAllEvents(e)},o.oncontrolselect=function(e){return r.focus(this,e),ghostedit.util.cancelAllEvents(e)}},r.create=function(n){var i;return i=document.createElement("img"),r.elemid+=1,i.id="ghostedit_image_"+r.elemid,i.src=n,ghostedit.options.defaultimageclass&&(i.className=ghostedit.options.defaultimageclass),i.setAttribute("data-ghostedit-elemtype","image"),i.setAttribute("data-ghostedit-handler","image"),i.contentEditable="false",i.unselectable="on",i.galleryimg="no",i.onclick=function(e){r.focus(this,e),ghostedit.util.cancelAllEvents(e)},i.ondragstart=function(e){return e=t.event?t.event:e,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("Text",i.id)),!0},i.ondraggesture=function(){return ghostedit.util.cancelEvent(e)},i.onresizestart=function(){return ghostedit.util.cancelAllEvents(e)},i.oncontrolselect=function(e){return r.focus(this,e),ghostedit.util.cancelAllEvents(e)},i},r.newImageBefore=function(e,t,n,i){var s,o,u,a,f;ghostedit.history.saveUndoState(),e==null&&(e=ghostedit.selection.savedRange.getStartNode()),e=ghostedit.textblock.selection.getTextBlockNode(e),i!=="after"&&(i="before"),t==null&&(t=document.getElementById("ghostedit_imageurlinput").value);if(!document.getElementById("ghostedit_image_"+e.id.replace("ghostedit_textblock_",""))){newImg=document.createElement("img"),r.elemid+=1,newImg.id="ghostedit_image_"+r.elemid,ghostedit.options.defaultimageclass&&(newImg.className=ghostedit.options.defaultimageclass),u=ghostedit.dom.getParentGhostBlock(e),a=u.getAttribute("data-ghostedit-handler"),f=ghostedit.plugins[a].dom.addchild(u,i,e,newImg);if(!f)return!1;var o=document.getElementById("ghostedit_image_"+r.elemid);o.setAttribute("data-ghostedit-elemtype","image"),o.setAttribute("data-ghostedit-handler","image"),o.contentEditable="false",o.unselectable="on",o.galleryimg="no";var l=e.style.clear=="left"?"right":"left";o.style.cssFloat=l,o.style.styleFloat=l,o.style.clear=e.style.clear,o.style.marginRight="20px";var s={i:o,s:n};return s.callself=function(){r.onload(s.i,s.s,!0)},o.onload=s.callself,o.src=t,r.applyeventlisteners(o),ghostedit.util.addClass(o,"leftimage"),o}},r.newImageFrame=function(){var n,i;ghostedit.history.saveUndoState(),elem=ghostedit.selection.savedRange.getStartNode(),elem=ghostedit.textblock.selection.getTextBlockNode(elem);if(!elem||!elem.id)return ghostedit.ui.message.show("Please select a paragraph or heading before trying to insert an image.",2,"error"),!1;if(!document.getElementById("ghostedit_image_"+elem.id.replace("ghostedit_textblock_",""))){newImg=document.createElement("div"),newImg.innerHTML="<h3>Image Uploading</h3>",newImg.id="ghostedit_image_"+elem.id.replace("ghostedit_textblock_",""),elem.parentNode!=null?(elem.parentNode.contentEditable=!1,elem.parentNode.insertBefore(newImg,elem),elem.parentNode.contentEditable=!0):ghostedit.ui.message.show("Please select a paragraph or heading before trying to insert an image.",2,"error");var i=document.getElementById("ghostedit_image_"+elem.id.replace("ghostedit_textblock_",""));return i.setAttribute("data-ghostedit-elemtype","image"),i.setAttribute("data-ghostedit-handler","image"),i.contentEditable="false",i.unselectable="on",i.style.width="240px",i.style.height="160px",i.style.backgroundColor="#EEE",i.style.cssFloat="left",i.style.styleFloat="left",i.style.marginRight="20px",i.style.overflow="hidden",i.setAttribute("data-ghostedit-nativewidth",0),i.setAttribute("data-ghostedit-nativeheight",0),i.onclick=function(e){r.focus(this,e),ghostedit.util.cancelAllEvents(e)},i.ondragstart=function(e){return e=t.event?t.event:e,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("Text",i.id)),!0},i.ondraggesture=function(){return ghostedit.util.cancelEvent(e)},i.onresizestart=function(){return ghostedit.util.cancelAllEvents(e)},i.oncontrolselect=function(e){return r.focus(this,e),ghostedit.util.cancelAllEvents(e)},i.id}},r.onload=function(e,t,n){if(n==1){e.setAttribute("data-ghostedit-nativewidth",0),e.setAttribute("data-ghostedit-nativeheight",0);if(!ghostedit.options.image.disableresize&&!t&&e.offsetWidth>200){var i=200,s=i/e.offsetWidth*e.offsetHeight;e.style.width=i+"px",e.style.height=s+"px"}e.contentEditable=!1,ghostedit.history.saveUndoState()}else{var o={i:e,s:t};o.callself=function(){r.onload(o.i,o.s,!0)},setTimeout(o.callself,20)}},r.applyeventlisteners=function(){var n,i,s;n=ghostedit.editdiv.getElementsByTagName("img");for(i=0;i<n.length;i++){s=n[i];if(s.getAttribute("data-ghostedit-elemtype")!=="image")continue;s.onclick=function(e){r.focus(this,e),ghostedit.util.cancelAllEvents(e)},s.ondragstart=function(e){return e=t.event?t.event:e,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("Text",addedImage.id)),!0},s.ondraggesture=function(){return ghostedit.util.cancelEvent(e)},s.onresizestart=function(){return ghostedit.util.cancelAllEvents(e)},s.oncontrolselect=function(e){return r.focus(this,e),ghostedit.util.cancelAllEvents(e)}}},ghostedit.api.plugin.register("image",r)})(window);