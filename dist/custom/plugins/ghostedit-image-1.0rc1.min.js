/*! GhostEdit WYSIWYG editor Copyright (c) 2010-2012 Nico Burns

Description:       An open source JavaScript WYSIWYG editor focused on usability
Homepage:          http://ghosted.it
License:           LGPL
Author:            Nico Burns <nico@nicoburns.com>
Version:           1.0rc1
Release Date:      2012-12-30
Browser Support:   Internet Explorer 6+, Mozilla Firefox 3.6+, Google Chrome, Apple Safari (latest), Opera (latest)
*/
(function(e,t){var n={elemid:0,focusedimage:null,justResized:!1,originalMouseX:null,originalMouseY:null,buttons:[],el:{}},r=e.lasso,i=e.ghostedit;n.enable=function(){i.event.addListener("history:undo:after",function(){n.applyeventlisteners()}),i.event.addListener("history:redo:after",function(){n.applyeventlisteners()}),i.event.addListener("clipboard:paste:after",function(){n.applyeventlisteners()}),i.event.addListener("selection:change",function(){i.selection.saved.type==="image"?(r().clearSelection(),n.el.keycapture.focus()):n.ui.hide()}),i.inout.registerimporthandler(n.inout.importHTML,"img"),i.options.image||(i.options.image={}),i.options.image.disableresize||(i.options.image.disableresize=!1),i.options.image.flexibleimages||(i.options.image.flexibleimages=!1);var e=document.createElement("form");e.id="ghostedit_image_focusform",e.style.cssText="margin:0px;padding:0px;height:0px;width:0px;overflow:hidden;line-height: 0px;position: absolute;left: 0; top: 0";var t=document.createElement("textarea");t.id="ghostedit_image_keycapturearea",t.style.cssText="margin:0px;padding:0px;height:0px;width:0px;overflow:hidden;line-height: 0px",t.onkeypress=i.util.cancelEvent,t.onkeydown=n.event.keydown,n.el.keycapture=t,e.appendChild(t),i.el.uilayer.appendChild(e),i.api.image=i.api.image||{},i.api.image.updatealttext=function(e){return n.updatealttext(e)}},n.event={keydown:function(t){t=e.event?e.event:t;var r=t.keyCode!==null?t.keyCode:t.charCode;switch(r){case 8:case 46:n.remove(t);break;case 90:t.ctrlKey&&i.history.undo();break;case 89:t.ctrlKey&&i.history.redo();break;case 37:n.move.align("left",t);break;case 38:n.move.up(t);break;case 39:n.move.align("right",t);break;case 40:n.move.down(t)}return i.util.cancelEvent(t)}},n.selection={compare:function(e,t){return!e||!t?!1:e===t?!0:!1},restore:function(e){return!e||!e.tagName||e.tagName.toLowerCase()!=="img"?!1:(n.focus(e),!0)},deleteContents:function(){return!0}},n.inout={importHTML:function(e){var t,r,s;return t=n.create(e.src),t?(e.className.length>0&&!/ghostedit/.test(e.className)&&(t.className=e.className),t.alt=e.alt,t.title=e.title,r=t.width,s=t.height,t.naturalWidth=t.naturalWidth||r,t.naturalHeight=t.naturalHeight||s,t.setAttribute("data-ghostedit-nativewidth",r),t.setAttribute("data-ghostedit-nativeheight",s),i.options.image.flexibleimages||(t.style.width=e.style.width,t.style.height=t.style.width.replace("px","")/r*s+"px"),t.style.cssFloat=e.style.cssFloat,t.style.styleFloat=e.style.styleFloat,t.style.clear=e.style.clear,e.style.cssFloat==="right"||e.style.styleFloat==="right"?(t.style.marginLeft="20px",t.style.marginRight="0px"):(t.style.marginLeft="0px",t.style.marginRight="20px"),t):!1},exportHTML:function(e){if(!e||!i.dom.isGhostBlock(e)||e.getAttribute("data-ghostedit-elemtype")!=="image")return!1;var t="",n;return n=e,t+="<img src='"+n.src.toString()+"' alt='"+n.alt.toString()+"' title='"+n.title.toString()+"' ",t+="style='",i.options.image.flexibleimages||(t+="width:"+n.offsetWidth.toString()+"px;height; "+n.offsetHeight+"px;"),n.style.styleFloat==="left"||n.style.cssFloat==="left"?t+="float:left;clear:left;margin-right: 20px;":t+="float:right;clear:right;margin-left: 20px;",n.style.clear!==""&&(t+="clear:"+n.style.clear),t+="'",n.className.length>0&&!/ghostedit/.test(n.className)&&(t+=" class='"+n.className+"'"),t+=" />",{content:t}}},n.move={align:function(e,t){var r;return e!=="left"&&e!=="right"?i.util.cancelAllEvents(t):i.selection.saved.type!=="image"?i.util.cancelAllEvents(t):(i.history.saveUndoState(),r=i.selection.saved.data,r.style.styleFloat=e,r.style.cssFloat=e,r.style.marginRight=e==="left"?"20px":"0px",r.style.marginLeft=e==="left"?"0px":"20px",n.focus(r),i.history.saveUndoState(),i.util.cancelAllEvents(t))},up:function(e){var t,r,s,o,u,a;return i.history.saveUndoState(),n.focusedimage!==null&&(t=n.focusedimage,s=t.offsetLeft,r=t.offetTop,a=i.dom.getPreviousSiblingGhostBlock(t),a&&(o=i.dom.getParentGhostBlock(a),u=o.getAttribute("data-ghostedit-handler"),i.plugins[u].dom.addchild(o,"before",a,t)),s===t.offsetLeft&&t.offsetTopBefore===t.offsetTop?t.style.clear="":t.style.clear="",n.focus(n.focusedimage)),i.history.saveUndoState(),i.util.cancelAllEvents(e)},down:function(e){var t,r,s,o,u,a;return i.history.saveUndoState(),n.focusedimage!==null&&(t=n.focusedimage,o=t.offsetLeft,u=t.offetTop,a=i.dom.getNextSiblingGhostBlock(t),a&&(r=i.dom.getParentGhostBlock(a),s=r.getAttribute("data-ghostedit-handler"),i.plugins[s].dom.addchild(r,"after",a,t)),o===t.offsetLeft&&t.offsetTopBefore===t.offsetTop?t.style.clear="":t.style.clear="",n.focus(n.focusedimage)),i.history.saveUndoState(),i.util.cancelAllEvents(e)}},n.setClear=function(e){i.selection.save(),i.history.saveUndoState();var t,n,r;n=i.textblock.selection.getStartTextBlockNode(),r=i.textblock.selection.getEndTextBlockNode();if(n&&r){t=n;do{t.getAttribute("data-ghostedit-elemtype").toLowerCase()==="textblock"&&(n.style.clear=e);if(!t.nextSibling||t.id===r.id)break;t=t.nextSibling}while(!0)}t=n;while(t.previousSibling&&t.previousSibling.getAttribute("data-ghostedit-elemtype")==="image")t=t.previousSibling,t.style.clear=e;document.getElementById("ghostedit_toolbar_clearselect").value=e,i.selection.save(),i.history.saveUndoState()},n.remove=function(t){i.history.saveUndoState();if(n.focusedimage!==null){var r=n.focusedimage;n.unfocus(),r.parentNode&&r.parentNode.removeChild(r)}return t&&t.preventDefault?t.stopPropagation():e.event.cancelBubble!==null&&(e.event.cancelBubble=!0),i.history.saveUndoState(),!1},n.refocus=function(){var e=n.focusedimage;n.unfocus(),n.focus(e)},n.unfocus=function(){n.resize.end(),n.focusedimage=null;if(i.selection.saved.type!=="image")return!1;var e=i.selection.saved.data;n.ui.hide(e),i.selection.clear(),i.selection.save()},n.updatealttext=function(e){n.focusedimage!==!1&&n.focusedimage.alt!==e&&(n.focusedimage.alt=e,n.focusedimage.title=e,i.event.trigger("ui:message",{message:"Image description updated to '"+e+"'",time:2,color:"success"}))},n.focus=function(e,t){var r,s,o,u,a,f,l;n.unfocus();if(i.isEditing===!0&&n.focusedimage===null){l=e.id.replace("ghostedit_image_",""),u=document.getElementById("ghostedit_image_border_"+l),u&&i.el.uilayer.removeChild(u),u=document.createElement("div"),u.className="ghostedit_image_border",u.style.cssText="position: absolute;line-height: 1px;font-size: 1px;background-color: transparent;border: 3px solid #333;z-index: 100",u.id="ghostedit_image_border_"+l,u.style.top=e.offsetTop+"px",u.style.left=e.offsetLeft+"px",u.style.width=e.offsetWidth-6+"px",u.style.height=e.offsetHeight-6+"px",i.el.uilayer.appendChild(u),s=document.getElementById("ghostedit_image_resizehandle_"+l),s&&i.el.uilayer.removeChild(s),i.options.image.disableresize||(o=document.createElement("span"),o.className="ghostedit_image_resizehandle",o.style.cssText="position: absolute;width: 13px;height: 13px;line-height: 9px;font-size: 9px;background-color: transparent;z-index: 200",o.id="ghostedit_image_resizehandle_"+l,o.style.top=e.offsetTop+e.offsetHeight-13+"px",e.style.cssFloat==="left"||e.style.styleFloat==="left"?(o.style.left=e.offsetLeft+e.offsetWidth-13+"px",o.style.cursor="se-resize",o.style.background="URL("+i.options.imageurl+"/image/resize-se.png)"):(o.style.left=e.offsetLeft+"px",o.style.cursor="sw-resize",o.style.background="URL("+i.options.imageurl+"/image/resize-sw.png)"),i.el.uilayer.appendChild(o),o.style.MozUserSelect="none",o.contentEditable=!1,o.unselectable="on",o.onmousedown=function(e){return n.resize.start(this,e)},o.ondragstart=function(e){return i.util.cancelEvent(e)},o.ondraggesture=function(e){return i.util.cancelEvent(e)},o.onclick=function(e){return i.util.cancelEvent(e)},o.ondblclick=function(e){return i.util.cancelEvent(e)},o.onresizestart=function(e){return i.util.cancelEvent(e)}),a=n.ui.createbutton(l,"align",">",function(e,t){t.elem.style.top=e.offsetTop+e.offsetHeight/2-15+"px",e.style.cssFloat==="left"||e.style.styleFloat==="left"?(t.elem.style.left=e.offsetLeft+e.offsetWidth-15+"px",t.elem.innerHTML="&gt;"):(t.elem.style.left=e.offsetLeft-15+"px",t.elem.innerHTML="&lt;")}),e.style.cssFloat==="left"||e.style.styleFloat==="left"?a.event.click=function(e){return n.move.align("right",e)}:a.event.click=function(e){return n.move.align("left",e)},a.register(),a=n.ui.createbutton(l,"delete","&#215;",function(e,t){t.elem.style.top=e.offsetTop+"px",t.elem.style.left=e.offsetLeft+"px"}),a.event.click=function(e){return n.remove(e)},a.register(),a=n.ui.createbutton(l,"up","^",function(e,t){t.elem.style.top=e.offsetTop+e.offsetHeight/2-15-40+"px",t.elem.style.left=(e.style.cssFloat==="left"||e.style.styleFloat==="left"?e.offsetLeft+e.offsetWidth-15:e.offsetLeft-15)+"px"}),a.event.click=function(e){return n.move.up(e)},a=n.ui.createbutton(l,"down","&caron;",function(e,t){t.elem.style.top=e.offsetTop+e.offsetHeight/2-15+40+"px",t.elem.style.left=(e.style.cssFloat==="left"||e.style.styleFloat==="left"?e.offsetLeft+e.offsetWidth-15:e.offsetLeft-15)+"px"}),a.event.click=function(e){return n.move.down(e)},a=n.ui.createbutton(l,"small","Small",function(e,t){t.elem.style.top=e.offsetTop+40+"px",t.elem.style.left=(e.style.cssFloat==="left"||e.style.styleFloat==="left"?e.offsetLeft:e.offsetLeft+e.offsetWidth-60)+"px",t.elem.style.width="60px"}),a.event.click=function(e){var t=n.focusedimage;return t.className="small",t.style.height="",t.style.width="",t.style.height=t.offsetHeight-12+"px",t.style.width=t.offsetWidth-12+"px",n.ui.setbuttonpositions(),i.util.cancelEvent(e)},a=n.ui.createbutton(l,"golden","Golden",function(e,t){t.elem.style.top=e.offsetTop+80+"px",t.elem.style.left=(e.style.cssFloat==="left"||e.style.styleFloat==="left"?e.offsetLeft:e.offsetLeft+e.offsetWidth-80)+"px",t.elem.style.width="80px"}),a.event.click=function(e){var t=n.focusedimage;return t.className="golden",t.style.height="",t.style.width="",t.style.height=t.offsetHeight-12+"px",t.style.width=t.offsetWidth-12+"px",n.ui.setbuttonpositions(),i.util.cancelEvent(e)},a=n.ui.createbutton(l,"medium","Medium",function(e,t){t.elem.style.top=e.offsetTop+120+"px",t.elem.style.left=(e.style.cssFloat==="left"||e.style.styleFloat==="left"?e.offsetLeft:e.offsetLeft+e.offsetWidth-80)+"px",t.elem.style.width="80px"}),a.event.click=function(e){var t=n.focusedimage;return t.className="medium",t.style.height="",t.style.width="",t.style.height=t.offsetHeight-12+"px",t.style.width=t.offsetWidth-12+"px",n.ui.setbuttonpositions(),i.util.cancelEvent(e)},a=n.ui.createbutton(l,"fullwidth","Full Width",function(e,t){t.elem.style.top=e.offsetTop+160+"px",t.elem.style.left=(e.style.cssFloat==="left"||e.style.styleFloat==="left"?e.offsetLeft:e.offsetLeft+e.offsetWidth-100)+"px",t.elem.style.width="100px"}),a.event.click=function(e){var t=n.focusedimage;return t.className="fullwidth",t.style.height="",t.style.width="",t.style.height=t.offsetHeight-12+"px",t.style.width=t.offsetWidth-12+"px",n.ui.setbuttonpositions(),i.util.cancelEvent(e)},f="<select onclick='ghostedit.util.preventBubble()' onchange='_image.focusedimage.style.clear = this.value;_image.refocus();'>",f+="<option value='' "+(e.style.clear===""?"selected='selected' ":"")+">Clear: none</option>",f+="<option value='left' "+(e.style.clear==="left"?"selected='selected' ":"")+">Clear: left</option>",f+="<option value='right' "+(e.style.clear==="right"?"selected='selected' ":"")+">Clear: right</option>",f+="<option value='both' "+(e.style.clear==="both"?"selected='selected' ":"")+">Clear: both</option>",f+=" </select>",a=n.ui.createbutton(l,"clear",f,function(e,t){t.elem.style.top=e.offsetTop+"px",t.elem.style.left=e.offsetLeft+e.offsetWidth-100+"px",t.elem.style.width="100px",t.elem.style.cursor="default"}),a.event.click=null,a.event.mousedown=null;for(r=0;r<n.buttons.length;r+=1)n.buttons[r].show(e),n.buttons[r].reposition(e,n.buttons[r]);n.focusedimage=e,i.selection.set("image",e);if(t)return i.util.cancelEvent(t)}},n.resize={start:function(t,r){i.history.saveUndoState(),r=e.event?e.event:r;var s=document.getElementById("ghostedit_image_"+t.id.replace("ghostedit_image_resizehandle_",""));return n.originalMouseX=r.pageX||r.clientX+document.body.scrollLeft,n.originalMouseY=r.pageY||r.clientY+document.body.scrollTop,n.originalImageWidth=s.offsetWidth,n.originalImageHeight=s.offsetHeight,s.getAttribute("data-ghostedit-nativewidth")||s.setAttribute("data-ghostedit-nativewidth",s.offsetWidth),s.getAttribute("data-ghostedit-nativeheight")||s.setAttribute("data-ghostedit-nativeheight",s.offsetHeight),i.util.addEvent(document.body,"mousemove",n.resize.handle),i.util.addEvent(document.body,"mouseup",n.resize.end),i.util.addEvent(e,"blur",n.resize.end),!1},handle:function(t){var r,i,s,o,u,a,f,l,c,h,p,d,v;t=e.event?e.event:t,n.focusedimage===null?n.unfocus():(r=n.focusedimage,i=document.getElementById("ghostedit_image_resizehandle_"+r.id.replace("ghostedit_image_","")),s=document.getElementById("ghostedit_imagebutton_align"+r.id.replace("ghostedit_image_","")),o=t.pageX||t.clientX+document.body.scrollLeft,u=t.pageY||t.clientY+document.body.scrollTop,h=n.originalMouseX,p=n.originalMouseY,c=n.originalImageHeight,l=n.originalImageWidth,v=r.getAttribute("data-ghostedit-nativeheight"),d=r.getAttribute("data-ghostedit-nativewidth"),r.style.cssFloat==="left"||r.style.styleFloat==="left"?(a=l+(o-h),f=c+(u-p)):(a=l-(o-h),f=c+(u-p)),f/v*d>a?a=f/v*d:f=a/d*v,a>=r.parentNode.width&&(a=r.parentNode.width,f=a/d*v),r.style.width=a+"px",r.style.height=f+"px",n.ui.setbuttonpositions())},end:function(){n.justResized=!0,i.util.removeEvent(document.body,"mousemove",n.resize.handle),i.util.removeEvent(document.body,"mouseup",n.resize.end),i.util.removeEvent(e,"blur",n.resize.end),i.history.saveUndoState()}},n.ui={show:function(e){var t,n=e;n=t},hide:function(e){var t;e=e||n.focusedimage;if(!e)return!1;document.getElementById("ghostedit_image_border_"+e.id.replace("ghostedit_image_",""))&&i.el.uilayer.removeChild(document.getElementById("ghostedit_image_border_"+e.id.replace("ghostedit_image_",""))),!i.options.image.disableresize&&document.getElementById("ghostedit_image_resizehandle_"+e.id.replace("ghostedit_image_",""))&&i.el.uilayer.removeChild(document.getElementById("ghostedit_image_resizehandle_"+e.id.replace("ghostedit_image_","")));for(t=0;t<n.buttons.length;t+=1)n.buttons[t].hide();n.buttons=[]},createbutton:function(e,t,r,s){var o,u;return u=document.createElement("span"),u.id="ghostedit_imagebutton_"+t+"_"+e,u.setAttribute("data-ghostedit-elemtype","ghostedit_imagebutton"),u.setAttribute("data-ghostedit-handler","image"),u.className="ghostedit_imagebutton",u.style.cssText="position: absolute;width: 30px;height: 26px;_height: 30px;color: #FFF;font-size: 16px;padding-top: 4px;font-family: Tahoma, sans-serif;text-align: center;vertical-align: middle;font-weight: bold;background-color: #FF028D;cursor: pointer !important;z-index: 200",u.innerHTML=r,o={elem:u},o.reposition=s,o.event={mousedown:function(e){return i.util.cancelEvent(e)},dragstart:function(e){return i.util.cancelEvent(e)},draggesture:function(e){return i.util.cancelEvent(e)},click:function(e){return i.util.cancelEvent(e)},dblclick:function(e){return i.util.cancelEvent(e)},resizestart:function(e){return i.util.cancelEvent(e)}},o.show=function(){i.el.uilayer.appendChild(o.elem),o.elem.style.MozUserSelect="none",o.elem.contentEditable=!1,o.elem.unselectable="on",o.elem.onmousedown=o.event.mousedown,o.elem.ondragstart=o.event.dragstart,o.elem.ondraggesture=o.event.draggesture,o.elem.onclick=o.event.click,o.elem.ondblclick=o.event.dblclick,o.elem.onresizestart=o.event.resizestart},o.hide=function(){o.elem.parentNode.removeChild(o.elem)},o.register=function(){n.buttons.push(o)},o},setbuttonpositions:function(){var e,t,r,s;t=n.focusedimage;if(t){r=document.getElementById("ghostedit_image_border_"+t.id.replace("ghostedit_image_","")),r.style.top=t.offsetTop+"px",r.style.left=t.offsetLeft+"px",r.style.width=t.offsetWidth-6+"px",r.style.height=t.offsetHeight-6+"px",i.options.image.disableresize||(s=document.getElementById("ghostedit_image_resizehandle_"+t.id.replace("ghostedit_image_","")),s.style.top=t.offsetTop+t.offsetHeight-13+"px",t.style.cssFloat==="left"||t.style.styleFloat==="left"?s.style.left=t.offsetLeft+t.offsetWidth-13+"px":s.style.left=t.offsetLeft+"px");for(e=0;e<n.buttons.length;e+=1)n.buttons[e].reposition(t,n.buttons[e])}}},n.insert=function(){var e;e=document.getElementById("ghostedit_imageurlinput"),e.blur(),n.newImageBefore(null,null,!1)},n.create=function(t){var r;return r=document.createElement("img"),n.elemid+=1,r.id="ghostedit_image_"+n.elemid,r.src=t,i.options.defaultimageclass&&(r.className=i.options.defaultimageclass),r.setAttribute("data-ghostedit-elemtype","image"),r.setAttribute("data-ghostedit-handler","image"),r.contentEditable="false",r.unselectable="on",r.galleryimg="no",r.onclick=function(e){n.focus(this,e),i.util.cancelAllEvents(e)},r.ondragstart=function(t){return t=e.event?e.event:t,t.dataTransfer&&(t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("Text",r.id)),!0},r.ondraggesture=function(e){return i.util.cancelEvent(e)},r.onresizestart=function(e){return i.util.cancelAllEvents(e)},r.oncontrolselect=function(e){return n.focus(this,e),i.util.cancelAllEvents(e)},r},n.newImageBefore=function(e,t,r,s){var o,u,a,f,l,c,h;i.history.saveUndoState(),e===null&&(e=i.selection.savedRange.getStartNode()),e=i.plugins.textblock.selection.getTextBlockNode(e),s!=="after"&&(s="before"),t===null&&(t=document.getElementById("ghostedit_imageurlinput").value);if(!document.getElementById("ghostedit_image_"+e.id.replace("ghostedit_textblock_","")))return a=document.createElement("img"),n.elemid+=1,a.id="ghostedit_image_"+n.elemid,i.options.defaultimageclass&&(a.className=i.options.defaultimageclass),f=i.dom.getParentGhostBlock(e),l=f.getAttribute("data-ghostedit-handler"),c=i.plugins[l].dom.addchild(f,s,e,a),c?(u=document.getElementById("ghostedit_image_"+n.elemid),u.setAttribute("data-ghostedit-elemtype","image"),u.setAttribute("data-ghostedit-handler","image"),u.contentEditable="false",u.unselectable="on",u.galleryimg="no",h=e.style.clear==="left"?"right":"left",u.style.cssFloat=h,u.style.styleFloat=h,u.style.clear=e.style.clear,u.style.marginRight="20px",o={i:u,s:r},o.callself=function(){n.onload(o.i,o.s,!0)},u.onload=o.callself,u.src=t,n.applyeventlisteners(u),i.util.addClass(u,"leftimage"),u):!1},n.onload=function(e,t,r){if(r===!0){e.setAttribute("data-ghostedit-nativewidth",0),e.setAttribute("data-ghostedit-nativeheight",0);if(!i.options.image.disableresize&&!t&&e.offsetWidth>200){var s=200,o=s/e.offsetWidth*e.offsetHeight;e.style.width=s+"px",e.style.height=o+"px"}e.contentEditable=!1,i.history.saveUndoState()}else{var u={i:e,s:t};u.callself=function(){n.onload(u.i,u.s,!0)},setTimeout(u.callself,20)}},n.applyeventlisteners=function(){var t,r,s,o,u;t=i.el.rootnode.getElementsByTagName("img"),o=function(e){return n.focus(this,e),i.util.cancelAllEvents(e)},u=function(t){return t=e.event?e.event:t,t.dataTransfer&&(t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("Text",s.id)),!0};for(r=0;r<t.length;r++){s=t[r];if(s.getAttribute("data-ghostedit-elemtype")!=="image")continue;s.onclick=o,s.ondragstart=u,s.ondraggesture=i.util.cancelEvent,s.onresizestart=i.util.cancelAllEvents,s.oncontrolselect=o}},i.api.plugin.register("image",n)})(window);