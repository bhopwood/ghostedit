/*! GhostEdit WYSIWYG editor Copyright (c) 2010-2012 Nico Burns

Description:       An open source JavaScript WYSIWYG editor focused on usability
Homepage:          http://ghosted.it
License:           LGPL
Author:            Nico Burns <nico@nicoburns.com>
Version:           1.0rc1-pre
Release Date:      2012-12-16
Browser Support:   Internet Explorer 6+, Mozilla Firefox 3.6+, Google Chrome, Apple Safari (latest), Opera (latest)
*/
(function(e,t){var n={focusedlink:!1,el:{}},r=e.lasso,i=e.ghostedit;n.enable=function(){i.event.addListener("preundo",function(){n.unfocus()}),i.event.addListener("preredo",function(){n.unfocus()}),i.event.addListener("import:after",function(){n.event.postimport()}),i.event.addListener("ui:update",function(){n.ui.update()}),i.inout.registerimporthandler(i.plugins.textblock.inout.importHTML,"a"),i.plugins.textblock.inout.parserules.tags.a={attributes:["href"]},i.api.link=i.api.link||{},i.api.link.create=function(){return n.create()},i.api.link.updateurl=function(e){return n.updateurl(e)},i.api.link.open=function(){return n.open()}},n.ghostevent=function(){return!1},n.event={urlBoxKeypress:function(t){t=e.event!==null?e.event:t;var r=t.keyCode!==null?t.keyCode:t.charCode;return r===13?(n.create(),i.ui.modal.hide(),!1):!0},postimport:function(e){var t,n;if(!e||!e.editdiv)return!1;n=e.editdiv.getElementsByTagName("a");for(t=0;t<n.length;t+=1)n[t].setAttribute("data-ghostedit-elemtype","link"),n[t].setAttribute("data-ghostedit-handler","link");return!0},insertButtonClick:function(){var e;i.selection.savedRange.isCollapsed()&&(e=i.selection.savedRange.clone(),e=i.textblock.selection.extendtoword(e,!0),e.select(),i.selection.save()),i.selection.savedRange.isCollapsed()?document.selection&&(i.selection.savedRange.getNative().pasteHTML("<a id='ghostedit_newlink' href='http://'>Link Text</a>"),r().selectNodeContents("ghostedit_newlink").select(),document.getElementById("ghostedit_newlink").id=""):(n.create("http://"),i.selection.save(),n.focusedlink.href="http://",i.ui.toolbar.enabletab("link"),i.ui.toolbar.showtab("link"),document.getElementById("ghostedit_toolbar_linkurl").focus(),i.selection.save())}},n.selection={deleteContents:function(){return!1}},n.ui={update:function(){var e,t,r=!1;for(t=0;t<i.selection.nodepath.length;t++)e=i.selection.nodepath[t],e.tagName.toLowerCase()==="a"&&(r=e);r?r!==n.focusedlink&&n.focus(r):n.focusedlink&&n.unfocus()},show:function(e){var t,r,s;n.ui.hide(),t=document.createElement("span"),t.className="ghostedit_focusedlinkbox",t.id="ghostedit_focusedlinkbox",t.style.top=e.offsetTop+e.offsetHeight-1+"px",s=e.getClientRects()[e.getClientRects().length-1].left,t.style.left=s-i.editdiv.getBoundingClientRect().left+"px",r=document.createElement("a"),r.style.cursor="pointer",r.style.color="#333",r.innerHTML="<b>&#215;</b>&nbsp;remove&nbsp;link</a>",t.appendChild(r),i.contextuallayer.appendChild(t),t.style.MozUserSelect="none",t.contentEditable=!1,t.unselectable="on",t.onmousedown=function(e){return i.util.cancelEvent(e)},t.ondragstart=function(e){return i.util.cancelEvent(e)},t.ondraggesture=function(e){return i.util.cancelEvent(e)},t.onclick=function(e){return i.util.cancelEvent(e)},t.ondblclick=function(e){return i.util.cancelEvent(e)},t.onresizestart=function(e){return i.util.cancelEvent(e)},t.oncontrolselect=function(e){return i.util.cancelAllEvents(e)},i.util.addEvent(r,"click",i.util.preparefunction(n.remove,null,e)),n.el.focusedbox=t,n.el.focusedboxa=r},hide:function(){if(!n.el.focusedbox)return;i.contextuallayer.removeChild(n.el.focusedbox),n.el.focusedbox=null,n.el.focusedboxa=null}},n.create=function(e){i.history.saveUndoState();var t,n;typeof e=="undefined"&&(e="http://"),document.execCommand("CreateLink",!1,e),n=i.editdiv.getElementsByTagName("a");for(t=0;t<n.length;t+=1)n[t].setAttribute("data-ghostedit-elemtype","link"),n[t].setAttribute("data-ghostedit-handler","link");i.selection.save(),i.history.saveUndoState()},n.focus=function(e){n.focusedlink=e,n.ui.show(e),i.event.trigger("ui:newcontext",{context:"link"})},n.unfocus=function(){if(n.focusedlink===!1)return;n.ui.hide(),n.focusedlink=!1},n.remove=function(e){var t;e=e||n.focusedlink;if(!i.dom.isGhostBlock(e)||e.tagName.toLowerCase()!=="a")return!1;if(i.selection.saved.type!=="textblock")return!1;i.selection.saved.data.saveToDOM(),t=i.dom.extractContent(e),e.parentNode.insertBefore(t,e),e.parentNode.removeChild(e),i.selection.saved.data.restoreFromDOM().select(),i.selection.save()},n.updateurl=function(e){n.focusedlink!==!1&&n.focusedlink.href!==e&&(n.focusedlink.href=e,n.focusedlink.title=e,i.event.trigger("ui:message",{message:"URL updated to '"+e+"'",time:2,color:"success"}))},n.open=function(){n.focusedlink!==!1&&e.open(n.focusedlink.href)},i.api.plugin.register("link",n)})(window);