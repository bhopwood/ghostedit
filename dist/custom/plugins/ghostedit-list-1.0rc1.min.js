/*! GhostEdit WYSIWYG editor Copyright (c) 2010-2012 Nico Burns

Description:       An open source JavaScript WYSIWYG editor focused on usability
Homepage:          http://ghosted.it
License:           LGPL
Author:            Nico Burns <nico@nicoburns.com>
Version:           1.0rc1
Release Date:      2012-12-13
Browser Support:   Internet Explorer 6+, Mozilla Firefox 3.6+, Google Chrome, Apple Safari (latest), Opera (latest)
*/
(function(e,t){var n={elemid:0,itemelemid:0};n.enable=function(){ghostedit.event.addListener("postpaste",function(){var e,t,r,i,s;i=[],t=ghostedit.editdiv.getElementsByTagName("ul");for(e=0;e<t.length;e++)i.push(t[e]);r=ghostedit.editdiv.getElementsByTagName("ol");for(e=0;e<r.length;e++)i.push(r[e]);for(e=0;e<i.length;e++){s=i[e];if(!s.parentNode)continue;n.tidy(s)}}),ghostedit.inout.registerimporthandler(n.inout.importHTML,"ol","ul","li"),ghostedit.api.list=ghostedit.api.list||{},ghostedit.api.list.toggle=function(e){n.toggle(e)}},n.ghostevent=function(e,t,r,i){var s=!1,o,u=!1,a,f,l;switch(e){case"delete":l=t.getAttribute("data-ghostedit-elemtype");if(l==="list")return r==="ahead"||r==="behind"?(a=r==="ahead"?ghostedit.dom.getLastChildGhostBlock(t):ghostedit.dom.getFirstChildGhostBlock(t),n.ghostevent("delete",a,r,i)):!1;if(l==="listitem")return r==="ahead"||r==="behind"?(a=ghostedit.dom.getFirstChildGhostBlock(t),f=ghostedit.plugins.textblock.event.textdelete(a,r,i)):r==="top"?f=ghostedit.event.sendBackwards("delete",t,i):r==="bottom"&&(f=ghostedit.event.sendForwards("delete",t,i)),f}},n.dom={addchild:function(e,t,r,i,s){var o,u,a=!1,f=!1;s&&s.contentlength!==!1&&(f=s.contentlength<1?!0:!1),e.getAttribute("data-ghostedit-elemtype")==="listitem"&&(e=ghostedit.dom.getParentGhostBlock(e));if(e.getAttribute("data-ghostedit-elemtype")!=="list")return!1;anchorelem=r;while(anchorelem.getAttribute("data-ghostedit-elemtype")!=="listitem"){anchorelem=ghostedit.dom.getParentGhostBlock(anchorelem);if(anchorelem===null)return!1}return f&&ghostedit.dom.getNextSiblingGhostBlock(anchorelem)===!1&&ghostedit.plugins.textblock.isEmpty(r)&&(o=ghostedit.dom.getParentGhostBlock(e),handler=o.getAttribute("data-ghostedit-handler"),a=ghostedit.plugins[handler].dom.addchild(o,"after",e,i)),a?(e.removeChild(anchorelem),a):(i.getAttribute("data-ghostedit-elemtype")==="textblock"?(u=document.createElement("li"),n.itemelemid+=1,u.id="ghostedit_listitem_"+n.itemelemid,u.setAttribute("data-ghostedit-elemtype","listitem"),u.setAttribute("data-ghostedit-handler","list"),u.appendChild(i)):u=i,t==="before"?e.insertBefore(u,anchorelem):anchorelem.nextSibling!==null?e.insertBefore(u,anchorelem.nextSibling):e.appendChild(u),!0)},removechild:function(e,t){e&&e.getAttribute("data-ghostedit-elemtype")==="listitem"&&(t=e,e=ghostedit.dom.getParentGhostBlock(e));if(!e||!t)return!1;if(e.getAttribute("data-ghostedit-elemtype")!=="list")return!1;while(t.getAttribute("data-ghostedit-elemtype")!=="listitem"){t=ghostedit.dom.getParentGhostBlock(t);if(t===null)return!1}return t.parentNode!==e?!1:(e.removeChild(t),!0)}},n.selection={deleteContents:function(e,t){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B;k=!1,L=!1;if(!n.isList(e))return n.isListItem(e)?ghostedit.plugins.textblock.selection.deleteContents(ghostedit.dom.getFirstChildGhostBlock(e)):!1;if(ghostedit.selection.saved.type!=="textblock")return;C=ghostedit.selection.saved.data.clone(),l=e.childNodes,A=ghostedit.dom.getFirstChildGhostBlock(e),O=ghostedit.dom.getLastChildGhostBlock(e),T=lasso().setCaretToStart(A),N=lasso().setCaretToEnd(O),C.compareEndPoints("StartToStart",T)!==1?(k=!0,o=A):(o=C.getStartNode(),ghostedit.dom.isGhostBlock(o)||(o=ghostedit.dom.getParentGhostBlock(o))),C.compareEndPoints("EndToEnd",N)!==-1?(L=!0,u=O):(u=C.getEndNode(),ghostedit.dom.isGhostBlock(u)||(u=ghostedit.dom.getParentGhostBlock(u))),a=o;while(!ghostedit.dom.isChildGhostBlock(a,e))a=ghostedit.dom.getParentGhostBlock(a);f=u;while(!ghostedit.dom.isChildGhostBlock(f,e))f=ghostedit.dom.getParentGhostBlock(f);v=k;for(r=0;r<l.length;r+=1){cblock=l[r];if(!ghostedit.dom.isGhostBlock(cblock))continue;H=cblock.getAttribute("data-ghostedit-handler");if(!k&&cblock.id===a.id){ghostedit.plugins[H].selection.deleteContents(cblock),v=!0;if(cblock.id===f.id)break;continue}if(!L&&cblock.id===f.id){ghostedit.plugins[H].selection.deleteContents(cblock),v=!1;break}v&&(C.saveToDOM("seldelete-midlist"),e.removeChild(l[r]),C.restoreFromDOM("seldelete-midlist"),r--)}return!k&&!L&&a.getAttribute("data-ghostedit-elemtype")===f.getAttribute("data-ghostedit-elemtype")&&(ghostedit.plugins[a.getAttribute("data-ghostedit-handler")].merge(a,f,t),ghostedit.dom.getParentGhostBlock(f)||lasso().setToSelection().collapseToStart().select()),ghostedit.dom.getFirstChildGhostBlock(e)||e.appendChild(n.createItem("p")),!0}},n.inout={importHTML:function(e){var t,r,i,s,o;if(!e||!e.tagName)return!1;switch(e.tagName.toLowerCase()){case"ol":case"ul":return n.inout.importList(e);case"li":t=n.create("ul"),t.setAttribute("data-ghostedit-importinfo","wasinline"),r=0,i=e;do{console.log(i),o=n.inout.importListItem(i);if(!o)break;r+=1,t.appendChild(o),s=i,i=i.nextSibling,r>1&&s.parentNode.removeChild(s)}while(i&&i.nodeType===1&&i.tagName.toLowerCase()==="li");return r>0?t:!1}},exportHTML:function(e){if(!e||!ghostedit.dom.isGhostBlock(e))return!1;var t="",r,i;switch(e.getAttribute("data-ghostedit-elemtype")){case"list":r=ghostedit.dom.getFirstChildGhostBlock(e);if(!r)return!1;do result=n.inout.exportHTML(r),result&&(t+=result.content);while(r=ghostedit.dom.getNextSiblingGhostBlock(r));if(t.length<1)return!1;return i=e.tagName.toLowerCase()==="ol"?"ol":"ul",t="<"+i+">"+t+"</"+i+">",{content:t};case"listitem":elem=ghostedit.dom.getFirstChildGhostBlock(e);if(!elem)return!1;result=ghostedit.plugins.textblock.inout.exportHTML(elem),result&&(t+=result.content);if(t.length<1)return!1;return t="<li>"+t+"</li>",{content:t}}},importList:function(e){var t,r,i,s,o,u;if(!e||!e.tagName)return!1;u=e.tagName.toLowerCase();if(u!=="ul"&&u!=="ol")return!1;r=n.create(u);if(e.childNodes&&e.childNodes.length)for(t=0;t<e.childNodes.length;t+=1){o=e.childNodes[t];if(o.nodeType!==1||o.tagName.toLowerCase()!=="li")continue;s=n.inout.importListItem(o),s&&ghostedit.dom.isGhostBlock(s)&&r.appendChild(s)}return ghostedit.dom.getFirstChildGhostBlock(r)||r.appendChild(n.createItem("p")),r},importListItem:function(e){var t,r,i,s,o,u,a=!1;return!e||!e.tagName||!e.tagName.toLowerCase()==="li"?!1:(o=n.createItem(),u=ghostedit.dom.getFirstChildElement(e),ghostedit.plugins.textblock.inout.isHandleableNode(u)==="block"?a=ghostedit.plugins.textblock.inout.importHTML(u):(a=document.createElement("p"),a.innerHTML=e.innerHTML,a=ghostedit.plugins.textblock.inout.importHTML(a)),a?o.appendChild(a):o.appendChild(ghostedit.plugins.textblock.create("p")),o)}},n.paste={handle:function(e,t,r){var i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E;if(!ghostedit.dom.isGhostBlock(e)||!ghostedit.dom.isGhostBlock(t))return;if(t.tagName.toLowerCase()!=="ol"&&t.tagName.toLowerCase()!=="ul")return!1;if(t.tagName!==e.tagName){v=ghostedit.selection.saved.data.clone().collapseToStart().getParentNode();while(!ghostedit.dom.isChildGhostBlock(v,e))v=ghostedit.dom.getParentGhostBlock(v);m=n.split(e,"after",v);switch(m){case!1:return!0;case"atverystart":node1=ghostedit.dom.getPreviousSiblingGhostBlock(e),node2=e;break;case"atveryend":node1=e,node2=ghostedit.dom.getNextSiblingGhostBlock(e);break;default:node1=m.block1,node2=m.block2}return lasso().removeDOMmarkers("ghostedit_paste_start"),lasso().removeDOMmarkers("ghostedit_paste_end"),node1.innerHTML+="<span id='ghostedit_paste_start_range_start'>&#x200b;</span>",node2.innerHTML="<span id='ghostedit_paste_end_range_start'>&#x200b;</span>"+node2.innerHTML,!1}startblock=ghostedit.selection.saved.data.clone().collapseToStart().getParentNode();while(!ghostedit.dom.isGhostBlock(startblock))startblock=ghostedit.dom.getParentGhostBlock(startblock);endblock=ghostedit.selection.saved.data.clone().collapseToEnd().getParentNode();while(!ghostedit.dom.isGhostBlock(startblock))startblock=ghostedit.dom.getParentGhostBlock(startblock);if(r.isfirst){g=ghostedit.dom.getFirstChildGhostBlock(t),y=ghostedit.dom.getFirstChildGhostBlock(g),w=startblock,b=ghostedit.dom.getParentGhostBlock(w);if(y.tagName===w.tagName){w.innerHTML+=y.innerHTML,ghostedit.plugins.textblock.mozBrs.tidy(w),t.removeChild(g);if(!ghostedit.dom.getLastChildGhostBlock(t))return r.islast&&(E=ghostedit.dom.getNextSiblingGhostBlock(b),E&&(lasso().removeDOMmarkers("ghostedit_paste_start"),w.innerHTML=w.innerHTML+"<span id='ghostedit_paste_start_range_start'>&#x200b;</span>"+ghostedit.dom.getFirstChildGhostBlock(E).innerHTML,ghostedit.plugins.textblock.mozBrs.tidy(w),E.parentNode.removeChild(E))),!0;lasso().removeDOMmarkers("ghostedit_paste_start"),w.innerHTML+="<span id='ghostedit_paste_start_range_start'>&#x200b;</span>",ghostedit.plugins.textblock.mozBrs.tidy(w),startblock=b}}r.islast&&ghostedit.dom.getLastChildGhostBlock(t)&&(g=ghostedit.dom.getLastChildGhostBlock(t),y=ghostedit.dom.getFirstChildGhostBlock(g),w=endblock,y.tagName===w.tagName&&(lasso().removeDOMmarkers("ghostedit_paste_end"),w.innerHTML=y.innerHTML+"<span id='ghostedit_paste_end_range_start'>&#x200b;</span>"+w.innerHTML,t.removeChild(g),ghostedit.plugins.textblock.mozBrs.tidy(w))),v=startblock,firstitem=item=ghostedit.dom.getFirstChildGhostBlock(t);while(item=ghostedit.dom.getFirstChildGhostBlock(t))n.dom.addchild(e,"after",v,item),v=item;return r.isfirst||(lasso().removeDOMmarkers("ghostedit_paste_start"),v.innerHTML+="<span id='ghostedit_paste_start_range_start'>&#x200b;</span>",ghostedit.plugins.textblock.mozBrs.tidy(v)),r.islast||(lasso().removeDOMmarkers("ghostedit_paste_end"),endblock.innerHTML=endblock.innerHTML+"<span id='ghostedit_paste_end_range_start'>&#x200b;</span>"),!0}},n.isList=function(e){var t;return ghostedit.dom.isGhostBlock(e)?(t=e.tagName.toLowerCase(),t!=="ul"&&t!=="ol"?!1:!0):!1},n.isListItem=function(e){var t;return ghostedit.dom.isGhostBlock(e)?(t=e.tagName.toLowerCase(),t!=="li"?!1:!0):!1},n.create=function(e){return e.toLowerCase()!=="ol"&&(e="ul"),newElem=document.createElement(e),ghostedit.blockElemId+=1,newElem.id="ghostedit_list_"+ghostedit.blockElemId,newElem.setAttribute("data-ghostedit-iselem","true"),newElem.setAttribute("data-ghostedit-elemtype","list"),newElem.setAttribute("data-ghostedit-handler","list"),newElem},n.createItem=function(e){return newElem=document.createElement("li"),ghostedit.blockElemId+=1,newElem.id="ghostedit_list_item_"+ghostedit.blockElemId,newElem.setAttribute("data-ghostedit-iselem","true"),newElem.setAttribute("data-ghostedit-elemtype","listitem"),newElem.setAttribute("data-ghostedit-handler","list"),e&&newElem.appendChild(ghostedit.plugins.textblock.create(e)),newElem},n.remove=function(e){var t,n;return t=ghostedit.dom.getParentGhostBlock(e),n=t.getAttribute("data-ghostedit-handler"),ghostedit.plugins[n].dom.removechild(t,e)},n.focus=function(e){var t,n;return!e||e.nodeType!==1||e.getAttribute("data-ghostedit-elemtype")!=="list"?!1:(t=ghostedit.dom.getFirstChildGhostBlock(e),t?(t=ghostedit.dom.getFirstChildGhostBlock(t),t?(n=t.getAttribute("data-ghostedit-handler"),ghostedit.plugins[n].focus(t),!0):!1):!1)},n.merge=function(e,t,r){if(e===t)return e;if(!n.isList(e)||!n.isList(t))return n.isListItem(e)&&n.isListItem(t)?n.mergeItems(e,t,r):!1;if(e.tagName.toLowerCase()!==t.tagName.toLowerCase())return!1;while(child=ghostedit.dom.getFirstChildGhostBlock(t))e.appendChild(child);return n.remove(t),e},n.mergeItems=function(e,t,r){var i,s;return r===!1?e:e===t?e:!n.isListItem(e)||!n.isListItem(t)?!1:(i=ghostedit.dom.getFirstChildGhostBlock(e),s=ghostedit.dom.getFirstChildGhostBlock(t),!i||!s?!1:(result=ghostedit.plugins.textblock.merge(i,s),result))},n.split=function(e,t,r){var i,s,o,u,a,f;if(!ghostedit.dom.isGhostBlock(e)||!ghostedit.dom.isChildGhostBlock(r,e))return!1;t!=="before"&&(t="after"),i=ghostedit.dom.getFirstChildGhostBlock(e),s=ghostedit.dom.getLastChildGhostBlock(e);if(t==="before"&&i===r)return"atverystart";if(t==="after"&&s===r)return"atveryend";u=r,o=n.create(e.tagName.toLowerCase()),a=ghostedit.dom.getParentGhostBlock(e),f=a.getAttribute("data-ghostedit-handler");if(t==="before"){u=i;while(u){if(u===r)break;o.appendChild(u),u=ghostedit.dom.getFirstChildGhostBlock(e)}}else{u=ghostedit.dom.getNextSiblingGhostBlock(r);while(u)o.appendChild(u),u=ghostedit.dom.getNextSiblingGhostBlock(r)}return ghostedit.plugins[f].dom.addchild(a,t,e,o),t==="before"?{block1:o,block2:e}:{block1:e,block2:o}},n.toggle=function(e){var t,r,i,s,o,u,a,f,l=!1,c=!1,h,p,d,v=[],m=[],g=[],y,b,w,E,S,x=[];e=e==="ordered"?"ol":"ul",r=!1,intextblock=!1,u=!1;for(t=0;t<ghostedit.selection.nodepath.length;t++){f=ghostedit.selection.nodepath[t];switch(f.getAttribute("data-ghostedit-elemtype")){case"list":r=!0,i=f;break;case"textblock":intextblock=!0,o=f;break;case"container":u=!0,a=f}}return ghostedit.selection.savedRange.saveToDOM().select(),intextblock&&!r?(n.convertTextblock(o,e),(b=lasso().restoreFromDOM())&&b.select(),ghostedit.selection.save(),!0):r?(n.convertList(i,e),(b=lasso().restoreFromDOM())&&b.select(),ghostedit.selection.save(),!0):u?(n.convertContainerContents(a,e),(b=lasso().restoreFromDOM())&&b.select(),ghostedit.selection.save(),!0):!1},n.convertTextblock=function(e,t){var r,i,s,o,u;return r=n.create(t),s=e.tagName.toLowerCase(),i=n.createItem(),r.appendChild(i),o=ghostedit.dom.getParentGhostBlock(e),u=o.getAttribute("data-ghostedit-handler"),ghostedit.plugins[u].dom.addchild(o,"before",e,r),i.appendChild(e),n.tidy(r),lasso().setCaretToEnd(e).select(),ghostedit.selection.save(),e},n.convertList=function(e,t){var r,i=[],s,o=!1,u=!1,a,f,l,c=[],h=[],p=[],d,v,m,g,y;s=ghostedit.dom.getFirstChildGhostBlock(e);if(!s)return n.remove(e),!0;ghostedit.selection.savedRange.restoreFromDOM("",!1);do m=lasso().setCaretToEnd(s).compareEndPoints("StartToStart",ghostedit.selection.savedRange),m=m>=0?!0:!1,g=lasso().setCaretToStart(s).compareEndPoints("EndToEnd",ghostedit.selection.savedRange),g=g<=0?!0:!1,m?m&&g?h.push(s):p.push(s):c.push(s);while(s=ghostedit.dom.getNextSiblingGhostBlock(s));f=ghostedit.dom.getParentGhostBlock(e),l=f.getAttribute("data-ghostedit-handler");if(p.length>0){u=n.create(e.tagName);for(r=0;r<p.length;r++)u.appendChild(p[r]);ghostedit.plugins[l].dom.addchild(f,"after",e,u)}y=e;if(e.tagName.toLowerCase()===t)for(r=0;r<h.length;r++)s=ghostedit.dom.getFirstChildGhostBlock(h[r]),s&&(ghostedit.plugins[l].dom.addchild(f,"after",y,s),y=s),e.removeChild(h[r]);else{o=n.create(t);for(r=0;r<h.length;r++)o.appendChild(h[r]);ghostedit.plugins[l].dom.addchild(f,"after",e,o)}return c.length===0&&(n.remove(e),e=!1),e&&(n.tidy(e),i.push(e)),o&&(n.tidy(o),i.push(o)),u&&(n.tidy(u),i.push(u)),i},n.convertContainerContents=function(e,t){var r,i,s,o,u,a,f,l=!1,c=!1,h,p,d,v=[],m=[],g=[],y,b,w,E,S,x=[];f=ghostedit.dom.getFirstChildGhostBlock(e);do{w=lasso().setCaretToEnd(f).compareEndPoints("StartToStart",ghostedit.selection.savedRange),w=w>=0?!0:!1,E=lasso().setCaretToStart(f).compareEndPoints("EndToEnd",ghostedit.selection.savedRange),E=E<=0?!0:!1;if(w&&E)m.push(f);else if(!E)break}while(f=ghostedit.dom.getNextSiblingGhostBlock(f));for(r=0;r<m.length;r++){f=m[r];switch(f.getAttribute("data-ghostedit-elemtype")){case"list":f.tagName.toLowerCase()!==t&&n.convertList(f,t);break;case"textblock":n.convertTextblock(f,t)}}return!0},n.tidy=function(e){var t,r,i,s,o,u,a;return i=ghostedit.dom.getFirstChildGhostBlock(e),i?(t=ghostedit.dom.getPreviousSiblingGhostBlock(e),a=n.merge(t,e),a?(n.focus(a),ghostedit.selection.save(),n.tidy(a),!0):(r=ghostedit.dom.getNextSiblingGhostBlock(e),a=n.merge(e,r),a?(n.focus(a),ghostedit.selection.save(),n.tidy(a),!0):!0)):(n.remove(e),!0)},n.applydropevents=function(e){e.ondragenter=function(){return!1},e.ondragleave=function(){return!1},e.ondragover=function(){return!1},e.ondrop=function(e){var t,n;n=e.dataTransfer.getData("text/plain")||e.srcElement.id,t=document.getElementById(n),t.parentNode.insertBefore(t,this),ghostedit.image.focus(t),ghostedit.util.cancelEvent(e)},e.onresizestart=function(e){return ghostedit.util.cancelEvent(e)}},ghostedit.api.plugin.register("list",n)})(window);