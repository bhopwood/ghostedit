/*! GhostEdit WYSIWYG editor Copyright (c) 2010-2012 Nico Burns

Description:       An open source JavaScript WYSIWYG editor focused on usability
Homepage:          http://ghosted.it
License:           LGPL
Author:            Nico Burns <nico@nicoburns.com>
Version:           1.0rc1-pre
Release Date:      2012-12-16
Browser Support:   Internet Explorer 6+, Mozilla Firefox 3.6+, Google Chrome, Apple Safari (latest), Opera (latest)
*/
(function(e,t){var n={version:"1.0rc1",enabledplugins:[],uicontext:"",active:!1,isEditing:!0,blockElemId:0,editorchrome:null,debug:!1};n.api={},n.plugins={},e.ghostedit=n})(window),function(e,t){var n={},r,i,s=e.lasso,o=e.ghostedit;n.init=function(){n.paste.init(),n.cut.init()},r={savedcontent:null,savedundodata:null,savedundopoint:null,beforerangedata:"",afterrangedata:"",waitlength:0,postpastetidylist:[]},r.init=function(){o.event.addListener("init:after",function(){o.util.addEvent(o.editdiv,"paste",function(e){r.handle(e)})},"clipboard")},r.handle=function(e){return o.history.saveUndoState(),r.savedundodata=o.history.undoData,r.savedundopoint=o.history.undoPoint,r.triedpasteimage=!1,e.clipboardData&&e.clipboardData.getData?(/image/.test(e.clipboardData.types)&&(r.triedpasteimage=!0),/text\/html/.test(e.clipboardData.types)?o.editdiv.innerHTML=e.clipboardData.getData("text/html"):/text\/plain/.test(e.clipboardData.types)?o.editdiv.innerHTML=e.clipboardData.getData("text/plain").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):o.editdiv.innerHTML="",r.waitfordata(),o.util.cancelEvent(e)):(o.editdiv.innerHTML="",r.waitfordata(),!0)},r.waitfordata=function(){var e=o.editdiv;e.childNodes&&e.childNodes.length>0?r.process():setTimeout(r.waitfordata,20)},r.process=function(){var e,t,n,i,u,a,f,l;e=document.createElement("div"),console.log("raw paste content"),console.log(o.editdiv.cloneNode(!0)),e=o.plugins.container.inout.importHTML(o.editdiv),console.log("processed content"),console.log(e.innerHTML),o.history.undoData=r.savedundodata,o.history.undoPoint=r.savedundopoint,o.history.restoreUndoPoint(o.history.undoPoint),console.log(o.selection.saved),o.selection.deleteContents(),o.selection.save(),console.log(e),f=o.dom.getFirstChildGhostBlock(e);if(!f)return;o.selection.saved.data.isCollapsed()?(t=!0,o.selection.saved.data.saveToDOM("ghostedit_paste_start")):(t=!1,o.selection.saved.data.clone().collapseToStart().saveToDOM("ghostedit_paste_start"),o.selection.saved.data.clone().collapseToEnd().saveToDOM("ghostedit_paste_end")),console.log("test--------------------------------"),a=!1,r.trycounter=0,o.selection.saved.data.restoreFromDOM("ghostedit_paste_start",!1),u=o.selection.saved.data.getParentNode(),o.dom.isGhostBlock(u)||(u=o.dom.getParentGhostBlock(u));while(!a){if(!u){n=!1;break}i=u.getAttribute("data-ghostedit-handler");if(!o.plugins[i]||!o.plugins[i].paste)break;l={isfirst:!0,islast:o.dom.getFirstChildGhostBlock(e)===f?!0:!1,collapsed:t},console.log("Call handler: (first)"+i),console.log(f),a=o.plugins[i].paste.handle(u,f,l),console.log("result: "+a);if(a){n=!0,f.parentNode.removeChild(f);break}a||(u=o.dom.getParentGhostBlock(u)),o.selection.saved.data.restoreFromDOM("ghostedit_paste_start",!1)}f=o.dom.getLastChildGhostBlock(e);if(f&&(t===!1||n===!1)){r.trycounter=0,a=!1,o.selection.saved.data.isSavedRange("ghostedit_paste_end")?o.selection.saved.data.restoreFromDOM("ghostedit_paste_end",!1):o.selection.saved.data.restoreFromDOM("ghostedit_paste_start",!1),u=o.selection.saved.data.getParentNode(),o.dom.isGhostBlock(u)||(u=o.dom.getParentGhostBlock(u));while(!a){if(!u)break;i=u.getAttribute("data-ghostedit-handler");if(!o.plugins[i]||!o.plugins[i].paste)break;console.log("Call handler (last): "+i),console.log(f),a=o.plugins[i].paste.handle(u,f,{isfirst:!1,islast:!0,collapsed:t}),console.log("result: "+a);if(a){f.parentNode.removeChild(f);break}a||(u=o.dom.getParentGhostBlock(u)),o.selection.saved.data.isSavedRange("ghostedit_paste_end")?o.selection.saved.data.restoreFromDOM("ghostedit_paste_end",!1):o.selection.saved.data.restoreFromDOM("ghostedit_paste_start",!1);if(r.trycounter++>20)return}}console.log(e),f=o.dom.getFirstChildGhostBlock(e),r.trycounter=0;while(f){a=!1;while(!a){o.selection.saved.data.restoreFromDOM("ghostedit_paste_start",!1),s().isSavedRange("ghostedit_paste_end")&&o.selection.saved.data.setEndToRangeEnd(s().restoreFromDOM("ghostedit_paste_end",!1)),o.selection.saved.data.select(),u=o.selection.saved.data.getParentNode(),o.dom.isGhostBlock(u)||(u=o.dom.getParentGhostBlock(u));if(!u)break;i=u.getAttribute("data-ghostedit-handler");if(!o.plugins[i]||!o.plugins[i].paste)break;console.log("Call handler: "+i),console.log(f),a=o.plugins[i].paste.handle(u,f,{isfirst:!1,islast:!1,collapsed:t}),console.log("result: "+a);if(r.trycounter++>20)return}f=o.dom.getNextSiblingGhostBlock(f)}o.selection.saved.data.restoreFromDOM("ghostedit_paste_start",!0).select(),o.selection.saved.data.isSavedRange("ghostedit_paste_end")&&o.selection.saved.data.restoreFromDOM("ghostedit_paste_end",!0).select(),o.selection.save(),o.history.undoData=r.savedundodata,o.history.undoPoint=r.savedundopoint,o.history.saveUndoState(),r.triedpasteimage&&(o.ui.message.show("You cannot paste images into the editor, please use the add image button instead",2,"warn"),o.event.trigger("ui:message",{message:"You cannot paste images into the editor, please use the add image button instead",time:2,color:"warn"})),o.event.trigger("clipboard:paste:after")},i={savedcontent:null,savedundodata:null,savedundopoint:null},i.init=function(){o.event.addListener("init:after",function(){o.util.addEvent(o.editdiv,"cut",function(e){i.handle(e)})},"clipboard")},i.handle=function(){return o.history.saveUndoState(),i.savedundodata=o.history.undoData,i.savedundopoint=o.history.undoPoint,setTimeout(i.cleanup,20),!0},i.cleanup=function(){o.history.undoData=i.savedundodata,o.history.undoPoint=i.savedundopoint,o.history.restoreUndoPoint(o.history.undoPoint),o.selection.deleteContents(),o.selection.save(),o.history.saveUndoState()},n.paste=r,n.cut=i,e.ghostedit.clipboard=n}(window),function(e,t){var n={},r=e.lasso,i=e.ghostedit;n.enable=function(){return!0},n.ghostevent=function(e,n,r,s){var o=!1,u,a=!1,f,l;switch(e){case"deletebehind":f=n.childNodes;for(l=f.length-1;l>=0;l-=1)if(f[l].getAttribute("data-ghostedit-elemtype")!==t&&f[l].getAttribute("data-ghostedit-elemtype")!==!1&&f[l].getAttribute("data-ghostedit-elemtype")!==null)if(o===!0){u=f[l].getAttribute("data-ghostedit-elemtype");if(i.plugins[u].ghostevent("deletefromahead",f[l],s)){a=!0;break}}else f[l]===s.sourceblock&&(o=!0);break;case"deleteahead":f=n.childNodes;for(l=0;l<f.length;l+=1)if(f[l].getAttribute("data-ghostedit-elemtype")!==t&&f[l].getAttribute("data-ghostedit-elemtype")!==!1&&f[l].getAttribute("data-ghostedit-elemtype")!==null)if(o===!0){u=f[l].getAttribute("data-ghostedit-elemtype");if(i.plugins[u].ghostevent("deletefrombehind",f[l],s)){a=!0;break}}else f[l]===s.sourceblock&&(o=!0)}},n.dom={addchild:function(e,t,n,r){return t==="before"?e.insertBefore(r,n):n.nextSibling!==null?e.insertBefore(r,n.nextSibling):e.appendChild(r),!0},removechild:function(e,t){return!e||!t?!1:(e.removeChild(t),!0)}},n.selection={deleteContents:function(e,t){var n,s,o,u,a,f=!1,l=!1,c,h,p,d,v,m,g,y,b;if(i.selection.saved.type!=="textblock")return!1;y=i.selection.saved.data,m=e.childNodes,s=i.dom.getFirstChildGhostBlock(e),o=i.dom.getLastChildGhostBlock(e),u=r().setCaretToStart(s),a=r().setCaretToEnd(o),y.compareEndPoints("StartToStart",u)!==1?(f=!0,c=s):(c=y.getStartNode(),i.dom.isGhostBlock(c)||(c=i.dom.getParentGhostBlock(c))),y.compareEndPoints("EndToEnd",a)!==-1?(l=!0,h=o):(h=y.getEndNode(),i.dom.isGhostBlock(h)||(h=i.dom.getParentGhostBlock(h))),d=c;while(!i.dom.isChildGhostBlock(d,e))d=i.dom.getParentGhostBlock(d);v=h;while(!i.dom.isChildGhostBlock(v,e))v=i.dom.getParentGhostBlock(v);g=!1;for(n=0;n<m.length;n+=1){p=m[n];if(!i.dom.isGhostBlock(p))continue;b=p.getAttribute("data-ghostedit-handler");if(p.id===d.id){i.plugins[b].selection.deleteContents(p),g=!0;continue}if(p.id===v.id){i.plugins[b].selection.deleteContents(p),g=!1;break}g&&(e.removeChild(m[n]),n--)}return d.getAttribute("data-ghostedit-elemtype")===v.getAttribute("data-ghostedit-elemtype")&&(i.plugins[d.getAttribute("data-ghostedit-elemtype")].merge(d,v,t),i.dom.getParentGhostBlock(v)||r().setToSelection().collapseToStart().select()),i.dom.getFirstChildGhostBlock(e)||e.appendChild(i.textblock.create("p")),!0}},n.inout={importHTML:function(e){var t,r,s,o,u,a;if(!e||e.childNodes.length<1)return!1;t=n.create();for(s=0;s<e.childNodes.length;s+=1){u=e.childNodes[s];if(u.nodeType!==1&&u.nodeType!==3)continue;a=u.nodeType===3?"#textnode":u.tagName.toLowerCase(),i.inout.importhandlers[a]?(r=i.inout.importhandlers[a].call(this,u),r&&i.dom.isGhostBlock(r)&&t.appendChild(r)):u.childNodes.length>0&&(o=u.childNodes.length,u.parentNode.insertBefore(i.dom.extractContent(u),u),u.parentNode.removeChild(u),s-=1)}return i.dom.getFirstChildGhostBlock(t)||t.appendChild(i.plugins.textblock.create("p")),t},exportHTML:function(e){if(!e||!i.dom.isGhostBlock(e)||e.getAttribute("data-ghostedit-elemtype")!=="container")return!1;var t=0,n,r,s="",o=0,u,a;for(t=0;t<e.childNodes.length;t+=1){n=i.dom.isGhostBlock(e.childNodes[t])?e.childNodes[t]:!1;if(!n)continue;a=n.getAttribute("data-ghostedit-handler");if(!a||!i.plugins[a])continue;r=i.plugins[a].inout.exportHTML(n),r&&(s+=r.content,o++),o<=3&&(u=s)}return{content:s,snippet:u}}},n.paste={handle:function(e,t,s){var o,u,a,f;if(!i.dom.isGhostBlock(e)||!i.dom.isGhostBlock(t))return!0;if(s.isfirst||s.islast)return!1;o=i.selection.saved.data,u=o.clone().collapseToStart().getParentElement(),o.saveToDOM("ghostedit_paste_start"),u===e&&(f=document.getElementById("ghostedit_paste_start_range_start"),u=i.dom.getPreviousSiblingGhostBlock(f)||f);while(u.parentNode!==e){u=u.parentNode;if(u===null||!u.parentNode)return!0}return a=t.cloneNode(!0),r().removeDOMmarkers("ghostedit_paste_start"),a.innerHTML+="<span id='ghostedit_paste_start_range_start' class='t3'>&#x200b;</span>",n.dom.addchild(e,"after",u,a),f&&f.parentNode&&f.parentNode.removeChild(f),!0}},n.isChildGhostBlock=function(e,n){var r;if(!e)return!1;if(e.nodeType!==1)return!1;if(e.getAttribute("data-ghostedit-elemtype")===t)return!1;if(e.getAttribute("data-ghostedit-elemtype")===!1)return!1;if(e.getAttribute("data-ghostedit-elemtype")===null)return!1;for(r=0;r<n.length;r+=1)if(e===n[r])return!0;return!1},n.create=function(){var e;return e=document.createElement("div"),i.blockElemId+=1,e.id="ghostedit_container_"+i.blockElemId,e.setAttribute("data-ghostedit-iselem","true"),e.setAttribute("data-ghostedit-elemtype","container"),e.setAttribute("data-ghostedit-handler","container"),e},n.focus=function(e){var t,n;return!e||e.nodeType!==1||e.getAttribute("data-ghostedit-elemtype")!=="container"?!1:(t=i.dom.getFirstChildGhostBlock(e),t?(n=t.getAttribute("data-ghostedit-handler"),i.plugins[n].focus(t),!0):!1)},i.api.plugin.register("container",n)}(window),function(e,t){var n={};n.getNodeOffset=function(e){var t,n;if(!e||!e.parentNode)return;t=0,n=e.parentNode.childNodes;while(n[t]!==e)t+=1;return t},n.extractContent=function(e){var t=document.createDocumentFragment(),n;while(n=e.firstChild)t.appendChild(n);return t},n.cloneContent=function(e){var t,n,r=document.createDocumentFragment();for(n=0;n<e.childNodes.length;n++)t=e.childNodes[n],r.appendChild(t.cloneNode(!0));return r},n.parse=function(e,r){var i=!1,s,o,u,a,f,l,c,h,p,d;if(!e||!r||!e.nodeType)return!1;r.textnode=r.textnode||{},r.tags=r.tags||{};if(e.nodeType===3)return l=r.textnode.clean?e.nodeValue.replace(/[\n\r\t]/g,""):e.nodeValue,l.length>0?document.createTextNode(l):!1;if(e.nodeType!==1)return!1;c=e.tagName.toLowerCase(),h={contentsonly:!0};if(r.tags[c]){h=r.tags[c],typeof h.template=="string"&&(h=h.template),typeof h=="string"&&r.templates[h]&&(h=r.templates[h]);if(typeof h=="string")return!1}i=h.contentsonly?document.createDocumentFragment():document.createElement(e.tagName.toLowerCase());if(!h.ignorechildren){s=e.childNodes;for(u=0;u<s.length;u++)o=n.parse(s[u],r),o&&i.appendChild(o)}if(h.contentsonly)return i.childNodes.length>0?i:!1;if(h.attributes)for(u=0;u<h.attributes.length;u++){p=h.attributes[u],typeof p=="string"&&(p={name:p});if(typeof p.name!="string")break;f=p.value||p.name==="class"?e.className:e.getAttribute(p.name);if(f===t)break;p.copy=!0;if(p.allowedvalues){p.copy=!1;for(a=0;a<p.allowedvalues.length;a++)if(p.allowedvalues[u]===f){p.copy=!0;break}}p.copy&&(p.name==="class"?i.className=f:i.setAttribute(p.name,f))}if(h.styles)for(u=0;u<h.styles.length;u++){d=h.styles[u],typeof d=="string"&&(d={name:d});if(typeof d.name!="string")break;d.name==="float"&&(d.name=e.style.cssFloat?"cssFloat":"styleFloat"),f=d.value||e.style[d.name];if(f===t)break;d.copy=!0;if(d.allowedvalues){d.copy=!1;for(a=0;a<d.allowedvalues.length;a++)if(d.allowedvalues[a]===f){d.copy=!0;break}}d.copy&&(i.style[d.name]=f)}return i},n.isGhostBlock=function(e){if(!e||!e.nodeType||e.nodeType!==1)return!1;var n=e.getAttribute("data-ghostedit-elemtype");return n!==t&&n!==!1&&n!==null?!0:!1},n.isChildGhostBlock=function(e,n){var r;if(!e||!n||!n.childNodes)return!1;if(e.nodeType!==1)return!1;if(e.getAttribute("data-ghostedit-elemtype")===t)return!1;if(e.getAttribute("data-ghostedit-elemtype")===!1)return!1;if(e.getAttribute("data-ghostedit-elemtype")===null)return!1;var i=n.childNodes;for(r=0;r<i.length;r+=1)if(e===i[r])return!0;return!1},n.isGhostToplevel=function(e){return e&&e.getAttribute("data-ghostedit-isrootnode")===!0?!0:!1},n.getParentGhostBlock=function(e){if(!e)return!1;do{e=e.parentNode;if(e===null)return!1}while(!n.isGhostBlock(e));return e},n.getFirstChildGhostBlock=function(e){var t,r;if(!e||!e.childNodes)return!1;t=e.childNodes;for(r=0;r<t.length;r+=1)if(n.isGhostBlock(t[r]))return t[r];return!1},n.getLastChildGhostBlock=function(e){var t,r;if(!e||!e.childNodes)return!1;t=e.childNodes;for(r=t.length-1;r>=0;r-=1)if(n.isGhostBlock(t[r]))return t[r];return!1},n.getPreviousSiblingGhostBlock=function(e){var t,r,i;if(!e||!e.parentNode)return!1;t=e.parentNode,r=n.getNodeOffset(e)-1,i=t.childNodes;do{if(n.isGhostBlock(i[r])===!0)return i[r];r-=1}while(r>=0);return!1},n.getNextSiblingGhostBlock=function(e){var t,r,i;if(!e||!e.parentNode)return!1;t=e.parentNode,r=n.getNodeOffset(e)+1,i=t.childNodes;do{if(n.isGhostBlock(i[r])===!0)return i[r];r+=1}while(r<i.length);return!1},n.getParentElement=function(e){if(e.nodeType!==1)while(e.nodeType!==1){e=e.parentNode;if(e===null)return null}return e},n.isDescendant=function(e,t){var n=t.parentNode;while(n!==null){if(n===e)return!0;n=n.parentNode}return!1},n.getFirstChildElement=function(e){var t,n;if(!e||!e.childNodes)return!1;t=e.childNodes;for(n=0;n<t.length;n+=1)if(t[n].nodeType===1)return t[n];return!1},n.getCertainParent=function(e,t){var n=[].slice.call(arguments);n.shift();if(!e.apply(this,n))while(!e.apply(this,n)){t=t.parentNode,n[0]=t;if(t===null)return!1}return t},e.ghostedit.dom=n}(window),function(e,t){var n={listeners:[],listenerid:0,eventtypes:[],cancelKeypress:!1},r=e.ghostedit;n.keydown=function(t,i){var s,o,u,a;r.selection.save(!1),i=(!i||!i.istest)&&e.event!==null?e.event:i,s=i.keyCode!==null?i.keyCode:i.charCode,n.trigger("input:keydown",{event:event,keycode:s});switch(s){case 8:case 46:n.cancelKeypress=!1;if(r.selection.savedRange.isCollapsed()===!1)return r.history.saveUndoState(),r.selection.deleteContents(s===8?"collapsetostart":"collapsetoend"),r.history.saveUndoState(),n.cancelKeypress=!0,r.util.cancelEvent(i);break;case 83:if(i.ctrlKey)return r.api.save(),r.util.cancelEvent(i);break;case 66:if(i.ctrlKey)return r.textblock.format.bold(),r.util.cancelEvent(i);break;case 73:if(i.ctrlKey&&!i.shiftKey)return r.textblock.format.italic(),r.util.cancelEvent(i);break;case 85:if(i.ctrlKey)return r.textblock.format.underline(),r.util.cancelEvent(i);break;case 90:if(i.ctrlKey)return r.history.undo(),r.util.cancelEvent(i);break;case 89:if(i.ctrlKey)return r.history.redo(),r.util.cancelEvent(i)}o=r.selection.getContainingGhostBlock();for(;;){u=o.getAttribute("data-ghostedit-handler"),a=r.plugins[u].ghostevent("keydown",o,"self",{keycode:s,event:i});if(a===!0)break;o=r.dom.getParentGhostBlock(o);if(!o)break}return r.selection.save(),!0},n.keypress=function(i,s){var o,u,a,f,l,c;r.selection.save(),l=r.editdiv.innerHTML.length,c=r.history.undoData[r.history.undoPoint]!==t?r.history.undoData[r.history.undoPoint].content.string.length:0,s=(!s||!s.istest)&&e.event!==null?e.event:s,o=s.keyCode!==null?s.keyCode:s.charCode,n.trigger("input:keydown",{event:event,keycode:o}),r.selection.saved.type!=="none"&&!r.selection.savedRange.isCollapsed()&&!s.ctrlKey&&r.selection.deleteContents("collapsetostart");switch(o){case 8:if(n.cancelKeypress===!0)return n.cancelKeypress=!1,r.util.cancelEvent(s);break;case 13:r.util.cancelEvent(s)}u=r.selection.getContainingGhostBlock();for(;;){a=u.getAttribute("data-ghostedit-handler"),f=r.plugins[a].ghostevent("keypress",u,"self",{keycode:o,event:s});if(f===!0)break;u=r.dom.getParentGhostBlock(u);if(!u)break}return r.selection.save(),!0},n.addListener=function(e,t,r){var i,s,o,u;if(typeof t!="function")return!1;i=n.listeners;if(!i[e]||typeof i[e]!="object"||!(i[e]instanceof Array))i[e]=[];s=n.eventtypes,o=!0;for(u=0;u<s.length;u++)if(s[u]===e){o=!1;break}return o&&s.push(e),n.listenerid++,i[e].push({id:n.listenerid,callback:t,revokekey:r}),n.listenerid},n.removeListener=function(e,t){var r=n.listeners,i,s=[];if(!r[e])return;for(i=0;i<r[e].length;i++)r[e].id!==t&&s.push(r[e][i]);r[e]=s},n.removeAllListeners=function(e){var t,i,s,o,u,a=[];if(!e)return;t=n.listeners,i=n.eventtypes;for(o=0;o<i.length;o++){s=i[o];for(u=0;u<t[s].length;u++)(!t[s][u].revokekey||t[s][u].revokekey!==e)&&a.push(t[s][u]);t[s]=r.util.cloneObject(a),a=[]}},n.trigger=function(i,s){var o=n.listeners,u;s===t&&(s={});if(!o[i]||typeof o[i]!="object"||!(o[i]instanceof Array))return;r.debug&&(e.console.log(i),e.console.log(s));for(u=0;u<o[i].length;u++)o[i][u].callback.call(this,s)},n.sendBackwards=function(e,t,i){var s=!1,o,u,a;i||(i={});if(!r.dom.isGhostBlock(t))return!1;o=t;for(;;){if(s=r.dom.getPreviousSiblingGhostBlock(o))a="ahead";else if(s=r.dom.getParentGhostBlock(o))a="top";u=n.send(e,s,a,i);if(!u)return!1;if(u.handled===!0)return!0;o=s}},n.sendForwards=function(e,t,i){var s=!1,o,u,a;i||(i={});if(!r.dom.isGhostBlock(t))return!1;o=t;for(;;){if(s=r.dom.getNextSiblingGhostBlock(o))a="behind";else if(s=r.dom.getParentGhostBlock(o))a="bottom";u=n.send(e,s,a,i);if(!u)return!1;if(u.handled===!0)return!0;o=s}},n.send=function(e,t,n,i){var s,o;return t?(s=t.getAttribute("data-ghostedit-handler"),!r.plugins[s]||!r.plugins[s].ghostevent?!1:(o=r.plugins[s].ghostevent(e,t,n,i),{handled:o})):!1},e.ghostedit.event=n}(window),function(e,t){var n={},r=e.ghostedit;n.init=function(){n.reset(),r.event.addListener("selection:change",function(){n.selectionchanged=!0}),r.api.undo=function(){return n.undo()},r.api.redo=function(){return n.redo()}},n.reset=function(){n.undoData=[],n.undoPoint=0,n.selectionchanged=!0},n.saveUndoState=function(e){var t,i,s,o,u,a,f=r.editdiv;e!==!0&&(e=!1),r.event.trigger("presaveundostate"),t=n.undoPoint,i=n.undoData,a=i[t],a||(e=!0),u={selection:{type:r.selection.saved.type,data:r.selection.saved.data},content:{string:f.innerHTML}},e||(s=a.content.string!==u.content.string?!0:!1,o=!r.selection.isSameAs(a.selection));if(e||o||s)u.content.dom=r.dom.extractContent(f.cloneNode(!0)),e||s?(t>0&&n.undoData.splice(0,t),n.undoData.unshift(u),n.undoPoint=0):n.undoData[t]=u;r.event.trigger("postsaveundostate")},n.restoreUndoPoint=function(e){var t=n.undoData,i=t[e];if(!i||i.content.string.length<1)return!1;r.editdiv.innerHTML="",r.editdiv.appendChild(r.dom.cloneContent(i.content.dom)),r.selection.restore(i.selection.type,i.selection.data),r.selection.save()},n.undo=function(){var e=n.undoPoint,i=n.undoData,s=r.editdiv;i[e+1]!==t&&i[e+1].content.string.length>0&&(r.event.trigger("history:undo:before"),i[e].content.string!==s.innerHTML?(n.saveUndoState(),e=1):(e===0&&n.saveUndoState(),e=n.undoPoint,e+=1),n.restoreUndoPoint(e),n.undoPoint=e,n.undoData=i,r.event.trigger("history:undo:after"))},n.redo=function(){var e=n.undoPoint,i=n.undoData,s=r.editdiv;e>0&&i[e-1]!==t&&i[e-1].content.string.length>0&&(r.event.trigger("history:redo:before"),i[e].content.string!==s.innerHTML?n.saveUndoState(!0):(e-=1,n.restoreUndoPoint(e),n.undoPoint=e,n.undoData=i),r.event.trigger("history:redo:after"))},e.ghostedit.history=n}(window),function(e,t){e.ghostedit.init=function(t,n){typeof t=="string"&&(t=document.getElementById(t));var r,i,s=e.ghostedit,o,u,a,f;s.options={},s.options=n||{},s.options.debug&&(s.debug=!0),s.browserEngine=s.util.detectEngines(),s.useMozBr=s.browserEngine.gecko!==0||s.browserEngine.webkit!==0||s.browserEngine.opera!==0,t.style.display="none",s.sourceelem=t,o=document.createElement("div"),o.className="ghostedit_wrapper",t.parentNode.insertBefore(o,t),s.wrapdiv=o,u=document.createElement("div"),u.id="ghostedit_workspace",u.className="ghostedit_workspace",o.appendChild(u),s.workspace=u,a=document.createElement("div"),a.id="ghostedit_uilayer",a.className="ghostedit_uilayer",a.innerHTML="<span style='position: absolute; display: none;left: 0; top: 0;line-height: 0'>ie bug fix</span>",u.appendChild(a),s.contextuallayer=a,s.history.init(),s.inout.init(),s.clipboard.init(),s.options.plugins=s.options.plugins||[],s.options.plugins.unshift("container","textblock");if(s.options.plugins)for(r=0;r<s.options.plugins.length;r++)s.api.plugin.enable(s.options.plugins[r]);s.event.trigger("init"),s.editdiv=s.inout.importHTML(s.sourceelem),u.appendChild(s.editdiv),i=s.editdiv.getAttribute("data-ghostedit-handler"),s.plugins[i].focus(s.editdiv);try{document.execCommand("styleWithCSS",!1,!1)}catch(l){}try{document.execCommand("enableObjectResizing",!1,!1)}catch(l){}s.selection.save(),s.history.reset(),s.history.saveUndoState(),f=document.getElementsByTagName("html")[0],s.util.addEvent(f,"dragenter",s.util.cancelEvent),s.util.addEvent(f,"dragleave",s.util.cancelEvent),s.util.addEvent(f,"dragover",s.util.cancelEvent),s.util.addEvent(f,"drop",s.util.cancelEvent),s.util.addEvent(o,"click",function(e){s.util.preventBubble(e)}),s.util.addEvent(s.editdiv,"click",s.selection.save),s.util.addEvent(s.editdiv,"mouseup",s.selection.save),s.util.addEvent(s.editdiv,"keyup",s.selection.save),s.util.addEvent(s.editdiv,"keydown",function(e){s.event.keydown(this,e)}),s.util.addEvent(s.editdiv,"keypress",function(e){s.event.keypress(this,e)}),s.util.addEvent(s.editdiv,"dragenter",s.util.cancelEvent),s.util.addEvent(s.editdiv,"dragleave",s.util.cancelEvent),s.util.addEvent(s.editdiv,"dragover",s.util.cancelEvent),s.util.addEvent(s.editdiv,"drop",s.util.cancelEvent),s.event.addListener("ui:newcontext",function(e){s.uicontext=e.context}),s.editdiv.focus(),s.plugins.container.focus(s.editdiv),s.event.trigger("init:after")}}(window),function(e,t){var n={},r=e.ghostedit;n.init=function(){n.reset(),r.event.addListener("selection:change",function(){r.history.selectionchanged=!0}),r.api.importHTML=function(e){return n.importHTML(e)},r.api.exportHTML=function(){return n.exportHTML()}},n.reset=function(){n.importhandlers=[]},n.importHTML=function(e){var t;return!e||e.childNodes.length<1?!1:(t=r.plugins.container.inout.importHTML(e),t.className="ghostedit_editdiv",t.setAttribute("data-ghostedit-isrootnode","true"),t.contentEditable="true",r.event.trigger("import:after",{editdiv:t}),t)},n.exportHTML=function(){var e,t=r.editdiv;return r.event.trigger("export:before"),t.contentEditable=!1,e=r.plugins.container.inout.exportHTML(t,!1),t.contentEditable=!0,r.event.trigger("export:after"),e},n.openPreview=function(){e.open(r.options.previewurl)},n.registerimporthandler=function(e){var t,r,i;if(typeof e!="function")return!1;if(arguments.length<2)return!1;r=Array.prototype.slice.call(arguments),r.shift();for(t=0;t<r.length;t++)i=r[t],n.importhandlers[i]=e},e.ghostedit.inout=n}(window),function(e,t){var n={},r=e.ghostedit;n.register=function(e,t){return r.plugins[e]?!1:(r.plugins[e]=t,!0)},n.enable=function(e){if(!r.plugins[e])return!1;r.enabledplugins[e]&&n.disable(e);var t=r.plugins[e];typeof t.enable=="function"&&t.enable(),r.enabledplugins[e]=!0},n.disable=function(e){if(!r.enabledplugins[e]||!r.plugins[e])return!1;var t=r.plugins[e];typeof t.disable=="function"&&t.disable(),r.enabledplugins[e]=!1},e.ghostedit.api.plugin=n}(window),function(e,t){var n={savedRange:null,nodepath:[],saved:{type:"none",data:null},archived:{type:"none",data:null}},r=e.ghostedit,i=e.lasso;n.save=function(e){var t;return e!==!1&&(e=!0),t=i().setToSelection(),n.isInEditdiv(t.getStartNode())?(n.saved.type="textblock",n.saved.data=t,n.savedRange=n.saved.data,r.event.trigger("selection:change"),n.updatePathInfo(),e&&r.event.trigger("ui:update"),!0):(n.saved.type="none",!1)},n.set=function(e,t,i){i!==!1&&(i=!0);if(typeof e!="string")return;return n.saved.type=e,n.saved.data=t,n.savedRange=n.saved.data,n.updatePathInfo(),r.event.trigger("selection:change"),i&&r.event.trigger("ui:update"),!0},n.restore=function(e,t,i){if(!e||typeof e!="string")e=n.saved.type;t||(t=n.saved.data),e==="none"&&i&&(e=n.archived.type,t=n.archived.data);if(e==="none")return n.clear(),!0;if(r.plugins[e]&&r.plugins[e].selection.restore)return r.plugins[e].selection.restore(t)?!0:(n.clear(),!1)},n.restoreValid=function(e,t){return n.restore(e,t,!0)},n.deleteContents=function(e){e!=="collapsetostart"&&e!=="collapsetoend"&&(e=!1);var t,s,o;o=n.getContainingGhostBlock();for(;;){t=o.getAttribute("data-ghostedit-handler"),s=r.plugins[t].selection.deleteContents(o,e);if(s===!0)break;o=r.dom.getParentGhostBlock(o);if(!o)break}switch(e){case"collapsetostart":i().setToSelection().collapseToStart().select();break;case"collapsetoend":i().setToSelection().collapseToEnd().select()}n.save()},n.isSameAs=function(e){return!e||!e.type?!1:e.type!==n.saved.type?!1:e.type==="none"?!0:r.plugins[e.type]&&r.plugins[e.type].selection.compare?r.plugins[e.type].selection.compare(e.data,n.saved.data):!1},n.clear=function(){i().clearSelection(),n.saved={type:"none",data:null}},n.isInEditdiv=function(e){if(e.nodeType!==1||e.getAttribute("data-ghostedit-isrootnode")!=="true")while(e.nodeType!==1||e.getAttribute("data-ghostedit-isrootnode")!=="true"){if(e===null)return!1;e=e.parentNode;if(e===null)return!1}return!0},n.updatePathInfo=function(e){e||(e=n.saved.data),e.nodeType||(e=e.getParentNode()),n.nodepath=[];if(e.nodeType!==1||e.getAttribute("data-ghostedit-isrootnode")!=="true")while(e.nodeType!==1||e.getAttribute("data-ghostedit-isrootnode")!=="true"){if(e===null)return null;e.nodeType===1&&n.nodepath.push(e),e=e.parentNode;if(e===null)return!1}e&&e.getAttribute("data-ghostedit-isrootnode")==="true"&&n.nodepath.push(e)},n.getContainingGhostBlock=function(){var e=n.saved.data;e.nodeType||(e=e.getParentNode());if(!e)return!1;while(!r.dom.isGhostBlock(e)){e=e.parentNode;if(e===null)return!1}return e},e.ghostedit.selection=n}(window),function(e,t){var n={},r=e.lasso,i=e.ghostedit;n.enable=function(){return n.format.init(),i.inout.registerimporthandler(n.inout.importHTML,"p","h1","h2","h3","h4","h5","h6"),i.inout.registerimporthandler(n.inout.importHTML,"#textnode","b","strong","i","em","u","strike","span"),i.event.addListener("postsaveundostate",function(){i.selection.saved.type==="textblock"&&i.selection.saved.data.bookmarkify(i.editdiv)}),i.event.addListener("postsaveundostate",function(){i.selection.saved.type==="textblock"&&(i.selection.saved.data=i.selection.saved.data.clone())}),i.api.insert=i.api.insert||{},i.api.insert.character=function(e){return n.insert.character(e)},i.api.insert.br=function(){return n.insert.br},!0},n.ghostevent=function(e,t,r,i){switch(e){case"delete":return n.event.textdelete(t,r,i);case"keydown":switch(i.keycode){case 8:return n.event.backspace(t,i.event);case 46:return n.event.deletekey(t,i.event)}break;case"keypress":if(i.keycode===13)return n.event.enterkey(t,i.event)}},n.event={textdelete:function(e,t,s){var o,u,a;switch(t){case"ahead":return i.history.saveUndoState(),n.isEmpty(e)?(o=i.dom.getParentGhostBlock(e),u=o.getAttribute("data-ghostedit-handler"),i.plugins[u].dom.removechild(o,e)):(e.innerHTML+="<span id='ghostedit_selection_marker'>&#x200b;</span>",s.merge&&s.merge.sourcecontent&&(s.merge.contenttype==="inlinehtml"||s.merge.contenttype==="text")&&(e.innerHTML+=s.merge.sourcecontent),n.mozBrs.tidy(e),s.merge.callback(),r().selectNode("ghostedit_selection_marker").select(),document.getElementById("ghostedit_selection_marker").parentNode.removeChild(document.getElementById("ghostedit_selection_marker")),i.selection.save()),i.history.saveUndoState(!0),!0;case"behind":return a=i.selection.getContainingGhostBlock(),s={merge:{contenttype:"inlinehtml",sourcecontent:e.innerHTML,callback:i.util.preparefunction(function(e){var t=e.parentNode,n=t.getAttribute("data-ghostedit-handler");i.plugins[n].dom.removechild(t,e)},!1,e)}},i.event.sendBackwards("delete",e,s),!0}},backspace:function(e,t){if(n.selection.isAtStartOftextblock()!==!0)return!0;var r={merge:{contenttype:"inlinehtml",sourcecontent:e.innerHTML,callback:i.util.preparefunction(function(e){var t=e.parentNode,n=t.getAttribute("data-ghostedit-handler");i.plugins[n].dom.removechild(t,e)},!1,e)}};return i.event.sendBackwards("delete",e,r),i.event.cancelKeypress=!0,i.util.cancelEvent(t),!0},deletekey:function(e,t){return n.selection.isAtEndOftextblock()!==!0?!0:(i.event.sendForwards("delete",e),i.event.cancelKeypress=!0,i.util.cancelEvent(t),!0)},enterkey:function(e,t){return i.history.saveUndoState(),t.shiftKey?(n.format.insert.br(),n.mozBrs.tidy(e)):n.split(e),i.history.saveUndoState(!0),i.util.cancelEvent(t),!0}},n.selection={compare:function(e,t){return!e||!e.isEqualTo?!1:e.isEqualTo(t)},restore:function(e){return!e||!e.unbookmarkify?!1:(e.unbookmarkify(i.editdiv),e.select(),!0)},deleteContents:function(e){var t,n,s;return s=i.selection.savedRange.clone(),t=r().setCaretToStart(e),n=r().setCaretToEnd(e),s.compareEndPoints("StartToStart",t)===-1&&s.setStartToRangeStart(t),s.compareEndPoints("EndToEnd",n)===1&&s.setEndToRangeEnd(n),s.deleteContents(),!0},getTextBlockNode:function(e){if(e.nodeType!==1||e.getAttribute("data-ghostedit-elemtype")!=="textblock")while(e.nodeType!==1||e.getAttribute("data-ghostedit-elemtype")!=="textblock"){e=e.parentNode;if(e===null)return!1}return e},getStartTextBlockNode:function(){return n.selection.getTextBlockNode(i.selection.savedRange.getStartNode())},getEndTextBlockNode:function(){return n.selection.getTextBlockNode(i.selection.savedRange.getEndNode())},isAtStartOftextblock:function(){var e=!1,t,s,o,u,a,f,l,c;if(document.createRange){t=i.selection.savedRange,t.isCollapsed()&&t.getNative().startOffset===0&&(e=!0,c=i.selection.savedRange.getStartNode());if(!c)return e;while(c.nodeType!==1||c.getAttribute("data-ghostedit-elemtype")!=="textblock"){if(c!==c.parentNode.childNodes[0]){u=!1;if(c.parentNode.childNodes[0].nodeType===3&&c.parentNode.childNodes[0].length===0||c.parentNode.childNodes[0].nodeType===1&&c.parentNode.childNodes[0].className==="moz_dirty")for(o=1;o<c.parentNode.childNodes.length;o+=1){a=c.parentNode.childNodes[0];if(c===c.parentNode.childNodes[o]){u=!0;break}if((a.nodeType!==3||a.length!==0)&&(a.nodeType!==1||a.className!=="moz_dirty"))break}if(u!==!0){e=!1;break}}c=c.parentNode}}else document.selection&&(s=i.selection.savedRange.clone().bookmarkify(),f=n.selection.getStartTextBlockNode(),l=r().selectNodeContents(f),s.unbookmarkify(),l.getHTML()===l.setStartToRangeStart(s).getHTML()&&(e=!0),i.selection.savedRange=s.select());return e},isAtEndOftextblock:function(){var e=!1,t,s,o,u,a,f;return i.selection.savedRange.isCollapsed()?(a=n.selection.getEndTextBlockNode(),document.createRange?(o=document.createElement("div"),o.appendChild(i.selection.savedRange.getNative().cloneContents()),s=i.selection.savedRange.getNative(),s.setEnd(a,a.childNodes.length),u=document.createElement("div"),o.appendChild(s.cloneContents()),n.mozBrs.clear(o),n.mozBrs.clear(u),o.innerHTML===u.innerHTML&&(e=!0)):document.selection&&(t=i.selection.savedRange.clone().bookmarkify(),a.innerHTML+='<span id="range_marker">&#x200b;</span>',f=r().selectNode("range_marker"),document.getElementById("range_marker").parentNode.removeChild(document.getElementById("range_marker")),t.unbookmarkify(),t.compareEndPoints("EndToEnd",f)===0&&(e=!0),i.selection.savedRange=t.select()),e):!1},extendtoword:function(e,t){var i,s;e=e.clone().getNative();if(document.createRange){i=n.selection.findwordstart(e.startContainer,e.startOffset),s=n.selection.findwordend(e.endContainer,e.endOffset);if(t){if(e.startContainer===i.node&&e.startOffset===i.offset)return e;if(e.endContainer===s.node&&e.endOffset===s.offset)return e}e.setStart(i.node,i.offset),e.setEnd(s.node,s.offset)}else e.expand("word"),e.htmlText.split().reverse()[0]===" "&&e.moveEnd("character",-1);return r().setFromNative(e)},findwordstart:function(e,t){var r,s,o,u,a=/\s|[\!\?\.\,\:\;\"]/;if(!e||!e.nodeType)return!1;if(e.nodeType===3){r=e.nodeValue.substring(0,t),s=r.search(a);if(s!==-1){o=s+1;while((s=r.substring(o).search(a))!==-1)o+=s+1;return{node:e,offset:o}}}else if(e.nodeType===1&&t>0)return n.selection.findwordstart(e.childNodes[t-1],e.childNodes[t-1].length);if(e.nodeType===1&&e.getAttribute("data-ghostedit-elemtype")==="textblock")return{node:e,offset:t};u=e.previousSibling;if(!u)return n.selection.findwordstart(e.parentNode,i.dom.getNodeOffset(e));if(u.nodeType===3)return n.selection.findwordstart(u,u.nodeValue.length);if(u.nodeType===1)return n.selection.findwordstart(u,u.childNodes.length)},findwordend:function(e,t){var r,s,o,u,a=/\s|[\!\?\.\,\:\;\"]/;if(!e||!e.nodeType)return!1;if(e.nodeType===3){r=e.nodeValue.substring(t),s=r.search(a);if(s!==-1)return o=t+s,{node:e,offset:o}}else if(e.nodeType===1&&t<e.childNodes.length)return n.selection.findwordend(e.childNodes[t],0);return e.className&&e.getAttribute("data-ghostedit-elemtype")==="textblock"?{node:e,offset:t}:(u=e.nextSibling,u?n.selection.findwordend(u,0):n.selection.findwordend(e.parentNode,i.dom.getNodeOffset(e)+1))}},n.inout={handledtags:{h1:"block",h2:"block",h3:"block",h4:"block",h5:"block",h6:"block",p:"block",b:"child",i:"child",u:"child",strong:"child",em:"child",strike:"child",br:"child",a:"contents",span:"contents"},parserules:{textnode:{clean:!0},tags:{h1:"textblock",h2:"textblock",h3:"textblock",h4:"textblock",h5:"textblock",h6:"textblock",p:"textblock",b:{},i:{},u:{},strong:{},em:{},strike:{},br:{attributes:[{name:"class",allowedvalues:["moz_dirty"]}]}},templates:{textblock:{attributes:["class"],styles:[{name:"textAlign",allowedvalues:["left","right","center","justified"]},{name:"clear",allowedvalues:["left","right"]}]}}},importHTML:function(e){var t,r,s,o,u,a,f;a=n.inout.isHandleableNode(e);switch(a){case"block":return r=e.tagName.toLowerCase(),t=i.dom.parse(e,n.inout.parserules),i.blockElemId+=1,t.id="ghostedit_textblock_"+i.blockElemId,t.setAttribute("data-ghostedit-iselem","true"),t.setAttribute("data-ghostedit-elemtype","textblock"),t.setAttribute("data-ghostedit-handler","textblock"),t.ondragenter=function(){return!1},t.ondragleave=function(){return!1},t.ondragover=function(){return!1},t.ondrop=function(e){var t,n;n=e.dataTransfer.getData("Text")||e.srcElement.id,t=document.getElementById(n),t.parentNode.insertBefore(t,this),i.image.focus(t)},t.onresizestart=function(e){return i.util.cancelEvent(e)},n.mozBrs.tidy(t),t;case"child":case"contents":case"text":t=n.create("p"),t.setAttribute("data-ghostedit-importinfo","wasinline"),o=0,s=e;do f=i.dom.parse(s,n.inout.parserules),f&&(o+=1,t.appendChild(f),u=s,s=s.nextSibling,o>1&&u.parentNode.removeChild(u));while(n.inout.isHandleableNode(s)&&n.inout.isHandleableNode(s)!=="block");return n.mozBrs.tidy(t),o>0?t:!1}return!1},exportHTML:function(e){if(!e||!i.dom.isGhostBlock(e)||e.getAttribute("data-ghostedit-elemtype")!=="textblock")return!1;var t="",r="",s;return s=e,n.mozBrs.clear(s),t+="<"+s.tagName.toLowerCase(),s.style.textAlign!==""&&(r+="text-align:"+s.style.textAlign+";"),s.style.clear!==""&&(r+="clear:"+s.style.clear+";"),r.length>0&&(t+=" style='"+r+"'"),s.className.length>0&&!/ghostedit/.test(s.className)&&(t+=" class='"+s.className+"'"),t+=">",t+=s.innerHTML,t+="</"+s.tagName.toLowerCase()+">",n.mozBrs.tidy(s),{content:t}},isHandleableNode:function(e){var t;return!e||!e.nodeType?!1:e.nodeType===3?e.nodeValue.replace(/[\n\r\t]/g,"").length>0?"text":!1:e.nodeType!==1?!1:e.getAttribute("data-ghostedit-elemtype")==="textblock"?"block":i.dom.isGhostBlock(e)?!1:(t=e.tagName.toLowerCase(),n.inout.handledtags[t]?n.inout.handledtags[t]:!1)},parse:function(e){var t=!1,r,i,s,o,u;if(!e||!e.nodeType)return!1;s=n.inout.isHandleableNode(e);switch(s){case"text":return u=e.nodeValue.replace(/[\n\r\t]/g,""),u.length>0?document.createTextNode(u):!1;case"block":case"child":t=document.createElement(e.tagName.toLowerCase())}t=t||document.createDocumentFragment(),r=e.childNodes;for(o=0;o<r.length;o++)i=n.inout.parse(r[o]),i&&t.appendChild(i);return t}},n.paste={handle:function(e,t,s){var o;if(!i.dom.isGhostBlock(e)||!i.dom.isGhostBlock(t))return;return console.log(s),s.isfirst?t.tagName.toLowerCase()==="p"||t.tagName===e.tagName?(console.log("paste (first):"),n.mozBrs.clear(t),r().removeDOMmarkers("ghostedit_paste_start"),t.innerHTML+="<span id='ghostedit_paste_start_range_start' class='t1'>&#x200b;</span>",document.createRange?i.selection.saved.data.collapseToStart().getNative().insertNode(i.dom.extractContent(t)):i.selection.saved.data.collapseToStart().getNative().pasteHTML(t.innerHTML),!0):!1:s.islast?t.tagName.toLowerCase()==="p"||t.tagName===e.tagName?(console.log("paste (last-noncollapsed):"),n.mozBrs.clear(t),r().removeDOMmarkers("ghostedit_paste_end"),t.innerHTML+="<span id='ghostedit_paste_end_range_start'>&#x200b;</span>",document.createRange?i.selection.saved.data.collapseToStart().getNative().insertNode(i.dom.extractContent(t)):i.selection.saved.data.collapseToStart().getNative().pasteHTML(t.innerHTML),!0):!1:(n.mozBrs.clear(t),i.selection.saved.data.collapseToStart().select(),r().removeDOMmarkers("ghostedit_paste_start"),o=n.split(e),o.block1.innerHTML+="<span id='ghostedit_paste_start_range_start' class='t2'>&#x200b;</span>",n.mozBrs.tidy(o.block1),r().removeDOMmarkers("ghostedit_paste_end"),o.block2.innerHTML="<span id='ghostedit_paste_end_range_start'>&#x200b;</span>"+o.block2.innerHTML,n.mozBrs.tidy(o.block2),!1)},clean:function(e){var t,r,i;if(!e||!e.nodeType)return!1;if(!e.childNodes)return e;t=document.createDocumentFragment();for(i=0;i<e.childNodes.length;i++)r=n.paste.cleanChild(e.childNodes[i]),r&&t.appendChild(r);return e=e.cloneNode(!1),e.appendChild(t),e},cleanNode:function(e){var t,r,i,s,o;if(!e||!e.nodeType)return!1;s=n.paste.isHandleableNode(e);switch(s){case"text":return e.nodeValue=e.nodeValue.replace(/[\n\r\t]/g,""),e;case"child":case"contents":t=s==="child"?e.cloneNode(!1):document.createDocumentFragment(),r=e.childNodes;for(o=0;o<r.length;o++)i=n.paste.cleanNode(r[o]),i&&t.appendChild(i);return t}return!1}},n.isTextBlock=function(e){return i.dom.isGhostBlock(e)?e.getAttribute("data-ghostedit-elemtype")!=="textblock"?!1:!0:!1},n.isEmpty=function(e){var n,r,i,s;n=e.innerText||e.textContent;if(n&&n.length>1)return!1;i=e.getElementsByTagName("br"),r=e.getElementsByTagName("img");if(i.length===0&&r.length===0)return!0;for(s=0;s<i.length;s+=1)if(i[s].MozDirty===t&&!/moz_dirty/.test(i[s].className))return!1;return!0},n.isFirst=function(e){var t,n;t=i.editdiv;for(n=0;n<t.getElementsByTagName("*").length;n+=1)if(t.getElementsByTagName("*")[n].getAttribute("data-ghostedit-elemtype")==="textblock")return t.getElementsByTagName("*")[n]===e?!0:!1},n.isLast=function(e){var t,n;t=i.editdiv;for(n=t.getElementsByTagName("*").length-1;n>0;n-=1)if(t.getElementsByTagName("*")[n].getAttribute("data-ghostedit-elemtype")==="textblock")return t.getElementsByTagName("*")[n]===e?!0:!1},n.count=function(){var e,t,n;e=i.editdiv,t=0;for(n=0;n<e.getElementsByTagName("*").length;n+=1)e.getElementsByTagName("*")[n].getAttribute("data-ghostedit-elemtype")==="textblock"&&(t+=1);return t},n.create=function(e,t,r){var s;return r||(i.blockElemId+=1,r="ghostedit_textblock_"+i.blockElemId),t=t&&(t.length&&t.length>0||t.nodeType)?t:"",s=document.createElement(e),s.id=r,t.nodeType?(t=i.dom.parse(t,{textnode:{clean:!0},tags:{b:{},i:{},u:{},strong:{},em:{},strike:{},br:{}}}),t&&s.appendChild(t)):s.innerHTML=t,s.setAttribute("data-ghostedit-iselem","true"),s.setAttribute("data-ghostedit-elemtype","textblock"),s.setAttribute("data-ghostedit-handler","textblock"),s.ondragenter=function(){return!1},s.ondragleave=function(){return!1},s.ondragover=function(){return!1},s.ondrop=function(e){var t,n;n=e.dataTransfer.getData("Text")||e.srcElement.id,t=document.getElementById(n),t.parentNode.insertBefore(t,this),i.image.focus(t)},s.onresizestart=function(e){return i.util.cancelEvent(e)},n.mozBrs.tidy(s),s},n.remove=function(e){var t,s,o,u,a,f;i.selection.save(),i.history.saveUndoState(),t="",t=e.innerHTML,s=i.editdiv,f=s.getElementsByTagName("*"),a=!1;for(u=f.length-1;u>=0;u-=1){if(a===!0&&f[u].getAttribute("data-ghostedit-elemtype")==="textblock"){o=f[u];break}f[u]===e&&(a=!0)}if(n.isEmpty(o)){s.removeChild(o),r().setCaretToStart(e).select(),i.selection.save(),i.history.saveUndoState();return}s.removeChild(e),r().setCaretToEnd(o).select(),i.selection.save(),o.innerHTML+="<span id='ghostedit_marker'>&#x200b;</span>"+t,n.mozBrs.tidy(o),r().selectNode("ghostedit_marker").deleteContents().select(),document.getElementById("ghostedit_marker")&&document.getElementById("ghostedit_marker").parentNode.removeChild(document.getElementById("ghostedit_marker")),i.selection.save(),i.history.saveUndoState()},n.focus=function(e){return!e||e.nodeType!==1||e.getAttribute("data-ghostedit-elemtype")!=="textblock"?!1:(r().setCaretToEnd(e).select(),i.selection.save(),!0)},n.merge=function(e,t,s){var o,u,a,f;return s===!1?e:e===t?e:(o=e.getAttribute("data-ghostedit-elemtype"),u=t.getAttribute("data-ghostedit-elemtype"),o!=="textblock"||u!=="textblock"?!1:(e.innerHTML+="<span id='ghostedit_marker'>&#x200b;</span>"+t.innerHTML,a=t.parentNode,f=a.getAttribute("data-ghostedit-handler"),i.plugins[f].dom.removechild(a,t),n.mozBrs.tidy(e),r().selectNode("ghostedit_marker").select(),document.getElementById("ghostedit_marker").parentNode.removeChild(document.getElementById("ghostedit_marker")),e))},n.split=function(e){i.selection.save();var t,s,o,u,a,f,l,c,h,p;return s=n.selection.isAtStartOftextblock()===!0?!0:!1,o=n.selection.isAtEndOftextblock()===!0?!0:!1,t=s&&!o?"before":"after",u=t==="before"||o?"p":n.selection.getStartTextBlockNode().tagName,n.mozBrs.tidy(e),!s&&!o?document.createRange?(f=r().selectNodeContents(e).setStartToRangeStart(i.selection.savedRange),a=f.getHTML(),f.deleteContents()):document.selection&&(f=r().selectNode(e),f.setStartToRangeEnd(i.selection.savedRange),a=f.getHTML(),f.getNative().text=""):a="",c=n.create(u,a),c?(h=i.dom.getParentGhostBlock(e),p=h.getAttribute("data-ghostedit-handler"),l=i.plugins[p].dom.addchild(h,t,e,c,{contentlength:a.length}),l?(c.innerHTML="dummy",r().selectNode(c).select(),c.innerHTML=a,n.mozBrs.tidy(c),t==="before"?r().setCaretToBlockStart(e).select():r().setCaretToBlockStart(c).select(),i.selection.save(),{block1:t==="before"?c:e,block2:t==="before"?e:c}):!1):!1},n.mozBrs={checkifcontains:function(e){var n,r;n=e.getElementsByTagName("br");for(r=0;r<n.length;r+=1)if(n[r].MozDirty!==t)return!0;return!1},insert:function(e){var t;t=document.createElement("br"),t.setAttribute("_moz_dirty",""),t.className="moz_dirty",e.appendChild(t)},clear:function(e){var n,r;n=e.getElementsByTagName("br");for(r=0;r<n.length;r+=1)if(n[r].MozDirty!==t||/moz_dirty/.test(n[r].className))n[r].parentNode.removeChild(n[r]),r--},tidy:function(e){n.mozBrs.clear(e),i.useMozBr&&n.mozBrs.insert(e)}},n.insert={character:function(e){i.selection.saved.type==="textblock"&&(i.selection.restore(),i.selection.savedRange.pasteText(e))},br:function(){var t,n,r;e.getSelection?(t=e.getSelection(),t.getRangeAt(0).collapse(!1),n=document.createElement("br"),n.id="newBr",t.getRangeAt(0).insertNode(n),t.getRangeAt(0).selectNode(n.parentNode),r=document.createRange(),r.setStartAfter(n),r.setEndAfter(n),t.removeAllRanges(),t.addRange(r),document.getElementById("newBr").removeAttribute("id")):document.selection&&(r=document.selection.createRange(),r.collapse(!1),r.pasteHTML("<br id='newBr' />"),r.moveToElementText(document.getElementById("newBr")),r.collapse(!1),r.select(),document.getElementById("newBr").removeAttribute("id"))}},n.format={init:function(){i.api.format=i.api.format||{},i.api.format.setStyle=function(e,t){n.format.formatSelected(n.format.setTagType,{tagname:e,newclass:t})},i.api.format.alignText=function(e){if(!/left|right|center|justify/.test(e))return!1;n.format.formatSelected(n.format.alignText,{alignDirection:e})},i.api.format.bold=function(){n.format.formatSelected(n.format.bold)},i.api.format.italic=function(){n.format.formatSelected(n.format.italic)},i.api.format.underline=function(){n.format.formatSelected(n.format.underline)},i.api.format.strikethrough=function(){n.format.formatSelected(n.format.strikethrough)},i.api.format.textColor=function(e){n.format.formatSelected(n.format.textColor,{color:e})}},useCommand:function(e,t){document.execCommand(e,!1,t)},getNextNode:function(e){if(e.firstChild)return e.firstChild;while(e){if(e.nextSibling)return e.nextSibling;e=e.parentNode}},getNodesInRange:function(e){var t=e.getStartNode(),r=e.getEndNode(),i=e.getParentNode(),s=[],o;for(o=t.parentNode;o;o=o.parentNode){s.push(o);if(o===i)break}s.reverse();for(o=t;o;o=n.format.getNextNode(o)){s.push(o);if(o===r)break}return s},useCommandOnWord:function(e){var t,s;i.selection.savedRange.isCollapsed()&&n.selection.getStartTextBlockNode()&&(t=i.selection.savedRange.clone(),document.createRange&&(s=document.createElement("span"),s.id="ghostedit_marker",t.getNative().insertNode(s)),!document.createRange&&document.selection&&t.getNative().pasteHTML("<span id='ghostedit_marker'>z</span>"),t.selectNode("ghostedit_marker"),t=n.selection.extendtoword(t,!0),t.select()),n.format.useCommand(e),document.getElementById("ghostedit_marker")&&(r().selectNode("ghostedit_marker").select(),document.getElementById("ghostedit_marker").parentNode.removeChild(document.getElementById("ghostedit_marker"))),i.selection.save()},bold:function(){n.format.useCommand("bold")},italic:function(){n.format.useCommand("italic")},underline:function(){n.format.useCommand("underline")},strikethrough:function(){n.format.useCommand("strikethrough")},textColor:function(e){n.format.useCommand("foreColor",e)},formatSelected:function(e,t){var r,s,o,u,a,f,l;i.selection.save(),i.history.saveUndoState(),s=n.selection.getStartTextBlockNode(),o=n.selection.getEndTextBlockNode();if(s&&o){r=s,a=!1;do{if(r===i.editdiv||r===null)break;if(n.isTextBlock(r)){r===o&&(a=!0),r=n.format.formatTextBlock(r,i.selection.saved.data.clone(),e,t);if(a)break;r=r.nextSibling?r.nextSibling:r.parentNode;continue}if(i.dom.isDescendant(r,o)){r=i.dom.getFirstChildElement(r);continue}u=r,r=r.nextSibling?r.nextSibling:r.parentNode,l=u.getElementsByTagName("*");for(f=0;f<l.length;f+=1)n.isTextBlock(l[f])&&n.format.formatTextBlock(l[f],i.selection.saved.data.clone(),e,t)}while(!0);i.selection.save(),i.history.saveUndoState()}i.history.saveUndoState()},formatTextBlock:function(e,n,s,o){var u,a,f;return o||(o={}),o.textblock=e,n=n.clone(),u=r().setCaretToStart(e),a=r().setCaretToEnd(e),n.compareEndPoints("EndToStart",u)===-1||n.compareEndPoints("StartToEnd",a)===1?!1:(n.compareEndPoints("StartToStart",u)===-1&&n.setStartToRangeStart(u),n.compareEndPoints("EndToEnd",a)===1&&n.setEndToRangeEnd(a),i.selection.saved.data.clone().saveToDOM("ghostedit_format"),n.select(),f=s(o),r().restoreFromDOM("ghostedit_format").select(),i.selection.save(),f&&f.nodeType!==t?f:e)},alignText:function(e){var t=r().setToSelection().getParentElement();while(!i.dom.isGhostBlock(t)){t=t.parentNode;if(t===null)return!1}if(!n.isTextBlock(t))return!1;t.style.textAlign=e.alignDirection},setTagType:function(e){var r,s,o,u,a,f;return r=e.textblock,s=e.tagname,o=e.newclass,n.isTextBlock(r)?(a="ghostedit_textblock_"+r.id.replace("ghostedit_textblock_",""),f=n.create(s),f.appendChild(i.dom.extractContent(r)),n.mozBrs.tidy(f),f.setAttribute("style",r.getAttribute("style")),o!==t&&(f.className=o),u=r.parentNode,r.id="",u.insertBefore(f,r),u.removeChild(r),f.id=a,f):!1}},i.api.plugin.register("textblock",n)}(window),function(e,t){var n={};n.trim=function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")},n.preparefunction=function(e,t){var n=Array.prototype.slice.call(arguments,2);return function(){var r=n.concat(Array.prototype.slice.call(arguments));return e.apply(t?t:this,r)}},n.isFunction=function(e){return e?typeof e!="function"?!1:!0:!1},n.cloneObject=function(e){var t,r,i,s;if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return t=new Date,t.setTime(e.getTime()),t;if(e instanceof Array){t=[];for(i=0,r=e.length;i<r;++i)t[i]=n.cloneObject(e[i]);return t}if(e instanceof Object){t={};for(s in e)e.hasOwnProperty(s)&&(t[s]=n.cloneObject(e[s]));return t}},n.addClass=function(e,t){e.className=n.trim(e.className)+" "+t},n.removeClass=function(e,t){var r=new RegExp(t,"g");e.className=n.trim(e.className.replace(r,""))},n.cancelEvent=function(e){return e&&e.preventDefault?(e.stopPropagation(),e.preventDefault()):e&&(e.returnValue=!1),!1},n.cancelAllEvents=function(t){return t&&t.preventDefault?(t.stopPropagation(),t.preventDefault()):e.event&&(e.event.cancelBubble=!0),!1},n.preventDefault=function(e){return e&&e.preventDefault&&e.preventDefault(),!1},n.preventBubble=function(t){t&&t.stopPropagation&&t.stopPropagation(),e.event&&(e.event.cancelBubble=!0)},n.addEvent=function(e,n,r){e.addEventListener!==t?e.addEventListener(n,r,!1):e.attachEvent("on"+n,r)},n.removeEvent=function(e,n,r){e.removeEventListener!==t?e.removeEventListener(n,r,!1):e.detachEvent("on"+n,r)},n.ajax=function(t,n,r,i,s){var o,u,a;if(!t||!n)return!1;a=!1;if(e.XMLHttpRequest&&(e.location.protocol!=="file:"||!e.ActiveXObject))a=new e.XMLHttpRequest;else try{a=new e.ActiveXObject("Microsoft.XMLHTTP")}catch(f){try{a=new e.ActiveXObject("MSXML2.XMLHTTP")}catch(l){}}if(!a)return!1;n=n.toUpperCase(),o=(new Date).getTime(),t=t.replace(/(\?)+$/,""),u=t.indexOf("?")===-1?"?":"&",n==="GET"?a.open(n,t+u+o+"&"+r,!0):a.open(n,t+u+o,!0),a.onreadystatechange=function(){var e;if(a.readyState===4)return a.status===200?(e=s==="xml"?a.responseXML:a.responseText,i!==null&&i(!0,e),!0):(i!==null&&i(!1,e),!1)},a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n==="POST"&&r!==null?a.send(r):a.send()},n.detectEngines=function(){var t={ie:0,gecko:0,webkit:0,khtml:0,opera:0,ver:null},n=navigator.userAgent;return e.opera?(t.ver=e.opera.version(),t.opera=parseFloat(t.ver)):/AppleWebKit\/(\S+)/.test(n)?(t.ver=RegExp.$1,t.webkit=parseFloat(t.ver)):/KHTML\/(\S+)/.test(n)||/Konqueror\/([^;]+)/.test(n)?(t.ver=RegExp.$1,t.khtml=parseFloat(t.ver)):/rv:([^\)]+)\) Gecko\/\d{8}/.test(n)?(t.ver=RegExp.$1,t.gecko=parseFloat(t.ver)):/MSIE ([^;]+)/.test(n)&&(t.ver=RegExp.$1,t.ie=parseFloat(t.ver)),t},e.ghostedit.util=n}(window);